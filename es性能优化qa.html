<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-06-10T01:18:22.6791533"><title>ES性能优化QA | 技术知识库</title><script type="application/json" id="virtual-toc-data">[{"id":"-8j71d4_4","level":0,"title":"📋 知识结构","anchor":"#-8j71d4_4"},{"id":"-8j71d4_5","level":0,"title":"🚀 索引优化","anchor":"#-8j71d4_5"},{"id":"-8j71d4_6","level":0,"title":"🔍 查询优化","anchor":"#-8j71d4_6"},{"id":"-8j71d4_7","level":0,"title":"🖥️ 硬件调优","anchor":"#-8j71d4_7"},{"id":"-8j71d4_8","level":0,"title":"💡 面试技巧","anchor":"#-8j71d4_8"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="ES性能优化QA | 技术知识库"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="技术知识库 Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/es性能优化qa.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="ES性能优化QA | 技术知识库"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/es性能优化qa.html#webpage",
    "url": "writerside-documentation/es性能优化qa.html",
    "name": "ES性能优化QA | 技术知识库",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "技术知识库 Help"
}</script><!-- End Schema.org --></head><body data-id="ES性能优化QA" data-main-title="ES性能优化QA" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="ES面试大纲.md|Elasticsearch面试大纲"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>技术知识库  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="ES性能优化QA" id="ES性能优化QA.md">ES性能优化QA</h1><p id="-8j71d4_3">本文档深入解析Elasticsearch的性能优化策略，涵盖索引优化、查询优化、硬件调优、监控运维等性能提升的核心技能。</p><section class="chapter"><h2 id="-8j71d4_4" data-toc="-8j71d4_4">📋 知识结构</h2><svg aria-roledescription="mindmap" role="graphics-document document" viewBox="5 5 748.4818115234375 451.661376953125" style="max-width: 748.4818115234375px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><g></g><g class="mindmap-edges"><path class="edge section-edge-0 edge-depth-1" d="M 535.3842905568109,217.40779916349422 L 567.0148537578943,189.87469501691393 L598.6454169589778,162.34159087033365"></path><path class="edge section-edge-0 edge-depth-1" d="M 516.3917971375402,214.37051173881244 L 500.1792718227482,187.1630690210591 L483.96674650795626,159.95562630330576"></path><path class="edge section-edge-0 edge-depth-1" d="M 536.7711718013487,235.23656881652903 L 578.3534967963933,261.3637979613258 L619.9358217914379,287.4910271061226"></path><path class="edge section-edge-0 edge-depth-1" d="M 539.0530386866436,226.538592151848 L 604.4960165372279,223.40401929870583 L669.9389943878122,220.26944644556366"></path><path class="edge section-edge-0 edge-depth-0" d="M 374.2272010011304,232.15632536003469 L 441.6527152948763,229.95141079642607 L509.0782295886222,227.74649623281746"></path><path class="edge section-edge-1 edge-depth-1" d="M 361.69916604196317,343.3162029053202 L 326.40599746621274,369.4918475472151 L291.1128288904623,395.66749218911"></path><path class="edge section-edge-1 edge-depth-1" d="M 388.5071555818122,331.70780947061405 L 440.3595027337716,322.31812724922304 L492.211849885731,312.928445027832"></path><path class="edge section-edge-1 edge-depth-1" d="M 377.24914986101754,348.96610048999685 L 384.95746449887463,381.0709876801616 L392.6657791367317,413.1758748703263"></path><path class="edge section-edge-1 edge-depth-1" d="M 387.5792460145799,340.1836029095404 L 444.94270344068013,364.2494279575159 L502.3061608667804,388.31525300549134"></path><path class="edge section-edge-1 edge-depth-0" d="M 361.35346811614585,247.4962658465576 L 366.49121049976713,283.5136002557988 L371.6289528833884,319.5309346650399"></path><path class="edge section-edge-2 edge-depth-1" d="M 187.92124367374188,283.67461524633546 L 130.06497224970997,295.962889398211 L72.20870082567805,308.2511635500866"></path><path class="edge section-edge-2 edge-depth-1" d="M 200.24087236222385,265.7439490762115 L 195.7730008951345,237.6154859932226 L191.30512942804512,209.48702291023363"></path><path class="edge section-edge-2 edge-depth-1" d="M 195.8190093920826,293.94106831061623 L 180.59278356206664,324.0181137390131 L165.3665577320507,354.0951591674099"></path><path class="edge section-edge-2 edge-depth-1" d="M 188.61366743358465,275.12207453613223 L 132.8616463381241,253.4431850510457 L77.10962524266355,231.76429556595912"></path><path class="edge section-edge-2 edge-depth-0" d="M 344.8911969539497,237.03397056692876 L 280.9145800898852,256.6024099719894 L216.93796322582068,276.17084937705005"></path><path class="edge section-edge-3 edge-depth-1" d="M 321.47513483067786,121.24852028239644 L 285.8585842924142,92.01891385115388 L250.24203375415055,62.789307419911324"></path><path class="edge section-edge-3 edge-depth-1" d="M 346.6453918520272,124.38338384795667 L 402.21795629677547,98.26132403929532 L457.7905207415237,72.13926423063397"></path><path class="edge section-edge-3 edge-depth-1" d="M 318.12238051727724,129.5156809763438 L 262.08455439131734,124.83442822610365 L206.04672826535744,120.15317547586352"></path><path class="edge section-edge-3 edge-depth-1" d="M 336.28636945628347,116.11321504515732 L 343.70158424773035,82.33219603848127 L351.11679903917724,48.55117703180521"></path><path class="edge section-edge-3 edge-depth-0" d="M 355.5040640368507,218.11804428072418 L 346.1527645759121,181.70548883478384 L336.8014651149735,145.2929333888435"></path></g><g class="mindmap-nodes"><g transform="translate(308.54239729045787, 213.74658559260513)" class="mindmap-node section--1 section-root"><g transform="translate(50.69281768798828, 18.9)"><circle r="50.69281768798828" class="node-bkg node-circle" id="node-0"></circle></g><g transform="translate(50.69281768798828, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">ES性能优化</tspan></tspan></text></g></g></g><g transform="translate(481.0342163132108, 208.356236000247)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-1"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">索引优化</tspan></tspan></text></g></g></g><g transform="translate(330.7112067229924, 315.4806149189924)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-6"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">查询优化</tspan></tspan></text></g></g></g><g transform="translate(160.03925770132423, 261.6582343513737)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-11"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">硬件调优</tspan></tspan></text></g></g></g><g transform="translate(291.01562667337805, 111.86439207696253)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h74.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-16"></path><line y2="37.8" x2="84.109375" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.0546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">监控运维</tspan></tspan></text></g></g></g><g transform="translate(567.9048044044822, 133.59315403358084)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h74.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-2"></path><line y2="37.8" x2="84.109375" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(42.0546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">写入性能</tspan></tspan></text></g></g></g><g transform="translate(433.2523287360942, 128.16990204187118)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-3"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">分片设计</tspan></tspan></text></g></g></g><g transform="translate(590.1007786833844, 276.57135992240467)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-4"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">映射优化</tspan></tspan></text></g></g></g><g transform="translate(626.3618160898583, 200.65180259716465)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h107.12000274658203 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-5"></path><line y2="37.8" x2="117.12000274658203" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(58.560001373291016, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">生命周期管理</tspan></tspan></text></g></g></g><g transform="translate(236.51010141133736, 385.7030801754379)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-7"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">查询结构</tspan></tspan></text></g></g></g><g transform="translate(464.43580014835936, 291.35563957945374)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-8"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">缓存策略</tspan></tspan></text></g></g></g><g transform="translate(353.13172367856544, 408.8613604413308)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-9"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">分页优化</tspan></tspan></text></g></g></g><g transform="translate(473.10220156217645, 375.2182409960394)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-10"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">聚合优化</tspan></tspan></text></g></g></g><g transform="translate(15, 292.46754444504836)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-12"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">内存配置</tspan></tspan></text></g></g></g><g transform="translate(145.91605729084904, 175.7727376350714)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-13"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">磁盘优化</tspan></tspan></text></g></g></g><g transform="translate(116.05562262471335, 348.5779931266525)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-14"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">网络优化</tspan></tspan></text></g></g></g><g transform="translate(22.147753389230616, 207.42813575071762)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h71.96318817138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-15"></path><line y2="37.8" x2="81.96318817138672" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(40.98159408569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">CPU配置</tspan></tspan></text></g></g></g><g transform="translate(195.61085511335466, 34.37343562534522)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-17"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">性能指标</tspan></tspan></text></g></g></g><g transform="translate(428.3295991220772, 46.8582560016281)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-18"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">瓶颈分析</tspan></tspan></text></g></g></g><g transform="translate(148.54410710925663, 100.00446437524477)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-19"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">容量规划</tspan></tspan></text></g></g></g><g transform="translate(311.77816682208265, 15)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-20"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">调优工具</tspan></tspan></text></g></g></g></g></svg></section><section class="chapter"><h2 id="-8j71d4_5" data-toc="-8j71d4_5">🚀 索引优化</h2><section class="chapter"><h3 id="q1-es" data-toc="q1-es">Q1: 如何优化ES的写入性能？有哪些关键配置参数？</h3><p id="-8j71d4_12"><span class="control" id="-8j71d4_22">答案：</span></p><p id="-8j71d4_13"><span class="control" id="-8j71d4_23">ES写入性能优化策略：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 497.453125 740"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="497.453125" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES写入性能优化" class="cluster"><rect height="724" width="481.453125" y="8" x="8" style=""></rect><g transform="translate(192.4921875, 8)" class="cluster-label"><foreignObject height="24" width="112.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES写入性能优化</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M201.656,106L207.906,106C214.156,106,226.656,106,236.829,106C247.001,106,254.846,106,262.025,106C269.203,106,275.715,106,278.971,106L282.227,106"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M201.656,282L207.906,282C214.156,282,226.656,282,236.031,282C245.406,282,251.656,282,257.24,282C262.823,282,267.74,282,270.198,282L272.656,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M185.633,458L194.553,458C203.474,458,221.315,458,233.491,458C245.667,458,252.177,458,258.021,458C263.865,458,269.042,458,271.63,458L274.219,458"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_3" d="M185.633,634L194.553,634C203.474,634,221.315,634,235.493,634C249.672,634,260.188,634,270.036,634C279.885,634,289.068,634,293.659,634L298.25,634"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(123.578125, 106)" id="flowchart-A-7063" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>批量写入优化</p></span></div></foreignObject></g></g><g transform="translate(364.3046875, 106)" id="flowchart-A1-7064" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>bulk API使用<br>合理批次大小<br>并发控制<br>错误处理</p></span></div></foreignObject></g></g><g transform="translate(123.578125, 282)" id="flowchart-B-7065" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>索引配置优化</p></span></div></foreignObject></g></g><g transform="translate(364.3046875, 282)" id="flowchart-B1-7066" class="node default"><rect height="126" width="175.296875" y="-63" x="-87.6484375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-57.6484375, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="115.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>refresh间隔调整<br>副本数量控制<br>合并策略优化<br>translog配置</p></span></div></foreignObject></g></g><g transform="translate(123.578125, 458)" id="flowchart-C-7067" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>映射优化</p></span></div></foreignObject></g></g><g transform="translate(364.3046875, 458)" id="flowchart-C1-7068" class="node default"><rect height="126" width="172.171875" y="-63" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>禁用不必要字段<br>优化字段类型<br>关闭动态映射<br>合理设置分析器</p></span></div></foreignObject></g></g><g transform="translate(123.578125, 634)" id="flowchart-D-7069" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>硬件优化</p></span></div></foreignObject></g></g><g transform="translate(364.3046875, 634)" id="flowchart-D1-7070" class="node default"><rect height="126" width="124.109375" y="-63" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>SSD磁盘<br>足够内存<br>多核CPU<br>网络带宽</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-8j71d4_15"><span class="control" id="-8j71d4_24">批量写入优化：</span></p><div class="code-block" data-lang="json">
// 优化的bulk请求
POST /_bulk
{ &quot;index&quot;: { &quot;_index&quot;: &quot;logs&quot;, &quot;_id&quot;: &quot;1&quot; } }
{ &quot;timestamp&quot;: &quot;2023-12-01T10:00:00Z&quot;, &quot;level&quot;: &quot;INFO&quot;, &quot;message&quot;: &quot;Application started&quot; }
{ &quot;index&quot;: { &quot;_index&quot;: &quot;logs&quot;, &quot;_id&quot;: &quot;2&quot; } }
{ &quot;timestamp&quot;: &quot;2023-12-01T10:01:00Z&quot;, &quot;level&quot;: &quot;ERROR&quot;, &quot;message&quot;: &quot;Database connection failed&quot; }

// 批量大小优化建议
{
  &quot;bulk_size&quot;: {
    &quot;documents&quot;: &quot;1000-5000 docs&quot;,
    &quot;size&quot;: &quot;5-15MB&quot;,
    &quot;reasoning&quot;: &quot;平衡内存使用和网络开销&quot;
  },
  &quot;concurrent_requests&quot;: {
    &quot;number&quot;: &quot;CPU核心数&quot;,
    &quot;max&quot;: &quot;2 * CPU核心数&quot;
  }
}
</div><p id="-8j71d4_17"><span class="control" id="-8j71d4_25">索引写入配置优化：</span></p><div class="code-block" data-lang="yaml">
# elasticsearch.yml - 写入性能配置
# 线程池配置
thread_pool:
  write:
    size: 8                    # 写入线程数
    queue_size: 1000          # 队列大小
  
# 索引设置优化
indices:
  memory:
    index_buffer_size: 30%    # 索引缓冲区大小
    min_index_buffer_size: 96mb
    max_index_buffer_size: 512mb
</div><div class="code-block" data-lang="json">
// 索引级别写入优化
PUT /high_write_index
{
  &quot;settings&quot;: {
    // 刷新策略优化
    &quot;refresh_interval&quot;: &quot;30s&quot;,        // 降低刷新频率
    &quot;number_of_replicas&quot;: 0,          // 写入时先设置为0
    
    // 合并策略优化
    &quot;merge.policy.max_merge_at_once&quot;: 30,
    &quot;merge.policy.segments_per_tier&quot;: 30,
    &quot;merge.scheduler.max_thread_count&quot;: 1,
    
    // Translog优化
    &quot;translog.durability&quot;: &quot;async&quot;,   // 异步持久化
    &quot;translog.sync_interval&quot;: &quot;5s&quot;,   // 同步间隔
    &quot;translog.flush_threshold_size&quot;: &quot;1gb&quot;,
    
    // 索引缓冲区
    &quot;indices.memory.index_buffer_size&quot;: &quot;30%&quot;
  }
}

// 写入完成后调整配置
PUT /high_write_index/_settings
{
  &quot;refresh_interval&quot;: &quot;1s&quot;,
  &quot;number_of_replicas&quot;: 1
}
</div><p id="-8j71d4_20"><span class="control" id="-8j71d4_26">写入模式优化：</span></p><div class="code-block" data-lang="java">
// Java客户端写入优化示例
public class ElasticsearchBulkWriter {
    private final ElasticsearchClient client;
    private final BulkProcessor bulkProcessor;
    
    public ElasticsearchBulkWriter() {
        this.bulkProcessor = BulkProcessor.builder(
            (request, bulkListener) -&gt; 
                client.bulk(request, RequestOptions.DEFAULT, bulkListener)
        )
        .setBulkActions(1000)                    // 批次大小
        .setBulkSize(new ByteSizeValue(15, ByteSizeUnit.MB))  // 批次字节大小
        .setFlushInterval(TimeValue.timeValueSeconds(5))      // 刷新间隔
        .setConcurrentRequests(0)                // 同步执行
        .setBackoffPolicy(BackoffPolicy.exponentialBackoff(
            TimeValue.timeValueMillis(100), 3)) // 重试策略
        .build();
    }
    
    public void addDocument(String index, String id, Object document) {
        IndexRequest request = new IndexRequest(index)
            .id(id)
            .source(convertToJson(document), XContentType.JSON);
        bulkProcessor.add(request);
    }
}
</div></section><section class="chapter"><h3 id="q2-es" data-toc="q2-es">Q2: 如何优化ES索引的存储和分片策略？</h3><p id="-8j71d4_27"><span class="control" id="-8j71d4_36">答案：</span></p><p id="-8j71d4_28"><span class="control" id="-8j71d4_37">分片设计策略：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1549.328125 531.125" height="531.125" class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1549.328125" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="分片设计决策树" class="cluster"><rect height="515.125" width="1533.328125" y="8" x="8" style=""></rect><g transform="translate(718.578125, 8)" class="cluster-label"><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片设计决策树</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M274.906,99.5L274.906,105.75C274.906,112,274.906,124.5,274.948,133.917C274.99,143.333,275.073,149.667,275.147,155.333C275.222,161,275.288,166,275.321,168.5L275.354,171"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_C_1" d="M236.872,270.591L214.268,287.18C191.665,303.769,146.457,336.947,123.854,358.661C101.25,380.375,101.25,390.625,101.25,400.208C101.25,409.792,101.25,418.708,101.25,423.167L101.25,427.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_D_2" d="M275.406,309.125L275.323,319.292C275.24,329.458,275.073,349.792,274.99,365.083C274.906,380.375,274.906,390.625,274.906,400.208C274.906,409.792,274.906,418.708,274.906,423.167L274.906,427.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_E_3" d="M316.347,268.185L343.022,285.175C369.697,302.165,423.048,336.145,449.723,358.26C476.398,380.375,476.398,390.625,476.398,400.208C476.398,409.792,476.398,418.708,476.398,423.167L476.398,427.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_F_G_4" d="M817.668,99.5L817.668,105.75C817.668,112,817.668,124.5,817.668,137.214C817.668,149.927,817.668,162.854,817.668,175.115C817.668,187.375,817.668,198.969,817.668,204.766L817.668,210.563"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_G_H_5" d="M792.656,268.563L776.975,285.49C761.294,302.417,729.932,336.271,714.251,358.323C698.57,380.375,698.57,390.625,698.57,400.208C698.57,409.792,698.57,418.708,698.57,423.167L698.57,427.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_G_I_6" d="M839.315,268.563L852.886,285.49C866.457,302.417,893.6,336.271,907.171,358.323C920.742,380.375,920.742,390.625,920.742,400.208C920.742,409.792,920.742,418.708,920.742,423.167L920.742,427.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_J_K_7" d="M1281.578,99.5L1281.578,105.75C1281.578,112,1281.578,124.5,1281.62,134.584C1281.661,144.668,1281.745,152.336,1281.821,159.337C1281.897,166.339,1281.966,172.673,1282,175.841L1282.035,179.008"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_K_L_8" d="M1248.754,267.793L1226.475,284.849C1204.196,301.904,1159.637,336.014,1137.357,358.195C1115.078,380.375,1115.078,390.625,1115.078,400.208C1115.078,409.792,1115.078,418.708,1115.078,423.167L1115.078,427.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_K_M_9" d="M1282.078,301.117L1281.995,312.618C1281.911,324.12,1281.745,347.122,1281.661,363.749C1281.578,380.375,1281.578,390.625,1281.578,400.208C1281.578,409.792,1281.578,418.708,1281.578,423.167L1281.578,427.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_K_N_10" d="M1315.402,267.793L1337.515,284.849C1359.627,301.904,1403.853,336.014,1425.965,358.195C1448.078,380.375,1448.078,390.625,1448.078,400.208C1448.078,409.792,1448.078,418.708,1448.078,423.167L1448.078,427.625"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g transform="translate(101.25, 370.125)" class="edgeLabel"><g transform="translate(-20.8046875, -12)" class="label"><foreignObject height="24" width="41.609375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>&lt; 1GB</p></span></div></foreignObject></g></g><g transform="translate(274.90625, 370.125)" class="edgeLabel"><g transform="translate(-35.5, -12)" class="label"><foreignObject height="24" width="71"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>1GB-50GB</p></span></div></foreignObject></g></g><g transform="translate(476.3984375, 370.125)" class="edgeLabel"><g transform="translate(-100, -24)" class="label"><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">Unsupported markdown: blockquote</span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g transform="translate(1115.078125, 370.125)" class="edgeLabel"><g transform="translate(-24.0390625, -12)" class="label"><foreignObject height="24" width="48.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>高可用</p></span></div></foreignObject></g></g><g transform="translate(1281.578125, 370.125)" class="edgeLabel"><g transform="translate(-16.03125, -12)" class="label"><foreignObject height="24" width="32.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>均衡</p></span></div></foreignObject></g></g><g transform="translate(1448.078125, 370.125)" class="edgeLabel"><g transform="translate(-24.0390625, -12)" class="label"><foreignObject height="24" width="48.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>高性能</p></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(274.90625, 72.5)" id="flowchart-A-7295" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>确定数据规模</p></span></div></foreignObject></g></g><g transform="translate(274.90625, 241.5625)" id="flowchart-B-7296" class="node default"><polygon transform="translate(-67.0625,67.0625)" class="label-container" points="67.0625,0 134.125,-67.0625 67.0625,-134.125 0,-67.0625"></polygon><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>预期数据量</p></span></div></foreignObject></g></g><g transform="translate(101.25, 458.625)" id="flowchart-C-7298" class="node default"><rect height="54" width="116.5" y="-27" x="-58.25" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-28.25, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="56.5"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>1个分片</p></span></div></foreignObject></g></g><g transform="translate(274.90625, 458.625)" id="flowchart-D-7300" class="node default"><rect height="54" width="130.8125" y="-27" x="-65.40625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-35.40625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="70.8125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>2-5个分片</p></span></div></foreignObject></g></g><g transform="translate(476.3984375, 458.625)" id="flowchart-E-7302" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>根据节点数设计</p></span></div></foreignObject></g></g><g transform="translate(817.66796875, 72.5)" id="flowchart-F-7303" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片大小原则</p></span></div></foreignObject></g></g><g transform="translate(817.66796875, 241.5625)" id="flowchart-G-7304" class="node default"><rect height="54" width="151.53125" y="-27" x="-75.765625" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-45.765625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="91.53125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>20-40GB最佳</p></span></div></foreignObject></g></g><g transform="translate(698.5703125, 458.625)" id="flowchart-H-7306" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>避免过多小分片</p></span></div></foreignObject></g></g><g transform="translate(920.7421875, 458.625)" id="flowchart-I-7308" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>避免过少大分片</p></span></div></foreignObject></g></g><g transform="translate(1281.578125, 72.5)" id="flowchart-J-7309" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>副本策略</p></span></div></foreignObject></g></g><g transform="translate(1281.578125, 241.5625)" id="flowchart-K-7310" class="node default"><polygon transform="translate(-59.0546875,59.0546875)" class="label-container" points="59.0546875,0 118.109375,-59.0546875 59.0546875,-118.109375 0,-59.0546875"></polygon><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>业务需求</p></span></div></foreignObject></g></g><g transform="translate(1115.078125, 458.625)" id="flowchart-L-7312" class="node default"><rect height="54" width="116.5" y="-27" x="-58.25" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-28.25, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="56.5"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>2个副本</p></span></div></foreignObject></g></g><g transform="translate(1281.578125, 458.625)" id="flowchart-M-7314" class="node default"><rect height="54" width="116.5" y="-27" x="-58.25" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-28.25, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="56.5"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>1个副本</p></span></div></foreignObject></g></g><g transform="translate(1448.078125, 458.625)" id="flowchart-N-7316" class="node default"><rect height="54" width="116.5" y="-27" x="-58.25" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-28.25, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="56.5"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>0个副本</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-8j71d4_30"><span class="control" id="-8j71d4_38">分片计算公式：</span></p><div class="code-block" data-lang="bash">
# 分片数量计算
分片数 = 预期数据量 / 目标分片大小
目标分片大小 = 20-40GB

# 示例计算
数据量: 500GB
目标分片大小: 30GB
建议分片数: 500GB / 30GB ≈ 17个分片

# 节点数考虑
分片数应该是节点数的倍数，便于均匀分布
如果有6个数据节点，可以设置18个分片（每个节点3个分片）
</div><p id="-8j71d4_32"><span class="control" id="-8j71d4_39">索引模板优化：</span></p><div class="code-block" data-lang="json">
// 时间序列数据索引模板
PUT _index_template/logs_template
{
  &quot;index_patterns&quot;: [&quot;logs-*&quot;],
  &quot;priority&quot;: 100,
  &quot;template&quot;: {
    &quot;settings&quot;: {
      &quot;number_of_shards&quot;: 3,
      &quot;number_of_replicas&quot;: 1,
      
      // 生命周期管理
      &quot;index.lifecycle.name&quot;: &quot;logs_policy&quot;,
      &quot;index.lifecycle.rollover_alias&quot;: &quot;logs-current&quot;,
      
      // 存储优化
      &quot;codec&quot;: &quot;best_compression&quot;,      // 最佳压缩
      &quot;index.store.type&quot;: &quot;hybridfs&quot;,   // 混合文件系统
      
      // 索引排序（提高压缩率）
      &quot;index.sort.field&quot;: [&quot;timestamp&quot;, &quot;_id&quot;],
      &quot;index.sort.order&quot;: [&quot;desc&quot;, &quot;asc&quot;]
    },
    &quot;mappings&quot;: {
      &quot;properties&quot;: {
        &quot;timestamp&quot;: {
          &quot;type&quot;: &quot;date&quot;,
          &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||epoch_millis&quot;
        },
        &quot;level&quot;: {&quot;type&quot;: &quot;keyword&quot;},
        &quot;message&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;index&quot;: false,           // 不需要搜索的字段
          &quot;doc_values&quot;: false
        }
      }
    }
  }
}
</div><p id="-8j71d4_34"><span class="control" id="-8j71d4_40">索引生命周期管理（ILM）：</span></p><div class="code-block" data-lang="json">
// 完整的ILM策略
PUT /_ilm/policy/logs_policy
{
  &quot;policy&quot;: {
    &quot;phases&quot;: {
      &quot;hot&quot;: {
        &quot;actions&quot;: {
          &quot;rollover&quot;: {
            &quot;max_size&quot;: &quot;50gb&quot;,
            &quot;max_age&quot;: &quot;1d&quot;,
            &quot;max_docs&quot;: 50000000
          },
          &quot;set_priority&quot;: {
            &quot;priority&quot;: 100
          }
        }
      },
      &quot;warm&quot;: {
        &quot;min_age&quot;: &quot;1d&quot;,
        &quot;actions&quot;: {
          &quot;set_priority&quot;: {
            &quot;priority&quot;: 50
          },
          &quot;allocate&quot;: {
            &quot;number_of_replicas&quot;: 0,
            &quot;include&quot;: {
              &quot;box_type&quot;: &quot;warm&quot;
            }
          },
          &quot;forcemerge&quot;: {
            &quot;max_num_segments&quot;: 1
          }
        }
      },
      &quot;cold&quot;: {
        &quot;min_age&quot;: &quot;7d&quot;,
        &quot;actions&quot;: {
          &quot;set_priority&quot;: {
            &quot;priority&quot;: 0
          },
          &quot;allocate&quot;: {
            &quot;number_of_replicas&quot;: 0,
            &quot;include&quot;: {
              &quot;box_type&quot;: &quot;cold&quot;
            }
          }
        }
      },
      &quot;delete&quot;: {
        &quot;min_age&quot;: &quot;30d&quot;
      }
    }
  }
}
</div></section></section><section class="chapter"><h2 id="-8j71d4_6" data-toc="-8j71d4_6">🔍 查询优化</h2><section class="chapter"><h3 id="q3-es" data-toc="q3-es">Q3: 如何优化ES的查询性能？常见的查询优化技巧有哪些？</h3><p id="-8j71d4_43"><span class="control" id="-8j71d4_52">答案：</span></p><p id="-8j71d4_44"><span class="control" id="-8j71d4_53">查询性能优化策略：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 523.5 740"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="523.5" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES查询性能优化" class="cluster"><rect height="724" width="507.5" y="8" x="8" style=""></rect><g transform="translate(205.515625, 8)" class="cluster-label"><foreignObject height="24" width="112.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES查询性能优化</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M201.656,106L207.906,106C214.156,106,226.656,106,236.031,106C245.406,106,251.656,106,257.24,106C262.823,106,267.74,106,270.198,106L272.656,106"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M185.633,282L194.553,282C203.474,282,221.315,282,235.243,282C249.172,282,259.188,282,268.536,282C277.885,282,286.568,282,290.909,282L295.25,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M185.633,458L194.553,458C203.474,458,221.315,458,234.132,458C246.948,458,254.74,458,261.865,458C268.99,458,275.448,458,278.677,458L281.906,458"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_3" d="M185.633,634L194.553,634C203.474,634,221.315,634,234.059,634C246.803,634,254.451,634,261.431,634C268.411,634,274.725,634,277.882,634L281.039,634"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(123.578125, 106)" id="flowchart-A-7560" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>查询结构优化</p></span></div></foreignObject></g></g><g transform="translate(377.328125, 106)" id="flowchart-A1-7561" class="node default"><rect height="126" width="201.34375" y="-63" x="-100.671875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-70.671875, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="141.34375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>使用filter代替query<br>合理使用bool查询<br>避免脚本查询<br>优化正则表达式</p></span></div></foreignObject></g></g><g transform="translate(123.578125, 282)" id="flowchart-B-7562" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>缓存策略</p></span></div></foreignObject></g></g><g transform="translate(377.328125, 282)" id="flowchart-B1-7563" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>查询缓存<br>请求缓存<br>字段数据缓存<br>分片请求缓存</p></span></div></foreignObject></g></g><g transform="translate(123.578125, 458)" id="flowchart-C-7564" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分页优化</p></span></div></foreignObject></g></g><g transform="translate(377.328125, 458)" id="flowchart-C1-7565" class="node default"><rect height="126" width="182.84375" y="-63" x="-91.421875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-61.421875, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="122.84375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>避免深度分页<br>使用scroll<br>使用search_after<br>合理设置size</p></span></div></foreignObject></g></g><g transform="translate(123.578125, 634)" id="flowchart-D-7566" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>聚合优化</p></span></div></foreignObject></g></g><g transform="translate(377.328125, 634)" id="flowchart-D1-7567" class="node default"><rect height="126" width="184.578125" y="-63" x="-92.2890625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-62.2890625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="124.578125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>先过滤后聚合<br>使用keyword字段<br>减少聚合层次<br>合理设置size</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-8j71d4_46"><span class="control" id="-8j71d4_54">查询结构优化：</span></p><div class="code-block" data-lang="json">
// 优化前：低效查询
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;must&quot;: [
        {
          &quot;script&quot;: {
            &quot;source&quot;: &quot;doc['price'].value &gt; params.min_price&quot;,
            &quot;params&quot;: { &quot;min_price&quot;: 100 }
          }
        },
        {
          &quot;wildcard&quot;: { &quot;title&quot;: &quot;*elasticsearch*&quot; }
        }
      ]
    }
  }
}

// 优化后：高效查询
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;filter&quot;: [                    // 使用filter获得缓存优势
        { &quot;range&quot;: { &quot;price&quot;: { &quot;gt&quot;: 100 } } },
        { &quot;term&quot;: { &quot;status&quot;: &quot;active&quot; } }
      ],
      &quot;must&quot;: [
        { &quot;match&quot;: { &quot;title&quot;: &quot;elasticsearch&quot; } }  // 避免通配符查询
      ]
    }
  },
  &quot;_source&quot;: [&quot;title&quot;, &quot;price&quot;, &quot;status&quot;],        // 只返回需要的字段
  &quot;size&quot;: 20,                                     // 合理的分页大小
  &quot;sort&quot;: [
    { &quot;price&quot;: { &quot;order&quot;: &quot;desc&quot; } }
  ]
}
</div><p id="-8j71d4_48"><span class="control" id="-8j71d4_55">缓存策略配置：</span></p><div class="code-block" data-lang="yaml">
# elasticsearch.yml - 缓存配置
indices:
  # 查询缓存
  queries:
    cache:
      size: 20%                    # 查询缓存大小
  
  # 请求缓存
  requests:
    cache:
      size: 2%                     # 请求缓存大小
      expire: 60m                  # 缓存过期时间
  
  # 字段数据缓存
  fielddata:
    cache:
      size: 40%                    # 字段数据缓存大小

# 节点级缓存设置
indices.fielddata.cache.size: 40%
indices.queries.cache.size: 20%
indices.requests.cache.size: 2%
</div><p id="-8j71d4_50"><span class="control" id="-8j71d4_56">分页优化实践：</span></p><div class="code-block" data-lang="json">
// 1. 传统分页（避免深度分页）
{
  &quot;from&quot;: 0,
  &quot;size&quot;: 20,
  &quot;query&quot;: { &quot;match_all&quot;: {} }
}
// 问题：from + size &gt; 10000 会很慢

// 2. Scroll滚动查询（大量数据遍历）
POST /my_index/_search?scroll=1m
{
  &quot;size&quot;: 1000,
  &quot;query&quot;: { &quot;match_all&quot;: {} }
}
// 后续请求
POST /_search/scroll
{
  &quot;scroll&quot;: &quot;1m&quot;,
  &quot;scroll_id&quot;: &quot;scroll_id_here&quot;
}

// 3. Search After（实时分页）
{
  &quot;size&quot;: 10,
  &quot;query&quot;: { &quot;match_all&quot;: {} },
  &quot;sort&quot;: [
    { &quot;timestamp&quot;: { &quot;order&quot;: &quot;desc&quot; } },
    { &quot;_id&quot;: { &quot;order&quot;: &quot;desc&quot; } }
  ]
}
// 下一页
{
  &quot;size&quot;: 10,
  &quot;query&quot;: { &quot;match_all&quot;: {} },
  &quot;sort&quot;: [
    { &quot;timestamp&quot;: { &quot;order&quot;: &quot;desc&quot; } },
    { &quot;_id&quot;: { &quot;order&quot;: &quot;desc&quot; } }
  ],
  &quot;search_after&quot;: [&quot;2023-12-01T10:00:00&quot;, &quot;doc_123&quot;]
}

// 4. Composite聚合（聚合分页）
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;my_buckets&quot;: {
      &quot;composite&quot;: {
        &quot;size&quot;: 100,
        &quot;sources&quot;: [
          { &quot;category&quot;: { &quot;terms&quot;: { &quot;field&quot;: &quot;category.keyword&quot; } } },
          { &quot;date&quot;: { &quot;date_histogram&quot;: { &quot;field&quot;: &quot;date&quot;, &quot;calendar_interval&quot;: &quot;day&quot; } } }
        ]
      }
    }
  }
}
</div></section><section class="chapter"><h3 id="q4-es" data-toc="q4-es">Q4: ES的聚合查询如何优化？大数据量聚合有什么注意事项？</h3><p id="-8j71d4_57"><span class="control" id="-8j71d4_66">答案：</span></p><p id="-8j71d4_58"><span class="control" id="-8j71d4_67">聚合性能优化策略：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1010.71875 346"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1010.71875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="聚合性能优化" class="cluster"><rect height="330" width="994.71875" y="8" x="8" style=""></rect><g transform="translate(457.28125, 8)" class="cluster-label"><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>聚合性能优化</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M145.109,99.5L145.109,105.75C145.109,112,145.109,124.5,145.109,133.875C145.109,143.25,145.109,149.5,145.109,155.083C145.109,160.667,145.109,165.583,145.109,168.042L145.109,170.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M391.32,99.5L391.32,105.75C391.32,112,391.32,124.5,391.32,133.875C391.32,143.25,391.32,149.5,391.32,155.083C391.32,160.667,391.32,165.583,391.32,168.042L391.32,170.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M634.281,99.5L634.281,105.75C634.281,112,634.281,124.5,634.281,133.875C634.281,143.25,634.281,149.5,634.281,155.083C634.281,160.667,634.281,165.583,634.281,168.042L634.281,170.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_3" d="M875.43,99.5L875.43,105.75C875.43,112,875.43,124.5,875.43,133.875C875.43,143.25,875.43,149.5,875.43,155.083C875.43,160.667,875.43,165.583,875.43,168.042L875.43,170.5"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(145.109375, 72.5)" id="flowchart-A-7781" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>数据预处理</p></span></div></foreignObject></g></g><g transform="translate(145.109375, 237.5)" id="flowchart-A1-7782" class="node default"><rect height="126" width="204.21875" y="-63" x="-102.109375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-72.109375, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="144.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>先过滤后聚合<br>使用合适的字段类型<br>避免脚本聚合<br>合理设置size</p></span></div></foreignObject></g></g><g transform="translate(391.3203125, 72.5)" id="flowchart-B-7783" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>聚合结构优化</p></span></div></foreignObject></g></g><g transform="translate(391.3203125, 237.5)" id="flowchart-B1-7784" class="node default"><rect height="126" width="188.203125" y="-63" x="-94.1015625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-64.1015625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>减少聚合层次<br>合理使用嵌套聚合<br>选择高效聚合类型<br>避免高基数聚合</p></span></div></foreignObject></g></g><g transform="translate(634.28125, 72.5)" id="flowchart-C-7785" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>内存管理</p></span></div></foreignObject></g></g><g transform="translate(634.28125, 237.5)" id="flowchart-C1-7786" class="node default"><rect height="126" width="197.71875" y="-63" x="-98.859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-68.859375, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="137.71875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>设置断路器<br>监控内存使用<br>使用composite聚合<br>分批处理</p></span></div></foreignObject></g></g><g transform="translate(875.4296875, 72.5)" id="flowchart-D-7787" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>索引优化</p></span></div></foreignObject></g></g><g transform="translate(875.4296875, 237.5)" id="flowchart-D1-7788" class="node default"><rect height="126" width="184.578125" y="-63" x="-92.2890625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-62.2890625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="124.578125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>使用keyword字段<br>启用doc_values<br>合理分片<br>预计算结果</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-8j71d4_60"><span class="control" id="-8j71d4_68">聚合优化实例：</span></p><div class="code-block" data-lang="json">
// 优化前：低效聚合
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;categories&quot;: {
      &quot;terms&quot;: {
        &quot;script&quot;: {
          &quot;source&quot;: &quot;doc['category'].value + '-' + doc['brand'].value&quot;
        },
        &quot;size&quot;: 10000
      },
      &quot;aggs&quot;: {
        &quot;daily_sales&quot;: {
          &quot;date_histogram&quot;: {
            &quot;field&quot;: &quot;date&quot;,
            &quot;calendar_interval&quot;: &quot;day&quot;
          },
          &quot;aggs&quot;: {
            &quot;revenue&quot;: {
              &quot;sum&quot;: { &quot;field&quot;: &quot;amount&quot; }
            }
          }
        }
      }
    }
  }
}

// 优化后：高效聚合
{
  &quot;size&quot;: 0,
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;filter&quot;: [                          // 先过滤减少数据量
        { &quot;range&quot;: { &quot;date&quot;: { &quot;gte&quot;: &quot;2023-01-01&quot; } } },
        { &quot;term&quot;: { &quot;status&quot;: &quot;completed&quot; } }
      ]
    }
  },
  &quot;aggs&quot;: {
    &quot;categories&quot;: {
      &quot;terms&quot;: {
        &quot;field&quot;: &quot;category.keyword&quot;,       // 使用keyword字段
        &quot;size&quot;: 100,                       // 合理的size
        &quot;execution_hint&quot;: &quot;map&quot;            // 指定执行方式
      },
      &quot;aggs&quot;: {
        &quot;brands&quot;: {
          &quot;terms&quot;: {
            &quot;field&quot;: &quot;brand.keyword&quot;,
            &quot;size&quot;: 10
          },
          &quot;aggs&quot;: {
            &quot;total_revenue&quot;: {
              &quot;sum&quot;: { &quot;field&quot;: &quot;amount&quot; }
            }
          }
        }
      }
    }
  }
}
</div><p id="-8j71d4_62"><span class="control" id="-8j71d4_69">大数据量聚合优化：</span></p><div class="code-block" data-lang="json">
// 1. Composite聚合（避免内存限制）
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;sales_composite&quot;: {
      &quot;composite&quot;: {
        &quot;size&quot;: 1000,
        &quot;sources&quot;: [
          { &quot;category&quot;: { &quot;terms&quot;: { &quot;field&quot;: &quot;category.keyword&quot; } } },
          { &quot;brand&quot;: { &quot;terms&quot;: { &quot;field&quot;: &quot;brand.keyword&quot; } } },
          { &quot;date&quot;: { &quot;date_histogram&quot;: { 
            &quot;field&quot;: &quot;date&quot;, 
            &quot;calendar_interval&quot;: &quot;month&quot; 
          }}}
        ]
      },
      &quot;aggs&quot;: {
        &quot;revenue&quot;: { &quot;sum&quot;: { &quot;field&quot;: &quot;amount&quot; } },
        &quot;count&quot;: { &quot;value_count&quot;: { &quot;field&quot;: &quot;_id&quot; } }
      }
    }
  }
}

// 2. 分层聚合优化
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;date_buckets&quot;: {
      &quot;date_histogram&quot;: {
        &quot;field&quot;: &quot;date&quot;,
        &quot;calendar_interval&quot;: &quot;month&quot;,
        &quot;min_doc_count&quot;: 1
      },
      &quot;aggs&quot;: {
        &quot;category_stats&quot;: {
          &quot;terms&quot;: {
            &quot;field&quot;: &quot;category.keyword&quot;,
            &quot;size&quot;: 50,
            &quot;min_doc_count&quot;: 10            // 过滤小桶
          },
          &quot;aggs&quot;: {
            &quot;revenue&quot;: { &quot;sum&quot;: { &quot;field&quot;: &quot;amount&quot; } },
            &quot;avg_order&quot;: { &quot;avg&quot;: { &quot;field&quot;: &quot;amount&quot; } }
          }
        }
      }
    }
  }
}

// 3. 采样聚合（大数据近似计算）
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;sample&quot;: {
      &quot;sampler&quot;: {
        &quot;shard_size&quot;: 10000              // 每个分片采样数量
      },
      &quot;aggs&quot;: {
        &quot;categories&quot;: {
          &quot;terms&quot;: {
            &quot;field&quot;: &quot;category.keyword&quot;,
            &quot;size&quot;: 100
          }
        }
      }
    }
  }
}
</div><p id="-8j71d4_64"><span class="control" id="-8j71d4_70">断路器配置：</span></p><div class="code-block" data-lang="yaml">
# elasticsearch.yml - 断路器配置
indices.breaker.total.limit: 70%           # 总内存限制
indices.breaker.fielddata.limit: 40%       # 字段数据断路器
indices.breaker.request.limit: 40%         # 请求断路器  
indices.breaker.accounting.limit: 100%     # 请求断路器

# 动态调整断路器
PUT /_cluster/settings
{
  &quot;transient&quot;: {
    &quot;indices.breaker.fielddata.limit&quot;: &quot;30%&quot;,
    &quot;indices.breaker.request.limit&quot;: &quot;30%&quot;
  }
}
</div></section></section><section class="chapter"><h2 id="-8j71d4_7" data-toc="-8j71d4_7">🖥️ 硬件调优</h2><section class="chapter"><h3 id="q5-es-jvm" data-toc="q5-es-jvm">Q5: ES集群的硬件配置有什么建议？如何进行JVM调优？</h3><p id="-8j71d4_73"><span class="control" id="-8j71d4_82">答案：</span></p><p id="-8j71d4_74"><span class="control" id="-8j71d4_83">ES硬件配置建议：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 492.046875 740"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="492.046875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES硬件配置指南" class="cluster"><rect height="724" width="476.046875" y="8" x="8" style=""></rect><g transform="translate(189.7890625, 8)" class="cluster-label"><foreignObject height="24" width="112.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES硬件配置指南</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M169.609,106L175.859,106C182.109,106,194.609,106,203.984,106C213.359,106,219.609,106,225.193,106C230.776,106,235.693,106,238.151,106L240.609,106"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M169.609,282L175.859,282C182.109,282,194.609,282,205.892,282C217.174,282,227.24,282,236.638,282C246.036,282,254.768,282,259.134,282L263.5,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M168.055,458L174.564,458C181.073,458,194.091,458,204.965,458C215.84,458,224.57,458,232.634,458C240.698,458,248.095,458,251.794,458L255.492,458"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_3" d="M169.609,634L175.859,634C182.109,634,194.609,634,205.892,634C217.174,634,227.24,634,236.638,634C246.036,634,254.768,634,259.134,634L263.5,634"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(107.5546875, 106)" id="flowchart-A-7945" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>内存配置</p></span></div></foreignObject></g></g><g transform="translate(345.578125, 106)" id="flowchart-A1-7946" class="node default"><rect height="126" width="201.9375" y="-63" x="-100.96875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-70.96875, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="141.9375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>堆内存: 30.5GB以下<br>系统内存: 64GB+<br>避免swap<br>预留OS缓存</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 282)" id="flowchart-B-7947" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>存储配置</p></span></div></foreignObject></g></g><g transform="translate(345.578125, 282)" id="flowchart-B1-7948" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>SSD优于HDD<br>RAID 0条带化<br>独立数据目录<br>快速日志存储</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 458)" id="flowchart-C-7949" class="node default"><rect height="54" width="121" y="-27" x="-60.5" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-30.5, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="61"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>CPU配置</p></span></div></foreignObject></g></g><g transform="translate(345.578125, 458)" id="flowchart-C1-7950" class="node default"><rect height="126" width="172.171875" y="-63" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>多核CPU<br>现代架构<br>充足核心数<br>避免超线程争用</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 634)" id="flowchart-D-7951" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>网络配置</p></span></div></foreignObject></g></g><g transform="translate(345.578125, 634)" id="flowchart-D1-7952" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>万兆网络<br>低延迟<br>专用网络<br>避免网络瓶颈</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-8j71d4_76"><span class="control" id="-8j71d4_84">JVM调优配置：</span></p><div class="code-block" data-lang="bash">
# jvm.options - 生产环境JVM配置

# 堆内存设置（关键！）
-Xms30g                           # 初始堆大小
-Xmx30g                           # 最大堆大小
# 原则：不超过30.5GB，且不超过系统内存的50%

# 垃圾回收器选择
-XX:+UseG1GC                      # 使用G1垃圾回收器
-XX:G1HeapRegionSize=32m          # G1区域大小
-XX:+UnlockExperimentalVMOptions
-XX:+UseG1GC
-XX:MaxGCPauseMillis=50           # 最大GC暂停时间

# GC日志配置
-XX:+UseGCLogFileRotation
-XX:NumberOfGCLogFiles=32
-XX:GCLogFileSize=64m
-Xloggc:/var/log/elasticsearch/gc.log
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-XX:+PrintGCApplicationStoppedTime

# 堆外内存优化
-XX:MaxDirectMemorySize=1g        # 直接内存限制

# JIT编译优化
-XX:+UseStringDeduplication       # 字符串去重
-XX:+UseCompressedOops           # 压缩指针
-XX:+UseCompressedClassPointers  # 压缩类指针

# 错误处理
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/var/lib/elasticsearch
-XX:+ExitOnOutOfMemoryError
</div><p id="-8j71d4_78"><span class="control" id="-8j71d4_85">系统级优化：</span></p><div class="code-block" data-lang="bash">
# /etc/security/limits.conf - 系统限制配置
elasticsearch soft nofile 65536
elasticsearch hard nofile 65536
elasticsearch soft nproc 4096
elasticsearch hard nproc 4096
elasticsearch soft memlock unlimited
elasticsearch hard memlock unlimited

# /etc/sysctl.conf - 内核参数优化
vm.max_map_count=262144              # 内存映射区域限制
vm.swappiness=1                      # 降低swap使用
net.core.somaxconn=65535            # 连接队列大小
net.core.netdev_max_backlog=5000    # 网络设备队列
net.ipv4.tcp_keepalive_time=120     # TCP保活时间

# 禁用swap
sudo swapoff -a
# 或者在/etc/fstab中注释swap行
</div><p id="-8j71d4_80"><span class="control" id="-8j71d4_86">磁盘优化配置：</span></p><div class="code-block" data-lang="bash">
# 文件系统挂载选项
/dev/sdb1 /var/lib/elasticsearch ext4 noatime,nodiratime,nobarrier 0 0

# SSD优化
echo deadline &gt; /sys/block/sdb/queue/scheduler
echo mq-deadline &gt; /sys/block/sdb/queue/scheduler  # 对于NVMe

# 磁盘并发设置
echo 128 &gt; /sys/block/sdb/queue/nr_requests

# Elasticsearch数据目录配置
path.data: [&quot;/data1/elasticsearch&quot;, &quot;/data2/elasticsearch&quot;]
path.logs: &quot;/var/log/elasticsearch&quot;
</div></section><section class="chapter"><h3 id="q6-es" data-toc="q6-es">Q6: 如何监控ES集群性能？有哪些关键的性能指标？</h3><p id="-8j71d4_87"><span class="control" id="-8j71d4_96">答案：</span></p><p id="-8j71d4_88"><span class="control" id="-8j71d4_97">ES性能监控体系：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 446.265625 740"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="446.265625" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES性能监控指标" class="cluster"><rect height="724" width="430.265625" y="8" x="8" style=""></rect><g transform="translate(166.8984375, 8)" class="cluster-label"><foreignObject height="24" width="112.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES性能监控指标</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M169.609,106L175.859,106C182.109,106,194.609,106,203.984,106C213.359,106,219.609,106,225.193,106C230.776,106,235.693,106,238.151,106L240.609,106"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M169.609,282L175.859,282C182.109,282,194.609,282,205.32,282C216.03,282,224.951,282,233.204,282C241.458,282,249.046,282,252.839,282L256.633,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M169.609,458L175.859,458C182.109,458,194.609,458,204.652,458C214.695,458,222.281,458,229.201,458C236.12,458,242.372,458,245.499,458L248.625,458"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_3" d="M167.805,634L174.355,634C180.906,634,194.008,634,204.352,634C214.695,634,222.281,634,229.201,634C236.12,634,242.372,634,245.499,634L248.625,634"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(107.5546875, 106)" id="flowchart-A-8098" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>集群指标</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 106)" id="flowchart-A1-8099" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>集群健康状态<br>节点数量<br>分片状态<br>数据量统计</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 282)" id="flowchart-B-8100" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>性能指标</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 282)" id="flowchart-B1-8101" class="node default"><rect height="126" width="124.109375" y="-63" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>查询QPS<br>索引TPS<br>响应延迟<br>队列长度</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 458)" id="flowchart-C-8102" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>资源指标</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 458)" id="flowchart-C1-8103" class="node default"><rect height="126" width="140.125" y="-63" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>CPU使用率<br>内存使用率<br>磁盘IO<br>网络流量</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 634)" id="flowchart-D-8104" class="node default"><rect height="54" width="120.5" y="-27" x="-60.25" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-30.25, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="60.5"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>JVM指标</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 634)" id="flowchart-D1-8105" class="node default"><rect height="126" width="140.125" y="-63" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>堆内存使用<br>GC频率<br>GC耗时<br>线程数量</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-8j71d4_90"><span class="control" id="-8j71d4_98">关键性能指标详解：</span></p><div class="code-block" data-lang="bash">
# 1. 集群健康指标
GET /_cluster/health
{
  &quot;cluster_name&quot;: &quot;production&quot;,
  &quot;status&quot;: &quot;green&quot;,                    # green/yellow/red
  &quot;timed_out&quot;: false,
  &quot;number_of_nodes&quot;: 6,
  &quot;number_of_data_nodes&quot;: 3,
  &quot;active_primary_shards&quot;: 15,
  &quot;active_shards&quot;: 30,
  &quot;relocating_shards&quot;: 0,              # 重定位分片数
  &quot;initializing_shards&quot;: 0,            # 初始化分片数
  &quot;unassigned_shards&quot;: 0,              # 未分配分片数
  &quot;delayed_unassigned_shards&quot;: 0,
  &quot;number_of_pending_tasks&quot;: 0,        # 待处理任务数
  &quot;task_max_waiting_in_queue_millis&quot;: 0
}

# 2. 性能统计指标
GET /_stats
{
  &quot;indices&quot;: {
    &quot;count&quot;: 10,
    &quot;shards&quot;: {
      &quot;total&quot;: 30,
      &quot;primaries&quot;: 15,
      &quot;replication&quot;: 1.0
    },
    &quot;docs&quot;: {
      &quot;count&quot;: 1000000,
      &quot;deleted&quot;: 5000
    },
    &quot;store&quot;: {
      &quot;size_in_bytes&quot;: 5368709120      # 存储大小
    },
    &quot;indexing&quot;: {
      &quot;index_total&quot;: 500000,           # 总索引文档数
      &quot;index_time_in_millis&quot;: 120000,  # 索引总耗时
      &quot;index_current&quot;: 10,             # 当前索引操作数
      &quot;delete_total&quot;: 1000,
      &quot;delete_time_in_millis&quot;: 500
    },
    &quot;search&quot;: {
      &quot;query_total&quot;: 1000000,          # 总查询数
      &quot;query_time_in_millis&quot;: 300000,  # 查询总耗时
      &quot;query_current&quot;: 5,              # 当前查询数
      &quot;fetch_total&quot;: 500000,
      &quot;fetch_time_in_millis&quot;: 100000
    }
  }
}

# 3. 节点统计信息
GET /_nodes/stats
{
  &quot;nodes&quot;: {
    &quot;node1&quot;: {
      &quot;jvm&quot;: {
        &quot;mem&quot;: {
          &quot;heap_used_percent&quot;: 45,      # 堆内存使用率
          &quot;heap_used_in_bytes&quot;: 14495531008,
          &quot;heap_max_in_bytes&quot;: 32212254720
        },
        &quot;gc&quot;: {
          &quot;collectors&quot;: {
            &quot;young&quot;: {
              &quot;collection_count&quot;: 1000,  # GC次数
              &quot;collection_time_in_millis&quot;: 15000
            },
            &quot;old&quot;: {
              &quot;collection_count&quot;: 10,
              &quot;collection_time_in_millis&quot;: 2000
            }
          }
        }
      },
      &quot;thread_pool&quot;: {
        &quot;search&quot;: {
          &quot;threads&quot;: 13,
          &quot;queue&quot;: 0,                   # 队列长度
          &quot;active&quot;: 2,                  # 活跃线程数
          &quot;rejected&quot;: 0,                # 拒绝请求数
          &quot;largest&quot;: 13,
          &quot;completed&quot;: 1000000
        },
        &quot;write&quot;: {
          &quot;threads&quot;: 8,
          &quot;queue&quot;: 0,
          &quot;active&quot;: 1,
          &quot;rejected&quot;: 0,
          &quot;largest&quot;: 8,
          &quot;completed&quot;: 500000
        }
      }
    }
  }
}
</div><p id="-8j71d4_92"><span class="control" id="-8j71d4_99">监控告警配置：</span></p><div class="code-block" data-lang="yaml">
# 性能告警阈值配置
alerts:
  cluster_health:
    red_status: 
      severity: critical
      action: immediate_response
    yellow_status:
      severity: warning
      action: investigate
  
  performance_metrics:
    search_latency:
      warning: 100ms      # 查询延迟告警
      critical: 500ms
    indexing_latency:
      warning: 50ms       # 索引延迟告警  
      critical: 200ms
    queue_size:
      warning: 50         # 队列长度告警
      critical: 100
    
  resource_usage:
    heap_memory:
      warning: 75%        # 堆内存使用告警
      critical: 85%
    cpu_usage:
      warning: 80%        # CPU使用告警
      critical: 90%
    disk_usage:
      warning: 80%        # 磁盘使用告警
      critical: 90%
      
  gc_metrics:
    gc_time_ratio:
      warning: 5%         # GC时间占比告警
      critical: 10%
    gc_frequency:
      warning: 10/min     # GC频率告警
      critical: 30/min
</div><p id="-8j71d4_94"><span class="control" id="-8j71d4_100">性能监控脚本：</span></p><div class="code-block" data-lang="bash">
#!/bin/bash
# ES性能监控脚本

ES_HOST=&quot;localhost:9200&quot;

# 集群健康检查
check_cluster_health() {
    health=$(curl -s &quot;${ES_HOST}/_cluster/health&quot; | jq -r '.status')
    echo &quot;Cluster Health: $health&quot;
    if [ &quot;$health&quot; != &quot;green&quot; ]; then
        echo &quot;WARNING: Cluster health is $health&quot;
    fi
}

# 性能指标检查
check_performance() {
    stats=$(curl -s &quot;${ES_HOST}/_stats&quot;)
    
    # 查询性能
    query_total=$(echo $stats | jq '.indices.search.query_total')
    query_time=$(echo $stats | jq '.indices.search.query_time_in_millis')
    avg_query_time=$((query_time / query_total))
    echo &quot;Average Query Time: ${avg_query_time}ms&quot;
    
    # 索引性能
    index_total=$(echo $stats | jq '.indices.indexing.index_total')
    index_time=$(echo $stats | jq '.indices.indexing.index_time_in_millis')
    avg_index_time=$((index_time / index_total))
    echo &quot;Average Index Time: ${avg_index_time}ms&quot;
}

# 资源使用检查
check_resources() {
    nodes=$(curl -s &quot;${ES_HOST}/_nodes/stats&quot;)
    
    # JVM堆内存使用率
    heap_percent=$(echo $nodes | jq '.nodes | to_entries[0].value.jvm.mem.heap_used_percent')
    echo &quot;Heap Usage: ${heap_percent}%&quot;
    
    # 检查队列状态
    search_queue=$(echo $nodes | jq '.nodes | to_entries[0].value.thread_pool.search.queue')
    write_queue=$(echo $nodes | jq '.nodes | to_entries[0].value.thread_pool.write.queue')
    echo &quot;Search Queue: $search_queue, Write Queue: $write_queue&quot;
}

# 执行检查
check_cluster_health
check_performance  
check_resources
</div></section></section><section class="chapter"><h2 id="-8j71d4_8" data-toc="-8j71d4_8">💡 面试技巧</h2><section class="chapter"><h3 id="-8j71d4_101" data-toc="-8j71d4_101">高频考点</h3><ol class="list _decimal" id="-8j71d4_104" type="1"><li class="list__item" id="-8j71d4_105"><p id="-8j71d4_110"><span class="control" id="-8j71d4_111">写入性能优化</span> ：bulk API使用、索引配置、硬件选择</p></li><li class="list__item" id="-8j71d4_106"><p id="-8j71d4_112"><span class="control" id="-8j71d4_113">查询性能优化</span> ：查询结构、缓存策略、分页方法</p></li><li class="list__item" id="-8j71d4_107"><p id="-8j71d4_114"><span class="control" id="-8j71d4_115">聚合优化</span> ：大数据量聚合、内存管理、断路器配置</p></li><li class="list__item" id="-8j71d4_108"><p id="-8j71d4_116"><span class="control" id="-8j71d4_117">硬件配置</span> ：内存分配、JVM调优、磁盘优化</p></li><li class="list__item" id="-8j71d4_109"><p id="-8j71d4_118"><span class="control" id="-8j71d4_119">性能监控</span> ：关键指标、告警配置、问题诊断</p></li></ol></section><section class="chapter"><h3 id="-8j71d4_102" data-toc="-8j71d4_102">回答策略</h3><ol class="list _decimal" id="-8j71d4_120" type="1"><li class="list__item" id="-8j71d4_121"><p id="-8j71d4_125"><span class="control" id="-8j71d4_126">量化说明</span> ：用具体数字说明优化效果</p></li><li class="list__item" id="-8j71d4_122"><p id="-8j71d4_127"><span class="control" id="-8j71d4_128">实战经验</span> ：结合实际项目中遇到的性能问题</p></li><li class="list__item" id="-8j71d4_123"><p id="-8j71d4_129"><span class="control" id="-8j71d4_130">原理解释</span> ：深入理解ES性能瓶颈的根本原因</p></li><li class="list__item" id="-8j71d4_124"><p id="-8j71d4_131"><span class="control" id="-8j71d4_132">最佳实践</span> ：提及业界认可的性能优化方法</p></li></ol></section><section class="chapter"><h3 id="-8j71d4_103" data-toc="-8j71d4_103">常见性能问题</h3><ol class="list _decimal" id="-8j71d4_133" type="1"><li class="list__item" id="-8j71d4_136"><p id="-8j71d4_140"><span class="control" id="-8j71d4_141">内存问题</span> ：堆内存溢出、GC频繁、内存泄漏</p></li><li class="list__item" id="-8j71d4_137"><p id="-8j71d4_142"><span class="control" id="-8j71d4_143">查询缓慢</span> ：深度分页、复杂聚合、大结果集</p></li><li class="list__item" id="-8j71d4_138"><p id="-8j71d4_144"><span class="control" id="-8j71d4_145">写入性能差</span> ：配置不当、硬件瓶颈、网络延迟</p></li><li class="list__item" id="-8j71d4_139"><p id="-8j71d4_146"><span class="control" id="-8j71d4_147">集群不稳定</span> ：分片分配、节点故障、网络分区</p></li></ol><p id="-8j71d4_135"><span class="control" id="-8j71d4_148">学习建议</span> ：ES性能优化是一个系统工程，需要从多个维度综合考虑。建议通过实际的性能测试来验证优化效果，重点掌握性能监控和问题诊断的方法，同时要了解ES的底层工作原理。</p></section></section><div class="last-modified">09 六月 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="es集群管理qa.html" class="navigation-links__prev">ES集群管理QA</a><a href="es高级特性qa.html" class="navigation-links__next">ES高级特性QA</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>