<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-06-10T01:18:25.284788"><title>Java内存模型与可见性QA | 技术知识库</title><script type="application/json" id="virtual-toc-data">[{"id":"-2pnfw_4","level":0,"title":"📋 知识结构","anchor":"#-2pnfw_4"},{"id":"jmm","level":0,"title":"🧠 JMM基础概念","anchor":"#jmm"},{"id":"-2pnfw_6","level":0,"title":"💡 面试技巧","anchor":"#-2pnfw_6"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Java内存模型与可见性QA | 技术知识库"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="技术知识库 Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/java内存模型与可见性qa.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Java内存模型与可见性QA | 技术知识库"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/java内存模型与可见性qa.html#webpage",
    "url": "writerside-documentation/java内存模型与可见性qa.html",
    "name": "Java内存模型与可见性QA | 技术知识库",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "技术知识库 Help"
}</script><!-- End Schema.org --></head><body data-id="Java内存模型与可见性QA" data-main-title="Java内存模型与可见性QA" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Java并发面试大纲.md|Java并发面试大纲"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>技术知识库  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Java内存模型与可见性QA" id="Java内存模型与可见性QA.md">Java内存模型与可见性QA</h1><p id="-2pnfw_3">Java内存模型（JMM）是理解并发编程的核心理论基础。本文档深入解析JMM规范、可见性问题、重排序机制和happens-before原则。</p><section class="chapter"><h2 id="-2pnfw_4" data-toc="-2pnfw_4">📋 知识结构</h2><svg aria-roledescription="mindmap" role="graphics-document document" viewBox="5 5 817.0978393554688 410.5154113769531" style="max-width: 817.0978393554688px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><g></g><g class="mindmap-edges"><path class="edge section-edge-0 edge-depth-1" d="M 610.2406366613646,131.85601800779304 L 619.624757444166,97.64380300690569 L629.0088782269673,63.431588006018345"></path><path class="edge section-edge-0 edge-depth-1" d="M 616.8588945540824,156.94880343637521 L 645.4788322993251,185.67961675666692 L674.0987700445677,214.41043007695856"></path><path class="edge section-edge-0 edge-depth-1" d="M 621.107046956877,148.54559961533107 L 683.6613289653304,157.9234680924997 L746.2156109737839,167.3013365696683"></path><path class="edge section-edge-0 edge-depth-1" d="M 620.5363371689728,141.67929977880556 L 683.0723741156326,121.32539476356854 L745.6084110622924,100.97148974833152"></path><path class="edge section-edge-0 edge-depth-0" d="M 438.39665795182253,191.54845727511074 L 515.0929374441974,170.88606669534127 L591.7892169365723,150.2236761155718"></path><path class="edge section-edge-1 edge-depth-1" d="M 462.9182159355408,307.133637982962 L 493.7955145839678,335.47005855711143 L524.6728132323949,363.80647913126086"></path><path class="edge section-edge-1 edge-depth-1" d="M 466.78211473595684,298.5817731545738 L 532.200602362947,305.55662564298245 L597.6190899899373,312.5314781313911"></path><path class="edge section-edge-1 edge-depth-1" d="M 444.7381945577069,310.1894219155975 L 427.662827088422,341.8034629694687 L410.58745961913706,373.41750402333986"></path><path class="edge section-edge-1 edge-depth-1" d="M 464.7757545720983,289.35245306735214 L 503.92350330707393,266.18650887671674 L543.0712520420495,243.0205646860814"></path><path class="edge section-edge-1 edge-depth-0" d="M 427.8943491931717,209.91241279267834 L 437.88985418663356,246.22095956321454 L447.8853591800954,282.52950633375076"></path><path class="edge section-edge-2 edge-depth-1" d="M 223.8620305062672,251.61230828190511 L 152.16872090593387,258.69118273852735 L80.47541130560055,265.7700571951496"></path><path class="edge section-edge-2 edge-depth-1" d="M 245.6505544440795,263.47725917265007 L 260.5919657977423,292.5252231272882 L275.53337715140515,321.57318708192633"></path><path class="edge section-edge-2 edge-depth-1" d="M 227.38217335060892,259.8787418628502 L 194.43021185042687,288.0154809198083 L161.47825035024482,316.1522199767664"></path><path class="edge section-edge-2 edge-depth-1" d="M 224.98147425350626,244.27836367590442 L 170.27030589620057,221.05919601003671 L115.55913753889487,197.84002834416896"></path><path class="edge section-edge-2 edge-depth-0" d="M 409.52762992602663,199.70006426863165 L 331.35124905939557,222.79440937867173 L253.17486819276442,245.88875448871175"></path><path class="edge section-edge-3 edge-depth-1" d="M 320.76938131373106,119.39184082384176 L 390.3754412808509,105.24465308647612 L459.98150124797075,91.09746534911048"></path><path class="edge section-edge-3 edge-depth-1" d="M 293.5296012957286,114.14899878046623 L 252.62883397045886,87.30502655145554 L211.72806664518913,60.46105432244484"></path><path class="edge section-edge-3 edge-depth-1" d="M 313.73951105127617,109.4884745100442 L 332.39069693728055,78.13972740808262 L351.04188282328494,46.79098030612104"></path><path class="edge section-edge-3 edge-depth-1" d="M 291.0802852918016,121.82191465776901 L 219.76999445059687,119.16952508327265 L148.45970360939214,116.51713550877628"></path><path class="edge section-edge-3 edge-depth-0" d="M 411.16491442150937,187.5456802567935 L 364.9914883260874,158.91493612728735 L318.81806223066553,130.2841919977812"></path></g><g class="mindmap-nodes"><g transform="translate(365.67868164261665, 176.55041743840945)" class="mindmap-node section--1 section-root"><g transform="translate(58.234375, 18.9)"><circle r="58.234375" class="node-bkg node-circle" id="node-0"></circle></g><g transform="translate(58.234375, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Java内存模型</tspan></tspan></text></g></g></g><g transform="translate(565.0462557457782, 127.42171595227308)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h72.453125 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-1"></path><line y2="37.8" x2="82.453125" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(41.2265625, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">JMM基础</tspan></tspan></text></g></g></g><g transform="translate(401.3186513949571, 278.09150168801966)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.09600067138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-6"></path><line y2="37.8" x2="101.09600067138672" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(50.54800033569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">可见性问题</tspan></tspan></text></g></g></g><g transform="translate(177.20350397617437, 231.23840131893394)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h113.171875 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-11"></path><line y2="37.8" x2="123.171875" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(61.5859375, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">volatile关键字</tspan></tspan></text></g></g></g><g transform="translate(239.83578533548598, 103.47945481616523)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h122.46826934814453 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-16"></path><line y2="37.8" x2="132.46826934814453" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(66.23413467407227, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">happens-before</tspan></tspan></text></g></g></g><g transform="translate(558.3926970087647, 30.065890061538312)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h139.16799926757812 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-2"></path><line y2="37.8" x2="149.16799926757812" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(74.58399963378906, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">主内存与工作内存</tspan></tspan></text></g></g></g><g transform="translate(626.1248449795809, 206.1375175610607)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h107.12000274658203 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-3"></path><line y2="37.8" x2="117.12000274658203" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(58.560001373291016, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">内存交互操作</tspan></tspan></text></g></g></g><g transform="translate(710.0018393491893, 150.6252202327263)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h92.09600067138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-4"></path><line y2="37.8" x2="102.09600067138672" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(51.04800033569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">原子性保证</tspan></tspan></text></g></g></g><g transform="translate(709.3094299854869, 77.42907357486399)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.125 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-5"></path><line y2="37.8" x2="101.125" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(50.5625, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">一致性模型</tspan></tspan></text></g></g></g><g transform="translate(485.1763771015918, 355.04861542620324)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.09600067138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-7"></path><line y2="37.8" x2="101.09600067138672" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(50.54800033569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">缓存一致性</tspan></tspan></text></g></g></g><g transform="translate(561.9720529952436, 295.2217495979453)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.125 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-8"></path><line y2="37.8" x2="101.125" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(50.5625, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">指令重排序</tspan></tspan></text></g></g></g><g transform="translate(352.41100211050014, 367.71542425091775)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h92.09600067138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-9"></path><line y2="37.8" x2="102.09600067138672" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(51.04800033569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">编译器优化</tspan></tspan></text></g></g></g><g transform="translate(514.998760797804, 216.48151606541387)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h71.96318817138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-10"></path><line y2="37.8" x2="81.96318817138672" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(40.98159408569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">CPU优化</tspan></tspan></text></g></g></g><g transform="translate(15, 248.34396415812077)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.09600067138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-12"></path><line y2="37.8" x2="101.09600067138672" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(50.54800033569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">可见性保证</tspan></tspan></text></g></g></g><g transform="translate(231.83199011931026, 316.0120449356425)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.125 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-13"></path><line y2="37.8" x2="101.125" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(50.5625, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">禁止重排序</tspan></tspan></text></g></g></g><g transform="translate(99.50848222467937, 306.9925605206827)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.125 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-14"></path><line y2="37.8" x2="101.125" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(50.5625, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">原子性限制</tspan></tspan></text></g></g></g><g transform="translate(59.19648281622676, 173.07999070113942)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-15"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">使用场景</tspan></tspan></text></g></g></g><g transform="translate(416.10283755214357, 69.209851356787)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h107.15625 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-17"></path><line y2="37.8" x2="117.15625" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(58.578125, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">程序顺序规则</tspan></tspan></text></g></g></g><g transform="translate(141.10962293135947, 33.33059828674584)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h106.15625 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-18"></path><line y2="37.8" x2="116.15625" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(58.078125, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">监视器锁规则</tspan></tspan></text></g></g></g><g transform="translate(289.11772386500286, 15)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h129.1875 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-19"></path><line y2="37.8" x2="139.1875" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(69.59375, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">volatile变量规则</tspan></tspan></text></g></g></g><g transform="translate(82.90756889163549, 97.05959535038005)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.125 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-20"></path><line y2="37.8" x2="101.125" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(50.5625, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">传递性规则</tspan></tspan></text></g></g></g></g></svg></section><section class="chapter"><h2 id="jmm" data-toc="jmm">🧠 JMM基础概念</h2><section class="chapter"><h3 id="q1-java-jmm" data-toc="q1-java-jmm">Q1: 什么是Java内存模型？为什么需要JMM？</h3><p id="-2pnfw_12"><span class="control" id="-2pnfw_21">答案：</span></p><p id="-2pnfw_13"><span class="control" id="-2pnfw_22">Java内存模型架构：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 709.671875 612"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="709.671875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="Java内存模型架构" class="cluster"><rect height="596" width="693.671875" y="8" x="8" style=""></rect><g transform="translate(290.578125, 8)" class="cluster-label"><foreignObject height="24" width="128.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Java内存模型架构</p></span></div></foreignObject></g></g><g data-look="classic" id="线程3工作内存" class="cluster"><rect height="172" width="279.21875" y="412" x="45.5" style=""></rect><g transform="translate(132.828125, 412)" class="cluster-label"><foreignObject height="24" width="104.5625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>线程3工作内存</p></span></div></foreignObject></g></g><g data-look="classic" id="subGraph2" class="cluster"><rect height="172" width="279.21875" y="220" x="45.5" style=""></rect><g transform="translate(132.828125, 220)" class="cluster-label"><foreignObject height="24" width="104.5625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>线程2工作内存</p></span></div></foreignObject></g></g><g data-look="classic" id="线程1工作内存" class="cluster"><rect height="172" width="279.21875" y="28" x="45.5" style=""></rect><g transform="translate(132.828125, 28)" class="cluster-label"><foreignObject height="24" width="104.5625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>线程1工作内存</p></span></div></foreignObject></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="456" width="264.453125" y="68" x="399.71875" style=""></rect><g transform="translate(452.484375, 68)" class="cluster-label"><foreignObject height="24" width="158.921875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>主内存 (Main Memory)</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" marker-start="url(#mermaid_flowchart-v2-pointStart)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B1_A1_0" d="M291.219,114L296.802,114C302.385,114,313.552,114,325.385,114C337.219,114,349.719,114,362.219,114C374.719,114,387.219,114,400.872,124.75C414.525,135.5,429.332,157,443.76,177.951C458.189,198.902,472.239,219.304,479.265,229.505L486.29,239.706"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" marker-start="url(#mermaid_flowchart-v2-pointStart)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C1_A1_1" d="M291.219,306L296.802,306C302.385,306,313.552,306,325.385,306C337.219,306,349.719,306,362.219,306C374.719,306,387.219,306,396.594,306C405.969,306,412.219,306,417.802,306C423.385,306,428.302,306,430.76,306L433.219,306"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" marker-start="url(#mermaid_flowchart-v2-pointStart)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D1_A1_2" d="M291.219,498L296.802,498C302.385,498,313.552,498,325.385,498C337.219,498,349.719,498,362.219,498C374.719,498,387.219,498,400.872,487.25C414.525,476.5,429.332,455,443.76,434.049C458.189,413.098,472.239,392.696,479.265,382.495L486.29,372.294"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(185.109375, 498)" id="flowchart-D1-8996" class="node default"><rect height="102" width="204.21875" y="-51" x="-102.109375" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-72.109375, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="144.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>共享变量的本地副本<br>CPU缓存<br>寄存器</p></span></div></foreignObject></g></g><g transform="translate(185.109375, 114)" id="flowchart-B1-8994" class="node default"><rect height="102" width="204.21875" y="-51" x="-102.109375" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-72.109375, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="144.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>共享变量的本地副本<br>CPU缓存<br>寄存器</p></span></div></foreignObject></g></g><g transform="translate(531.9453125, 306)" id="flowchart-A1-8993" class="node default"><rect height="126" width="189.453125" y="-63" x="-94.7265625" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-64.7265625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="129.453125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>共享变量的主副本<br>instance variables<br>static variables<br>array elements</p></span></div></foreignObject></g></g><g transform="translate(185.109375, 306)" id="flowchart-C1-8995" class="node default"><rect height="102" width="204.21875" y="-51" x="-102.109375" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-72.109375, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="144.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>共享变量的本地副本<br>CPU缓存<br>寄存器</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-2pnfw_15"><span class="control" id="-2pnfw_23">JMM解决的问题：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 590.46875 492"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="590.46875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="多处理器系统的挑战" class="cluster"><rect height="476" width="574.46875" y="8" x="8" style=""></rect><g transform="translate(223.125, 8)" class="cluster-label"><foreignObject height="24" width="144.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>多处理器系统的挑战</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M217.672,94L223.922,94C230.172,94,242.672,94,254.05,94C265.428,94,275.685,94,285.275,94C294.865,94,303.788,94,308.249,94L312.711,94"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M217.672,246L223.922,246C230.172,246,242.672,246,254.717,246C266.763,246,278.354,246,289.279,246C300.203,246,310.461,246,315.59,246L320.719,246"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M201.648,398L210.569,398C219.49,398,237.331,398,249.376,398C261.422,398,267.672,398,273.255,398C278.839,398,283.755,398,286.214,398L288.672,398"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(131.5859375, 94)" id="flowchart-A-9087" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>缓存一致性问题</p></span></div></foreignObject></g></g><g transform="translate(418.8203125, 94)" id="flowchart-A1-9088" class="node default"><rect height="102" width="204.21875" y="-51" x="-102.109375" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-72.109375, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="144.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>每个CPU有独立缓存<br>缓存数据可能不一致<br>需要缓存一致性协议</p></span></div></foreignObject></g></g><g transform="translate(131.5859375, 246)" id="flowchart-B-9089" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>指令重排序问题</p></span></div></foreignObject></g></g><g transform="translate(418.8203125, 246)" id="flowchart-B1-9090" class="node default"><rect height="102" width="188.203125" y="-51" x="-94.1015625" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-64.1015625, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>编译器优化重排序<br>CPU执行重排序<br>内存系统重排序</p></span></div></foreignObject></g></g><g transform="translate(131.5859375, 398)" id="flowchart-C-9091" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>可见性问题</p></span></div></foreignObject></g></g><g transform="translate(418.8203125, 398)" id="flowchart-C1-9092" class="node default"><rect height="102" width="252.296875" y="-51" x="-126.1484375" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-96.1484375, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="192.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>线程修改对其他线程不可见<br>需要内存屏障机制<br>需要同步原语</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-2pnfw_17"><span class="control" id="-2pnfw_24">JMM的设计目标：</span></p><ol class="list _decimal" id="-2pnfw_18" type="1"><li class="list__item" id="-2pnfw_25"><p id="-2pnfw_28"><span class="control" id="-2pnfw_29">为程序员提供足够强的内存可见性保证</span></p></li><li class="list__item" id="-2pnfw_26"><p id="-2pnfw_30"><span class="control" id="-2pnfw_31">对编译器和处理器的束缚尽可能少</span></p></li><li class="list__item" id="-2pnfw_27"><p id="-2pnfw_32"><span class="control" id="-2pnfw_33">平衡易用性和性能</span></p></li></ol><p id="-2pnfw_19"><span class="control" id="-2pnfw_34">内存间交互操作：</span></p><div class="code-block" data-lang="java">
// JMM定义的8种基本操作
public class JMMOperations {
    private int sharedVariable = 0;
    
    public void demonstrateJMMOperations() {
        /*
         * JMM定义了8种原子操作：
         * 
         * 作用于主内存的操作：
         * - read: 从主内存读取变量值到工作内存
         * - load: 将read到的值放入工作内存的变量副本中
         * - store: 将工作内存中的变量值传送到主内存
         * - write: 将store的值放入主内存的变量中
         * 
         * 作用于工作内存的操作：
         * - use: 将工作内存中的变量值传递给执行引擎
         * - assign: 将执行引擎的值赋给工作内存中的变量
         * - lock: 作用于主内存变量，标识为一个线程独占
         * - unlock: 作用于主内存变量，释放锁定
         */
        
        // 读取操作：read -&gt; load -&gt; use
        int localVar = sharedVariable;
        
        // 写入操作：assign -&gt; store -&gt; write  
        sharedVariable = 100;
    }
}
</div></section><section class="chapter"><h3 id="q2" data-toc="q2">Q2: 什么是可见性问题？如何保证可见性？</h3><p id="-2pnfw_35"><span class="control" id="-2pnfw_42">答案：</span></p><p id="-2pnfw_36"><span class="control" id="-2pnfw_43">可见性问题演示：</span></p><svg aria-roledescription="sequence" role="graphics-document document" viewBox="-50 -10 1146 992" style="max-width: 1146px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><g><rect class="actor actor-bottom" ry="3" rx="3" name="T2" height="65" width="150" stroke="#666" fill="#eaeaea" y="906" x="896"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="938.5" x="971"><tspan dy="0" x="971">线程2</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="WM2" height="65" width="150" stroke="#666" fill="#eaeaea" y="906" x="645"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="938.5" x="720"><tspan dy="0" x="720">工作内存2</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="MM" height="65" width="150" stroke="#666" fill="#eaeaea" y="906" x="445"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="938.5" x="520"><tspan dy="0" x="520">主内存</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="WM1" height="65" width="150" stroke="#666" fill="#eaeaea" y="906" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="938.5" x="275"><tspan dy="0" x="275">工作内存1</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="T1" height="65" width="150" stroke="#666" fill="#eaeaea" y="906" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="938.5" x="75"><tspan dy="0" x="75">线程1</tspan></text></g><g><line name="T2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="906" x2="971" y1="5" x1="971" id="actor296"></line><g id="root-296"><rect class="actor actor-top" ry="3" rx="3" name="T2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="896"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="971"><tspan dy="0" x="971">线程2</tspan></text></g></g><g><line name="WM2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="906" x2="720" y1="5" x1="720" id="actor295"></line><g id="root-295"><rect class="actor actor-top" ry="3" rx="3" name="WM2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="645"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="720"><tspan dy="0" x="720">工作内存2</tspan></text></g></g><g><line name="MM" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="906" x2="520" y1="5" x1="520" id="actor294"></line><g id="root-294"><rect class="actor actor-top" ry="3" rx="3" name="MM" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="445"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="520"><tspan dy="0" x="520">主内存</tspan></text></g></g><g><line name="WM1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="906" x2="275" y1="5" x1="275" id="actor293"></line><g id="root-293"><rect class="actor actor-top" ry="3" rx="3" name="WM1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">工作内存1</tspan></text></g></g><g><line name="T1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="906" x2="75" y1="5" x1="75" id="actor292"></line><g id="root-292"><rect class="actor actor-top" ry="3" rx="3" name="T1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">线程1</tspan></text></g></g><g></g><defs><symbol height="24" width="24" id="computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="7.9" id="arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refY="4.5" refX="4" orient="auto" markerHeight="8" markerWidth="15" id="crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="15.5" id="filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="40" markerWidth="60" refY="15" refX="15" id="sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="150" stroke="#666" fill="#EDF2AE" y="75" x="445"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="520"><tspan x="520">flag = false</tspan></text></g><g><rect class="note" height="39" width="150" stroke="#666" fill="#EDF2AE" y="508" x="0"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="513" x="75"><tspan x="75">执行业务逻辑</tspan></text></g><g><rect class="note" height="39" width="166" stroke="#666" fill="#EDF2AE" y="605" x="192"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="610" x="275"><tspan x="275">仅在工作内存中修改</tspan></text></g><g><rect class="note" height="39" width="150" stroke="#666" fill="#EDF2AE" y="654" x="896"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="659" x="971"><tspan x="971">检查flag</tspan></text></g><g><rect class="note" height="39" width="295" stroke="#666" fill="#EDF2AE" y="799" x="250"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="804" x="398"><tspan x="398">某个时刻才会刷新到主内存</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="129" x="174">读取flag</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="162" x2="271" y1="162" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="177" x="396">read flag</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="210" x2="516" y1="210" x1="276"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="225" x="399">flag = false</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="258" x2="279" y1="258" x1="519"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="273" x="177">flag = false</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="306" x2="79" y1="306" x1="274"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="321" x="847">读取flag</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="354" x2="724" y1="354" x1="970"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="369" x="622">read flag</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="402" x2="524" y1="402" x1="719"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="417" x="619">flag = false</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="450" x2="716" y1="450" x1="521"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="465" x="844">flag = false</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="498" x2="967" y1="498" x1="721"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="562" x="174">修改flag = true</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="595" x2="271" y1="595" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="708" x="847">读取flag</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="741" x2="724" y1="741" x1="970"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="756" x="844">flag = false (看不到修改!)</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="789" x2="967" y1="789" x1="721"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="853" x="396">store &amp; write flag = true</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="886" x2="516" y1="886" x1="276"></line></svg><p id="-2pnfw_38"><span class="control" id="-2pnfw_44">可见性问题的代码示例：</span></p><div class="code-block" data-lang="java">
// 可见性问题演示
public class VisibilityProblem {
    private boolean flag = false;  // 没有volatile修饰
    private int counter = 0;
    
    // 线程1执行
    public void writer() {
        counter = 42;              // 操作1
        flag = true;               // 操作2
    }
    
    // 线程2执行
    public void reader() {
        if (flag) {                // 操作3
            System.out.println(&quot;Counter: &quot; + counter); // 操作4
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        VisibilityProblem example = new VisibilityProblem();
        
        // 线程1: 写入数据
        Thread writerThread = new Thread(() -&gt; {
            example.writer();
            System.out.println(&quot;Writer finished&quot;);
        });
        
        // 线程2: 读取数据
        Thread readerThread = new Thread(() -&gt; {
            while (true) {
                example.reader();
                try {
                    Thread.sleep(1);
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        
        readerThread.start();
        Thread.sleep(1000);
        writerThread.start();
        
        Thread.sleep(5000);
        readerThread.interrupt();
    }
}
</div><p id="-2pnfw_40"><span class="control" id="-2pnfw_45">保证可见性的方法：</span></p><div class="code-block" data-lang="java">
// 方法1: 使用volatile关键字
public class VolatileVisibility {
    private volatile boolean flag = false;  // volatile保证可见性
    private volatile int counter = 0;
    
    public void writer() {
        counter = 42;
        flag = true;  // volatile写，保证前面的写操作对其他线程可见
    }
    
    public void reader() {
        if (flag) {   // volatile读，保证后面的读操作能看到最新值
            System.out.println(&quot;Counter: &quot; + counter);
        }
    }
}

// 方法2: 使用synchronized同步
public class SynchronizedVisibility {
    private boolean flag = false;
    private int counter = 0;
    private final Object lock = new Object();
    
    public void writer() {
        synchronized (lock) {     // synchronized保证可见性
            counter = 42;
            flag = true;
        }
    }
    
    public void reader() {
        synchronized (lock) {     // 同一把锁保证可见性
            if (flag) {
                System.out.println(&quot;Counter: &quot; + counter);
            }
        }
    }
}

// 方法3: 使用final字段
public class FinalVisibility {
    private final int finalField;        // final字段天然可见
    private volatile boolean ready = false;
    
    public FinalVisibility() {
        finalField = 42;                  // 构造函数中初始化final字段
        ready = true;                     // volatile确保构造完成的可见性
    }
    
    public void reader() {
        if (ready) {
            System.out.println(&quot;Final field: &quot; + finalField); // 总是能看到正确值
        }
    }
}
</div></section><section class="chapter"><h3 id="q3-volatile" data-toc="q3-volatile">Q3: volatile关键字的作用是什么？使用场景有哪些？</h3><p id="-2pnfw_46"><span class="control" id="-2pnfw_60">答案：</span></p><p id="-2pnfw_47"><span class="control" id="-2pnfw_61">volatile的两大作用：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 598.171875 540"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="598.171875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="volatile关键字作用" class="cluster"><rect height="524" width="582.171875" y="8" x="8" style=""></rect><g transform="translate(231.9765625, 8)" class="cluster-label"><foreignObject height="24" width="134.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>volatile关键字作用</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M201.648,94L210.569,94C219.49,94,237.331,94,252.368,94C267.405,94,279.638,94,291.204,94C302.771,94,313.671,94,319.12,94L324.57,94"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M217.672,270L223.922,270C230.172,270,242.672,270,252.047,270C261.422,270,267.672,270,273.255,270C278.839,270,283.755,270,286.214,270L288.672,270"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M209.664,446L217.249,446C224.833,446,240.003,446,252.368,446C264.734,446,274.297,446,283.193,446C292.089,446,300.318,446,304.432,446L308.547,446"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(131.5859375, 94)" id="flowchart-A-9373" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>保证可见性</p></span></div></foreignObject></g></g><g transform="translate(422.671875, 94)" id="flowchart-A1-9374" class="node default"><rect height="102" width="188.203125" y="-51" x="-94.1015625" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-64.1015625, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>立即刷新到主内存<br>其他线程立即可见<br>禁用缓存优化</p></span></div></foreignObject></g></g><g transform="translate(131.5859375, 270)" id="flowchart-B-9375" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>禁止指令重排序</p></span></div></foreignObject></g></g><g transform="translate(422.671875, 270)" id="flowchart-B1-9376" class="node default"><rect height="150" width="260" y="-75" x="-130" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-100, -60)" style="" class="label"><rect></rect><foreignObject height="120" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>volatile写之前的操作不能重排序到写之后<br>volatile读之后的操作不能重排序到读之前<br>插入内存屏障</p></span></div></foreignObject></g></g><g transform="translate(131.5859375, 446)" id="flowchart-C-9377" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>不保证原子性</p></span></div></foreignObject></g></g><g transform="translate(422.671875, 446)" id="flowchart-C1-9378" class="node default"><rect height="102" width="220.25" y="-51" x="-110.125" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-80.125, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="160.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>复合操作不是原子的<br>如i++需要额外同步<br>只保证单次读写原子性</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-2pnfw_49"><span class="control" id="-2pnfw_62">volatile内存语义：</span></p><div class="code-block" data-lang="java">
// volatile内存语义演示
public class VolatileSemantics {
    private int a = 0;
    private int b = 0;
    private volatile boolean flag = false;
    
    // 线程1执行
    public void writer() {
        a = 1;                    // 普通写
        b = 2;                    // 普通写
        flag = true;              // volatile写
        /*
         * volatile写的内存语义：
         * 1. 当写一个volatile变量时，JMM会把该线程对应的本地内存中的
         *    所有共享变量值刷新到主内存
         * 2. volatile写之前的所有操作都不会被重排序到volatile写之后
         */
    }
    
    // 线程2执行
    public void reader() {
        if (flag) {               // volatile读
            System.out.println(&quot;a = &quot; + a); // 一定能看到a = 1
            System.out.println(&quot;b = &quot; + b); // 一定能看到b = 2
        }
        /*
         * volatile读的内存语义：
         * 1. 当读一个volatile变量时，JMM会把该线程对应的本地内存
         *    置为无效，必须从主内存中读取共享变量
         * 2. volatile读之后的所有操作都不会被重排序到volatile读之前
         */
    }
}
</div><p id="-2pnfw_51"><span class="control" id="-2pnfw_63">volatile使用场景：</span></p><p id="-2pnfw_52"><span class="control" id="-2pnfw_64">场景1：状态标记</span></p><div class="code-block" data-lang="java">
// 状态标记 - 最常见的volatile使用场景
public class StatusFlag {
    private volatile boolean shutdown = false;
    
    // 业务线程
    public void doWork() {
        while (!shutdown) {       // 检查volatile变量
            // 执行业务逻辑
            performWork();
        }
        cleanup();
    }
    
    // 控制线程
    public void shutdown() {
        shutdown = true;          // 设置volatile变量
    }
    
    private void performWork() {
        // 模拟工作
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private void cleanup() {
        System.out.println(&quot;Cleanup completed&quot;);
    }
}
</div><p id="-2pnfw_54"><span class="control" id="-2pnfw_65">场景2：双重检查锁定单例模式</span></p><div class="code-block" data-lang="java">
// 双重检查锁定单例模式
public class Singleton {
    private static volatile Singleton instance; // volatile确保可见性
    
    private Singleton() {}
    
    public static Singleton getInstance() {
        if (instance == null) {                 // 第一次检查
            synchronized (Singleton.class) {
                if (instance == null) {         // 第二次检查
                    instance = new Singleton(); // volatile防止重排序
                }
            }
        }
        return instance;
    }
    
    /*
     * 为什么需要volatile？
     * instance = new Singleton() 包含三个步骤：
     * 1. 分配内存空间
     * 2. 初始化对象
     * 3. 将instance指向分配的内存
     * 
     * 没有volatile，可能会重排序为1-&gt;3-&gt;2，
     * 导致其他线程看到未初始化的对象
     */
}
</div><p id="-2pnfw_56"><span class="control" id="-2pnfw_66">场景3：一次性安全发布</span></p><div class="code-block" data-lang="java">
// 一次性安全发布
public class SafePublication {
    private int value;
    private volatile boolean ready = false;
    
    // 发布线程
    public void publish() {
        value = 42;               // 普通写
        ready = true;             // volatile写，确保value的修改对其他线程可见
    }
    
    // 消费线程
    public void consume() {
        if (ready) {              // volatile读
            System.out.println(&quot;Value: &quot; + value); // 一定能看到value = 42
        }
    }
}
</div><p id="-2pnfw_58"><span class="control" id="-2pnfw_67">volatile的局限性：</span></p><div class="code-block" data-lang="java">
// volatile不能保证复合操作的原子性
public class VolatileLimitation {
    private volatile int counter = 0;
    
    // 错误：volatile不能保证++操作的原子性
    public void increment() {
        counter++;  // 这不是原子操作！
        /*
         * counter++ 实际包含三个操作：
         * 1. 读取counter的值
         * 2. 将值加1
         * 3. 将新值写回counter
         * 
         * 多线程环境下可能出现竞态条件
         */
    }
    
    // 正确：使用synchronized保证原子性
    public synchronized void safeIncrement() {
        counter++;
    }
    
    // 正确：使用AtomicInteger
    private final AtomicInteger atomicCounter = new AtomicInteger(0);
    
    public void atomicIncrement() {
        atomicCounter.incrementAndGet(); // 原子操作
    }
}
</div></section><section class="chapter"><h3 id="q4-happens-before" data-toc="q4-happens-before">Q4: 什么是happens-before原则？如何理解内存重排序？</h3><p id="-2pnfw_68"><span class="control" id="-2pnfw_79">答案：</span></p><p id="-2pnfw_69"><span class="control" id="-2pnfw_80">happens-before关系定义：</span></p><p id="-2pnfw_70">如果操作A happens-before 操作B，那么操作A的执行结果对操作B可见，且操作A的执行顺序在操作B之前。</p><p id="-2pnfw_71"><span class="control" id="-2pnfw_81">happens-before规则：</span></p><p id="-2pnfw_73"><span class="control" id="-2pnfw_82">重排序类型：</span></p><div class="code-block" data-lang="java">
// 内存重排序演示
public class ReorderingExample {
    private int a = 0;
    private int b = 0;
    private int x = 0;
    private int y = 0;
    
    // 可能发生重排序的代码
    public void possibleReordering() throws InterruptedException {
        Thread thread1 = new Thread(() -&gt; {
            a = 1;        // 操作1
            x = b;        // 操作2
            // 编译器或CPU可能将操作2重排序到操作1之前
        });
        
        Thread thread2 = new Thread(() -&gt; {
            b = 1;        // 操作3  
            y = a;        // 操作4
            // 编译器或CPU可能将操作4重排序到操作3之前
        });
        
        thread1.start();
        thread2.start();
        thread1.join();
        thread2.join();
        
        // 可能的结果：x = 0, y = 0
        // 这在没有重排序的情况下是不可能的
        System.out.println(&quot;x = &quot; + x + &quot;, y = &quot; + y);
    }
}
</div><p id="-2pnfw_75"><span class="control" id="-2pnfw_83">使用happens-before保证顺序：</span></p><div class="code-block" data-lang="java">
// 使用happens-before规则保证执行顺序
public class HappensBeforeExample {
    private int data = 0;
    private volatile boolean ready = false;  // volatile变量
    
    // 线程1：生产者
    public void producer() {
        data = 42;          // 操作1
        ready = true;       // 操作2：volatile写
        
        /*
         * 根据程序顺序规则：操作1 happens-before 操作2
         * 根据volatile规则：操作2 happens-before 消费者的volatile读
         * 根据传递性：操作1 happens-before 消费者的volatile读
         */
    }
    
    // 线程2：消费者
    public void consumer() {
        if (ready) {        // volatile读
            System.out.println(&quot;Data: &quot; + data); // 一定能看到data = 42
        }
    }
}

// 使用synchronized保证happens-before
public class SynchronizedHappensBeforeExample {
    private int data = 0;
    private final Object lock = new Object();
    
    // 线程1
    public void writer() {
        synchronized (lock) {   // 获取锁
            data = 42;          // 在同步块内修改
        }                       // 释放锁
    }
    
    // 线程2
    public void reader() {
        synchronized (lock) {   // 获取锁（happens-before关系建立）
            System.out.println(&quot;Data: &quot; + data); // 一定能看到data = 42
        }
    }
}
</div><p id="-2pnfw_77"><span class="control" id="-2pnfw_84">内存屏障（Memory Barrier）：</span></p><div class="code-block" data-lang="java">
// 内存屏障的概念理解
public class MemoryBarrier {
    /*
     * JVM使用内存屏障来禁止特定类型的重排序：
     * 
     * LoadLoad屏障：   Load1; LoadLoad; Load2
     *                 确保Load1的数据装载先于Load2及所有后续装载指令
     * 
     * StoreStore屏障： Store1; StoreStore; Store2  
     *                 确保Store1数据对其他处理器可见先于Store2
     * 
     * LoadStore屏障：  Load1; LoadStore; Store2
     *                 确保Load1数据装载先于Store2及所有后续存储指令
     * 
     * StoreLoad屏障：  Store1; StoreLoad; Load2
     *                 确保Store1数据对其他处理器可见先于Load2
     */
    
    private int a = 0;
    private volatile int v = 0;
    private int b = 0;
    
    public void memoryBarrierExample() {
        a = 1;              // 普通写
        // 编译器插入StoreStore屏障
        v = 2;              // volatile写  
        // 编译器插入StoreLoad屏障
        b = 3;              // 普通写
        
        /*
         * volatile写的内存屏障：
         * 1. 在volatile写前插入StoreStore屏障
         * 2. 在volatile写后插入StoreLoad屏障
         */
    }
    
    public void readExample() {
        int i = v;          // volatile读
        // 编译器插入LoadLoad屏障  
        // 编译器插入LoadStore屏障
        int j = a;          // 普通读
        
        /*
         * volatile读的内存屏障：
         * 1. 在volatile读后插入LoadLoad屏障
         * 2. 在volatile读后插入LoadStore屏障
         */
    }
}
</div></section></section><section class="chapter"><h2 id="-2pnfw_6" data-toc="-2pnfw_6">💡 面试技巧</h2><section class="chapter"><h3 id="-2pnfw_85" data-toc="-2pnfw_85">高频考点</h3><ol class="list _decimal" id="-2pnfw_87" type="1"><li class="list__item" id="-2pnfw_88"><p id="-2pnfw_93"><span class="control" id="-2pnfw_94">JMM基本概念</span> ：主内存、工作内存、内存交互操作</p></li><li class="list__item" id="-2pnfw_89"><p id="-2pnfw_95"><span class="control" id="-2pnfw_96">可见性问题</span> ：产生原因、解决方案、volatile作用</p></li><li class="list__item" id="-2pnfw_90"><p id="-2pnfw_97"><span class="control" id="-2pnfw_98">happens-before</span> ：八大规则的理解和应用</p></li><li class="list__item" id="-2pnfw_91"><p id="-2pnfw_99"><span class="control" id="-2pnfw_100">重排序机制</span> ：编译器重排序、CPU重排序、内存系统重排序</p></li><li class="list__item" id="-2pnfw_92"><p id="-2pnfw_101"><span class="control" id="-2pnfw_102">volatile应用</span> ：适用场景、局限性、与synchronized区别</p></li></ol></section><section class="chapter"><h3 id="-2pnfw_86" data-toc="-2pnfw_86">回答策略</h3><ol class="list _decimal" id="-2pnfw_103" type="1"><li class="list__item" id="-2pnfw_106"><p id="-2pnfw_110"><span class="control" id="-2pnfw_111">理论结合实例</span> ：用具体代码说明抽象概念</p></li><li class="list__item" id="-2pnfw_107"><p id="-2pnfw_112"><span class="control" id="-2pnfw_113">对比分析</span> ：volatile vs synchronized，可见性 vs 原子性</p></li><li class="list__item" id="-2pnfw_108"><p id="-2pnfw_114"><span class="control" id="-2pnfw_115">场景化应用</span> ：结合实际使用场景说明技术选择</p></li><li class="list__item" id="-2pnfw_109"><p id="-2pnfw_116"><span class="control" id="-2pnfw_117">原理深入</span> ：从底层硬件角度解释JMM设计原理</p></li></ol><p id="-2pnfw_105"><span class="control" id="-2pnfw_118">学习建议</span> ：JMM是Java并发编程的理论基础，需要深入理解其设计原理和应用场景。建议通过实际编程验证可见性问题和happens-before规则，加深对内存模型的理解。重点掌握volatile的正确使用方法和适用场景。</p></section></section><div class="last-modified">09 六月 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="java线程基础qa.html" class="navigation-links__prev">Java线程基础QA</a><a href="java锁机制详解qa.html" class="navigation-links__next">Java锁机制详解QA</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>