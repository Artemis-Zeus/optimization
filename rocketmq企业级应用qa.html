<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-06-10T01:18:25.4917854"><title>RocketMQ企业级应用QA | 技术知识库</title><script type="application/json" id="virtual-toc-data">[{"id":"-gideuy_4","level":0,"title":"📋 知识结构","anchor":"#-gideuy_4"},{"id":"rocketmq","level":0,"title":"🏢 RocketMQ架构设计","anchor":"#rocketmq"},{"id":"-gideuy_6","level":0,"title":"📨 高级消息特性","anchor":"#-gideuy_6"},{"id":"-gideuy_7","level":0,"title":"💡 面试技巧","anchor":"#-gideuy_7"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="RocketMQ企业级应用QA | 技术知识库"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="技术知识库 Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/rocketmq企业级应用qa.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="RocketMQ企业级应用QA | 技术知识库"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/rocketmq企业级应用qa.html#webpage",
    "url": "writerside-documentation/rocketmq企业级应用qa.html",
    "name": "RocketMQ企业级应用QA | 技术知识库",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "技术知识库 Help"
}</script><!-- End Schema.org --></head><body data-id="RocketMQ企业级应用QA" data-main-title="RocketMQ企业级应用QA" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="消息队列面试大纲.md|消息队列面试大纲"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>技术知识库  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="RocketMQ企业级应用QA" id="RocketMQ企业级应用QA.md">RocketMQ企业级应用QA</h1><p id="-gideuy_3">Apache RocketMQ是阿里巴巴开源的分布式消息队列，专为高并发、低延迟、高可用的企业级应用场景设计。本文档深入解析RocketMQ的核心特性和企业级应用实践。</p><section class="chapter"><h2 id="-gideuy_4" data-toc="-gideuy_4">📋 知识结构</h2><svg aria-roledescription="mindmap" role="graphics-document document" viewBox="5 5 828.7893676757812 415.8477478027344" style="max-width: 828.7893676757812px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><g></g><g class="mindmap-edges"><path class="edge section-edge-0 edge-depth-1" d="M 605.2728694082865,167.2623723353259 L 672.1346804744599,187.14900775121603 L738.9964915406332,207.03564316710617"></path><path class="edge section-edge-0 edge-depth-1" d="M 594.2217742359377,148.35956816003772 L 601.4943130981792,116.381810631955 L608.7668519604207,84.4040531038723"></path><path class="edge section-edge-0 edge-depth-1" d="M 605.3884876061544,159.1197245714057 L 674.1573552310679,140.77416597476454 L742.9262228559813,122.42860737812339"></path><path class="edge section-edge-0 edge-depth-1" d="M 576.8490412013729,157.72286205297326 L 522.5894375734608,137.39152134379148 L468.3298339455488,117.06018063460971"></path><path class="edge section-edge-0 edge-depth-0" d="M 413.3553412463956,203.67707374698378 L 494.81489128848887,185.0070835300671 L576.2744413305821,166.3370933131504"></path><path class="edge section-edge-1 edge-depth-1" d="M 480.7227774260043,294.11548999878806 L 532.8012791462131,275.98901694410927 L584.8797808664219,257.8625438894305"></path><path class="edge section-edge-1 edge-depth-1" d="M 481.02939505168865,302.9872211954328 L 538.5019422661343,318.6367981954221 L595.9744894805799,334.2863751954114"></path><path class="edge section-edge-1 edge-depth-1" d="M 454.7301644232059,308.2734604572181 L 419.71921744096505,335.5901938917748 L384.7082704587242,362.90692732633147"></path><path class="edge section-edge-1 edge-depth-1" d="M 470.9718249828585,313.38166063672213 L 480.86372279805346,345.49700544206405 L490.7556206132484,377.61235024740597"></path><path class="edge section-edge-1 edge-depth-0" d="M 407.6340470616539,219.10273102191428 L 432.64539901674345,253.03717491923263 L457.656750971833,286.971618816551"></path><path class="edge section-edge-2 edge-depth-1" d="M 196.28758477522098,265.0993488946826 L 150.03965264663543,290.47977383165573 L103.79172051804987,315.8601987686289"></path><path class="edge section-edge-2 edge-depth-1" d="M 211.3973641481639,272.75419971682584 L 215.5419273769025,304.20362304890136 L219.6864906056411,335.6530463809769"></path><path class="edge section-edge-2 edge-depth-1" d="M 194.67389543248154,255.23042846877448 L 133.73676659962382,244.28280142058617 L72.7996377667661,233.3351743723979"></path><path class="edge section-edge-2 edge-depth-1" d="M 224.20819700618122,260.4957326981243 L 278.08928348052547,270.0273713533213 L331.97036995486974,279.5590100085183"></path><path class="edge section-edge-2 edge-depth-0" d="M 384.2480968173083,210.91984994632116 L 304.08598771918565,232.45543463136892 L223.923878621063,253.99101931641673"></path><path class="edge section-edge-3 edge-depth-1" d="M 318.5668936140421,113.55585104747848 L 347.0039405726225,84.94184148698875 L375.44098753120295,56.327831926499016"></path><path class="edge section-edge-3 edge-depth-1" d="M 301.4719931892805,110.68703338977966 L 286.19776961722823,79.04765072182506 L270.92354604517595,47.408268053870486"></path><path class="edge section-edge-3 edge-depth-1" d="M 293.39105372392174,120.76367218952998 L 236.29088219879787,107.34468272384535 L179.190710673674,93.92569325816072"></path><path class="edge section-edge-3 edge-depth-1" d="M 293.902470090306,129.33827037361658 L 241.5303224646641,148.45349825751148 L189.1581748390222,167.5687261414064"></path><path class="edge section-edge-3 edge-depth-0" d="M 387.65607259277766,196.91523696252534 L 353.3638420804162,165.61169436150817 L319.0716115680547,134.30815176049106"></path></g><g class="mindmap-nodes"><g transform="translate(320.8641565030397, 188.12808727936624)" class="mindmap-node section--1 section-root"><g transform="translate(77.87028503417969, 18.9)"><circle r="77.87028503417969" class="node-bkg node-circle" id="node-0"></circle></g><g transform="translate(77.87028503417969, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">RocketMQ企业特性</tspan></tspan></text></g></g></g><g transform="translate(547.8593417416627, 144.08607978076793)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-1"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">架构设计</tspan></tspan></text></g></g></g><g transform="translate(423.52035719817184, 280.146262559099)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-6"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">消息特性</tspan></tspan></text></g></g></g><g transform="translate(158.88953356545858, 238.9827819833716)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h91.09600067138672 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-11"></path><line y2="37.8" x2="101.09600067138672" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(50.54800033569336, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">可靠性保证</tspan></tspan></text></g></g></g><g transform="translate(265.4572433255173, 105.29530144365015)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-16"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">运维管理</tspan></tspan></text></g></g></g><g transform="translate(683.7185824396789, 192.41193572166412)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h129.31087493896484 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-2"></path><line y2="37.8" x2="139.31087493896484" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(69.65543746948242, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">NameServer集群</tspan></tspan></text></g></g></g><g transform="translate(562.071785522811, 50.877541483142075)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h90.04299926757812 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-3"></path><line y2="37.8" x2="100.04299926757812" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(50.02149963378906, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Broker集群</tspan></tspan></text></g></g></g><g transform="translate(691.0493666757953, 99.66225216876114)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h122.74000549316406 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-4"></path><line y2="37.8" x2="132.74000549316406" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(66.37000274658203, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Producer客户端</tspan></tspan></text></g></g></g><g transform="translate(384.49165636058126, 92.89696290681502)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h129.58375549316406 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-5"></path><line y2="37.8" x2="139.58375549316406" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(69.79187774658203, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Consumer客户端</tspan></tspan></text></g></g></g><g transform="translate(556.510202498063, 234.03177132911958)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-7"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">事务消息</tspan></tspan></text></g></g></g><g transform="translate(567.4115287379053, 319.32733383174525)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-8"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">顺序消息</tspan></tspan></text></g></g></g><g transform="translate(330.34607908756686, 353.2341252244506)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-9"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">延迟消息</tspan></tspan></text></g></g></g><g transform="translate(452.1350898017437, 373.04774832502915)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-10"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">批量消息</tspan></tspan></text></g></g></g><g transform="translate(48.587083892118926, 304.1767656799399)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h74.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-12"></path><line y2="37.8" x2="84.109375" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.0546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">同步复制</tspan></tspan></text></g></g></g><g transform="translate(179.59163335265305, 331.62446411443113)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h74.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-13"></path><line y2="37.8" x2="84.109375" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.0546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">异步复制</tspan></tspan></text></g></g></g><g transform="translate(15, 211.78282085780074)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-14"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">刷盘策略</tspan></tspan></text></g></g></g><g transform="translate(304.2050337618033, 263.27196072327104)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-15"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">故障恢复</tspan></tspan></text></g></g></g><g transform="translate(342.97863922353633, 26.788381530327342)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-17"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">集群部署</tspan></tspan></text></g></g></g><g transform="translate(221.86629731274775, 15)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-18"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">监控告警</tspan></tspan></text></g></g></g><g transform="translate(122.03383427398273, 71.59406400404055)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-19"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">性能调优</tspan></tspan></text></g></g></g><g transform="translate(132.51271480571518, 153.8116950713728)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-20"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">容量规划</tspan></tspan></text></g></g></g></g></svg></section><section class="chapter"><h2 id="rocketmq" data-toc="rocketmq">🏢 RocketMQ架构设计</h2><section class="chapter"><h3 id="q1-rocketmq-kafka" data-toc="q1-rocketmq-kafka">Q1: RocketMQ的整体架构是怎样的？与Kafka相比有什么特点？</h3><p id="-gideuy_11"><span class="control" id="-gideuy_18">答案：</span></p><p id="-gideuy_12"><span class="control" id="-gideuy_19">RocketMQ架构图：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1277.640625 950"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1277.640625" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="RocketMQ集群架构" class="cluster"><rect height="934" width="1261.640625" y="8" x="8" style=""></rect><g transform="translate(571.4375, 8)" class="cluster-label"><foreignObject height="24" width="134.765625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>RocketMQ集群架构</p></span></div></foreignObject></g></g><g data-look="classic" id="客户端" class="cluster"><rect height="300" width="1186.640625" y="28" x="45.5" style=""></rect><g transform="translate(614.78125, 28)" class="cluster-label"><foreignObject height="24" width="48.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>客户端</p></span></div></foreignObject></g></g><g data-look="classic" id="Broker集群" class="cluster"><rect height="406" width="936.125" y="516" x="296.015625" style=""></rect><g transform="translate(724.5390625, 516)" class="cluster-label"><foreignObject height="24" width="79.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker集群</p></span></div></foreignObject></g></g><g data-look="classic" id="NameServer集群" class="cluster"><rect height="148" width="936.125" y="348" x="296.015625" style=""></rect><g transform="translate(704.90625, 348)" class="cluster-label"><foreignObject height="24" width="118.34375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>NameServer集群</p></span></div></foreignObject></g></g><g data-look="classic" id="Broker-Master-2" class="cluster"><rect height="188" width="555.515625" y="714" x="333.515625" style=""></rect><g transform="translate(553.8203125, 714)" class="cluster-label"><foreignObject height="24" width="114.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker-Master-2</p></span></div></foreignObject></g></g><g data-look="classic" id="Broker-Master-1" class="cluster"><rect height="158" width="573.71875" y="536" x="620.921875" style=""></rect><g transform="translate(850.328125, 536)" class="cluster-label"><foreignObject height="24" width="114.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker-Master-1</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_BM1_BS1_0" d="M842.43,616.524L850.197,617.103C857.964,617.682,873.497,618.841,887.514,619.421C901.531,620,914.031,620,924.588,620C935.145,620,943.758,620,951.704,620C959.651,620,966.931,620,970.571,620L974.211,620"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_BM2_BS2_1" d="M545.922,821.998L552.172,822.998C558.422,823.998,570.922,825.999,583.422,827C595.922,828,608.422,828,618.979,828C629.535,828,638.148,828,646.095,828C654.042,828,661.322,828,664.962,828L668.602,828"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_NS1_2" d="M220.477,117L226.817,119.5C233.157,122,245.836,127,258.426,129.5C271.016,132,283.516,132,296.016,132C308.516,132,321.016,132,336.278,152.917C351.54,173.833,369.565,215.667,387.326,256.888C405.087,298.109,422.585,338.718,431.333,359.022L440.082,379.326"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_NS2_3" d="M221.016,200.479L227.266,201.066C233.516,201.653,246.016,202.826,258.516,203.413C271.016,204,283.516,204,296.016,204C308.516,204,321.016,204,348.091,204C375.167,204,416.818,204,458.469,204C500.12,204,541.771,204,568.846,204C595.922,204,608.422,204,637.014,204C665.607,204,710.292,204,754.977,204C799.661,204,844.346,204,872.939,204C901.531,204,914.031,204,929.454,218.917C944.877,233.833,963.222,263.667,981.218,292.932C999.214,322.198,1016.861,350.895,1025.685,365.244L1034.508,379.593"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C1_NS1_4" d="M1043.513,210L1024.016,240.833C1004.519,271.667,965.525,333.333,939.778,364.167C914.031,395,901.531,395,872.939,395C844.346,395,799.661,395,754.977,395C710.292,395,665.607,395,637.014,395C608.422,395,595.922,395,585.951,395.804C575.98,396.608,568.539,398.216,561.749,399.683C554.96,401.15,548.821,402.477,545.752,403.14L542.683,403.803"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C2_NS2_5" d="M851.531,266L857.781,266C864.031,266,876.531,266,889.031,266C901.531,266,914.031,266,928.66,275.75C943.288,285.5,960.045,305,976.367,323.994C992.69,342.989,1008.577,361.477,1016.521,370.722L1024.465,379.966"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_NS1_BM1_6" d="M538.773,439.352L546.215,440.96C553.656,442.568,568.539,445.784,582.23,447.392C595.922,449,608.422,449,623.137,459.167C637.852,469.333,654.782,489.667,671.286,509.488C687.79,529.309,703.867,548.617,711.906,558.272L719.944,567.926"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_NS2_BM2_7" d="M1044.839,461L1025.121,509.833C1005.403,558.667,965.967,656.333,939.999,705.167C914.031,754,901.531,754,872.939,754C844.346,754,799.661,754,754.977,754C710.292,754,665.607,754,637.014,754C608.422,754,595.922,754,586.547,755.351C577.172,756.701,570.922,759.402,565.284,761.839C559.646,764.275,554.62,766.447,552.107,767.533L549.594,768.619"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_BM1_8" d="M221.016,76.394L227.266,75.162C233.516,73.929,246.016,71.465,258.516,70.232C271.016,69,283.516,69,296.016,69C308.516,69,321.016,69,348.091,69C375.167,69,416.818,69,458.469,69C500.12,69,541.771,69,568.846,69C595.922,69,608.422,69,625.038,110.833C641.654,152.667,662.385,236.333,682.957,319.353C703.528,402.372,723.94,484.745,734.145,525.931L744.351,567.117"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_BM2_9" d="M220.477,167L226.817,164.5C233.157,162,245.836,157,258.426,154.5C271.016,152,283.516,152,296.016,152C308.516,152,321.016,152,337.059,203.417C353.103,254.833,372.69,357.667,392.153,459.845C411.616,562.024,430.954,663.547,440.623,714.309L450.292,765.071"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_BM1_C1_10" d="M842.43,592.386L850.197,590.822C857.964,589.257,873.497,586.129,887.514,584.564C901.531,583,914.031,583,930.698,551.917C947.366,520.833,968.2,458.667,988.822,397.132C1009.445,335.598,1029.856,274.695,1040.061,244.244L1050.266,213.793"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_BM2_C2_11" d="M545.922,801.001L552.172,800.501C558.422,800.001,570.922,799,583.422,798.5C595.922,798,608.422,798,625.276,755.917C642.13,713.833,663.339,629.667,684.385,546.146C705.43,462.626,726.313,379.753,736.754,338.316L747.196,296.879"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(152.0078125, 90)" id="flowchart-P1-9109" class="node default"><rect height="54" width="138.015625" y="-27" x="-69.0078125" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-39.0078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="78.015625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Producer-1</p></span></div></foreignObject></g></g><g transform="translate(754.9765625, 610)" id="flowchart-BM1-9105" class="node default"><rect height="78" width="174.90625" y="-39" x="-87.453125" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-57.453125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="114.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker-Master-1<br>读写服务</p></span></div></foreignObject></g></g><g transform="translate(1060.5859375, 620)" id="flowchart-BS1-9106" class="node default"><rect height="78" width="164.75" y="-39" x="-82.375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-52.375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="104.75"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker-Slave-1<br>只读备份</p></span></div></foreignObject></g></g><g transform="translate(458.46875, 808)" id="flowchart-BM2-9107" class="node default"><rect height="78" width="174.90625" y="-39" x="-87.453125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-57.453125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="114.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker-Master-2<br>读写服务</p></span></div></foreignObject></g></g><g transform="translate(754.9765625, 828)" id="flowchart-BS2-9108" class="node default"><rect height="78" width="164.75" y="-39" x="-82.375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-52.375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="104.75"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker-Slave-2<br>只读备份</p></span></div></foreignObject></g></g><g transform="translate(458.46875, 422)" id="flowchart-NS1-9103" class="node default"><rect height="78" width="160.609375" y="-39" x="-80.3046875" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-50.3046875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="100.609375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>NameServer-1<br>路由注册中心</p></span></div></foreignObject></g></g><g transform="translate(152.0078125, 194)" id="flowchart-P2-9110" class="node default"><rect height="54" width="138.015625" y="-27" x="-69.0078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-39.0078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="78.015625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Producer-2</p></span></div></foreignObject></g></g><g transform="translate(1060.5859375, 422)" id="flowchart-NS2-9104" class="node default"><rect height="78" width="160.609375" y="-39" x="-80.3046875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-50.3046875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="100.609375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>NameServer-2<br>路由注册中心</p></span></div></foreignObject></g></g><g transform="translate(1060.5859375, 183)" id="flowchart-C1-9111" class="node default"><rect height="54" width="193.109375" y="-27" x="-96.5546875" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-66.5546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="133.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Consumer Group-1</p></span></div></foreignObject></g></g><g transform="translate(754.9765625, 266)" id="flowchart-C2-9112" class="node default"><rect height="54" width="193.109375" y="-27" x="-96.5546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-66.5546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="133.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Consumer Group-2</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-gideuy_14"><span class="control" id="-gideuy_20">RocketMQ vs Kafka核心对比：</span></p><div class="table-wrapper"><table class="wide" id="-gideuy_15"><thead><tr class="ijRowHead" id="-gideuy_21"><th id="-gideuy_30"><p>特性</p></th><th id="-gideuy_31"><p>RocketMQ</p></th><th id="-gideuy_32"><p>Kafka</p></th></tr></thead><tbody><tr id="-gideuy_22"><td id="-gideuy_33"><p><span class="control" id="-gideuy_36">注册中心</span></p></td><td id="-gideuy_34"><p>NameServer（轻量级）</p></td><td id="-gideuy_35"><p>ZooKeeper（重量级）</p></td></tr><tr id="-gideuy_23"><td id="-gideuy_37"><p><span class="control" id="-gideuy_40">消息拉取</span></p></td><td id="-gideuy_38"><p>长轮询</p></td><td id="-gideuy_39"><p>短轮询</p></td></tr><tr id="-gideuy_24"><td id="-gideuy_41"><p><span class="control" id="-gideuy_44">消息过滤</span></p></td><td id="-gideuy_42"><p>支持Tag和SQL过滤</p></td><td id="-gideuy_43"><p>不支持Broker端过滤</p></td></tr><tr id="-gideuy_25"><td id="-gideuy_45"><p><span class="control" id="-gideuy_48">事务消息</span></p></td><td id="-gideuy_46"><p>原生支持</p></td><td id="-gideuy_47"><p>不支持</p></td></tr><tr id="-gideuy_26"><td id="-gideuy_49"><p><span class="control" id="-gideuy_52">延迟消息</span></p></td><td id="-gideuy_50"><p>原生支持</p></td><td id="-gideuy_51"><p>不支持</p></td></tr><tr id="-gideuy_27"><td id="-gideuy_53"><p><span class="control" id="-gideuy_56">顺序消息</span></p></td><td id="-gideuy_54"><p>支持</p></td><td id="-gideuy_55"><p>支持</p></td></tr><tr id="-gideuy_28"><td id="-gideuy_57"><p><span class="control" id="-gideuy_60">死信队列</span></p></td><td id="-gideuy_58"><p>原生支持</p></td><td id="-gideuy_59"><p>需要自行实现</p></td></tr><tr id="-gideuy_29"><td id="-gideuy_61"><p><span class="control" id="-gideuy_64">回溯消费</span></p></td><td id="-gideuy_62"><p>支持按时间回溯</p></td><td id="-gideuy_63"><p>支持按Offset回溯</p></td></tr></tbody></table></div><p id="-gideuy_16"><span class="control" id="-gideuy_65">RocketMQ核心特性：</span></p><div class="code-block" data-lang="java">
// RocketMQ基础使用示例
public class RocketMQBasicExample {
    
    // 生产者配置
    public DefaultMQProducer createProducer() {
        DefaultMQProducer producer = new DefaultMQProducer(&quot;producer_group&quot;);
        producer.setNamesrvAddr(&quot;localhost:9876&quot;);
        producer.setRetryTimesWhenSendFailed(3);
        producer.setRetryTimesWhenSendAsyncFailed(3);
        producer.setMaxMessageSize(4 * 1024 * 1024); // 4MB
        
        return producer;
    }
    
    // 消费者配置
    public DefaultMQPushConsumer createConsumer() {
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;consumer_group&quot;);
        consumer.setNamesrvAddr(&quot;localhost:9876&quot;);
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);
        consumer.setConsumeMessageBatchMaxSize(10);
        consumer.setConsumeThreadMin(20);
        consumer.setConsumeThreadMax(64);
        
        return consumer;
    }
    
    // 发送普通消息
    public void sendNormalMessage() throws Exception {
        DefaultMQProducer producer = createProducer();
        producer.start();
        
        try {
            Message message = new Message(
                &quot;TopicTest&quot;,    // Topic
                &quot;TagA&quot;,         // Tag
                &quot;OrderID001&quot;,   // Key
                &quot;Hello RocketMQ&quot;.getBytes(RemotingHelper.DEFAULT_CHARSET)
            );
            
            SendResult result = producer.send(message);
            System.out.printf(&quot;SendResult: %s%n&quot;, result);
            
        } finally {
            producer.shutdown();
        }
    }
    
    // 消费普通消息
    public void consumeNormalMessage() throws Exception {
        DefaultMQPushConsumer consumer = createConsumer();
        
        // 订阅Topic和Tag
        consumer.subscribe(&quot;TopicTest&quot;, &quot;*&quot;);
        
        // 注册消息监听器
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(
                List&lt;MessageExt&gt; messages,
                ConsumeConcurrentlyContext context) {
                
                for (MessageExt message : messages) {
                    System.out.printf(&quot;Receive Message: %s %n&quot;, new String(message.getBody()));
                    
                    try {
                        // 处理业务逻辑
                        processMessage(message);
                        
                    } catch (Exception e) {
                        System.err.println(&quot;消息处理失败: &quot; + e.getMessage());
                        // 返回稍后再试，消息会重新投递
                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;
                    }
                }
                
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
        
        consumer.start();
        System.out.println(&quot;Consumer Started.&quot;);
    }
}
</div></section><section class="chapter"><h3 id="q2-rocketmq" data-toc="q2-rocketmq">Q2: RocketMQ的事务消息是如何实现的？与传统分布式事务有什么区别？</h3><p id="-gideuy_66"><span class="control" id="-gideuy_74">答案：</span></p><p id="-gideuy_67"><span class="control" id="-gideuy_75">RocketMQ事务消息流程：</span></p><svg aria-roledescription="sequence" role="graphics-document document" viewBox="-50 -10 931 993" style="max-width: 931px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><g><rect class="actor actor-bottom" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="907" x="681"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="939.5" x="756"><tspan dy="0" x="756">Consumer</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="B" height="65" width="150" stroke="#666" fill="#eaeaea" y="907" x="457"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="939.5" x="532"><tspan dy="0" x="532">Broker</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P" height="65" width="150" stroke="#666" fill="#eaeaea" y="907" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="939.5" x="275"><tspan dy="0" x="275">Producer</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="App" height="65" width="150" stroke="#666" fill="#eaeaea" y="907" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="939.5" x="75"><tspan dy="0" x="75">应用程序</tspan></text></g><g><line name="C" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="907" x2="756" y1="5" x1="756" id="actor300"></line><g id="root-300"><rect class="actor actor-top" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="681"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="756"><tspan dy="0" x="756">Consumer</tspan></text></g></g><g><line name="B" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="907" x2="532" y1="5" x1="532" id="actor299"></line><g id="root-299"><rect class="actor actor-top" ry="3" rx="3" name="B" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="457"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="532"><tspan dy="0" x="532">Broker</tspan></text></g></g><g><line name="P" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="907" x2="275" y1="5" x1="275" id="actor298"></line><g id="root-298"><rect class="actor actor-top" ry="3" rx="3" name="P" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">Producer</tspan></text></g></g><g><line name="App" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="907" x2="75" y1="5" x1="75" id="actor297"></line><g id="root-297"><rect class="actor actor-top" ry="3" rx="3" name="App" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">应用程序</tspan></text></g></g><g></g><defs><symbol height="24" width="24" id="computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="7.9" id="arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refY="4.5" refX="4" orient="auto" markerHeight="8" markerWidth="15" id="crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="15.5" id="filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="40" markerWidth="60" refY="15" refX="15" id="sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="150" stroke="#666" fill="#EDF2AE" y="597" x="457"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="602" x="532"><tspan x="532">Half消息被删除</tspan></text></g><g><line class="loopLine" y2="267" x2="767" y1="267" x1="64"></line><line class="loopLine" y2="646" x2="767" y1="267" x1="767"></line><line class="loopLine" y2="646" x2="767" y1="646" x1="64"></line><line class="loopLine" y2="646" x2="64" y1="267" x1="64"></line><line style="stroke-dasharray: 3, 3;" class="loopLine" y2="461" x2="767" y1="461" x1="64"></line><polygon class="labelBox" points="64,267 114,267 114,280 105.6,287 64,287"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="280" x="89">alt</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="285" x="440.5"><tspan x="440.5">[本地事务成功]</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="479" x="415.5">[本地事务失败]</text></g><g><rect class="note" height="39" width="150" stroke="#666" fill="#EDF2AE" y="656" x="457"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="661" x="532"><tspan x="532">定时回查机制</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="174">1. 发送Half消息</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="113" x2="271" y1="113" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="128" x="402">2. 存储Half消息</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="161" x2="528" y1="161" x1="276"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="176" x="405">3. 返回发送结果</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="209" x2="279" y1="209" x1="531"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="224" x="177">4. 执行本地事务</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="257" x2="79" y1="257" x1="274"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="317" x="174">5a. 提交事务</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="350" x2="271" y1="350" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="365" x="402">6a. Commit消息</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="398" x2="528" y1="398" x1="276"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="413" x="643">7a. 投递消息给消费者</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="446" x2="752" y1="446" x1="533"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="506" x="174">5b. 回滚事务</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="539" x2="271" y1="539" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="554" x="402">6b. Rollback消息</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="587" x2="528" y1="587" x1="276"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="710" x="405">8. 回查本地事务状态</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="743" x2="279" y1="743" x1="531"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="758" x="177">9. 检查本地事务</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="791" x2="79" y1="791" x1="274"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="806" x="174">10. 返回事务状态</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="839" x2="271" y1="839" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="854" x="402">11. 确认Commit/Rollback</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="887" x2="528" y1="887" x1="276"></line></svg><p id="-gideuy_69"><span class="control" id="-gideuy_76">事务消息实现：</span></p><div class="code-block" data-lang="java">
// RocketMQ事务消息实现
public class TransactionMessageExample {
    
    // 事务消息生产者
    public void sendTransactionMessage() throws Exception {
        // 创建事务消息生产者
        TransactionMQProducer producer = new TransactionMQProducer(&quot;transaction_producer_group&quot;);
        producer.setNamesrvAddr(&quot;localhost:9876&quot;);
        
        // 设置事务监听器
        producer.setTransactionListener(new TransactionListenerImpl());
        
        // 设置线程池（用于执行本地事务和回查）
        ExecutorService executorService = new ThreadPoolExecutor(
            2, 5, 100, TimeUnit.SECONDS,
            new ArrayBlockingQueue&lt;&gt;(2000),
            r -&gt; {
                Thread thread = new Thread(r);
                thread.setName(&quot;client-transaction-msg-check-thread&quot;);
                return thread;
            }
        );
        producer.setExecutorService(executorService);
        
        producer.start();
        
        try {
            // 发送事务消息
            Message message = new Message(
                &quot;TransactionTopic&quot;,
                &quot;TagA&quot;, 
                &quot;OrderID002&quot;,
                &quot;Transaction Message Content&quot;.getBytes(RemotingHelper.DEFAULT_CHARSET)
            );
            
            // 发送事务消息（本地事务参数）
            TransactionSendResult result = producer.sendMessageInTransaction(
                message, 
                new OrderTransactionContext(&quot;ORDER123&quot;, 1000) // 本地事务上下文
            );
            
            System.out.printf(&quot;Transaction SendResult: %s%n&quot;, result);
            
        } finally {
            Thread.sleep(1000);
            producer.shutdown();
        }
    }
    
    // 事务监听器实现
    public static class TransactionListenerImpl implements TransactionListener {
        
        // 执行本地事务
        @Override
        public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
            System.out.println(&quot;执行本地事务&quot;);
            
            try {
                OrderTransactionContext context = (OrderTransactionContext) arg;
                
                // 执行本地业务逻辑
                boolean success = processLocalTransaction(context);
                
                if (success) {
                    System.out.println(&quot;本地事务执行成功&quot;);
                    return LocalTransactionState.COMMIT_MESSAGE;
                } else {
                    System.out.println(&quot;本地事务执行失败&quot;);
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                }
                
            } catch (Exception e) {
                System.err.println(&quot;本地事务执行异常: &quot; + e.getMessage());
                return LocalTransactionState.UNKNOW; // 未知状态，等待回查
            }
        }
        
        // 回查本地事务状态
        @Override
        public LocalTransactionState checkLocalTransaction(MessageExt msg) {
            System.out.println(&quot;回查本地事务状态&quot;);
            
            try {
                String orderId = msg.getKeys();
                
                // 查询本地事务状态
                LocalTransactionState state = checkLocalTransactionStatus(orderId);
                
                System.out.println(&quot;回查结果: &quot; + state);
                return state;
                
            } catch (Exception e) {
                System.err.println(&quot;回查本地事务异常: &quot; + e.getMessage());
                return LocalTransactionState.UNKNOW;
            }
        }
        
        // 模拟本地事务处理
        private boolean processLocalTransaction(OrderTransactionContext context) {
            // 1. 数据库事务开始
            // 2. 执行订单创建
            // 3. 执行库存扣减
            // 4. 执行账户扣款
            // 5. 提交/回滚数据库事务
            
            System.out.println(&quot;处理订单: &quot; + context.getOrderId() + &quot;, 金额: &quot; + context.getAmount());
            
            // 模拟处理结果
            return context.getAmount() &gt; 0;
        }
        
        // 模拟本地事务状态查询
        private LocalTransactionState checkLocalTransactionStatus(String orderId) {
            // 查询数据库中的订单状态
            // 根据订单状态返回相应的事务状态
            
            // 模拟查询结果
            if (orderId != null &amp;&amp; orderId.contains(&quot;ORDER&quot;)) {
                return LocalTransactionState.COMMIT_MESSAGE;
            } else {
                return LocalTransactionState.ROLLBACK_MESSAGE;
            }
        }
    }
    
    // 事务上下文
    public static class OrderTransactionContext {
        private String orderId;
        private int amount;
        
        public OrderTransactionContext(String orderId, int amount) {
            this.orderId = orderId;
            this.amount = amount;
        }
        
        // getters and setters
        public String getOrderId() { return orderId; }
        public int getAmount() { return amount; }
    }
}
</div><p id="-gideuy_71"><span class="control" id="-gideuy_77">与传统分布式事务的区别：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1825.03125 164"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1825.03125" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="RocketMQ事务消息" class="cluster"><rect height="148" width="870.28125" y="8" x="8" style=""></rect><g transform="translate(375.7578125, 8)" class="cluster-label"><foreignObject height="24" width="134.765625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>RocketMQ事务消息</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B1_B2_3" d="M167.156,82L173.406,82C179.656,82,192.156,82,201.531,82C210.906,82,217.156,82,222.74,82C228.323,82,233.24,82,235.698,82L238.156,82"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B2_B3_4" d="M366.266,82L372.516,82C378.766,82,391.266,82,400.641,82C410.016,82,416.266,82,421.849,82C427.432,82,432.349,82,434.807,82L437.266,82"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B3_B4_5" d="M625.656,82L631.906,82C638.156,82,650.656,82,660.031,82C669.406,82,675.656,82,681.24,82C686.823,82,691.74,82,694.198,82L696.656,82"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(106.328125, 82)" id="flowchart-B1-9400" class="node default"><rect height="54" width="121.65625" y="-27" x="-60.828125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-30.828125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="61.65625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Half消息</p></span></div></foreignObject></g></g><g transform="translate(304.2109375, 82)" id="flowchart-B2-9401" class="node default"><rect height="78" width="124.109375" y="-39" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>本地事务<br>Execute</p></span></div></foreignObject></g></g><g transform="translate(533.4609375, 82)" id="flowchart-B3-9403" class="node default"><rect height="78" width="184.390625" y="-39" x="-92.1953125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-62.1953125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="124.390625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>异步确认<br>Commit/Rollback</p></span></div></foreignObject></g></g><g transform="translate(770.71875, 82)" id="flowchart-B4-9405" class="node default"><rect height="78" width="140.125" y="-39" x="-70.0625" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-40.0625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>最终一致性<br>性能开销小</p></span></div></foreignObject></g></g></g></g><g transform="translate(920.28125, 0)" class="root"><g class="clusters"><g data-look="classic" id="传统2PC分布式事务" class="cluster"><rect height="148" width="888.75" y="8" x="8" style=""></rect><g transform="translate(382.8125, 8)" class="cluster-label"><foreignObject height="24" width="139.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>传统2PC分布式事务</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A1_A2_0" d="M185.625,82L191.875,82C198.125,82,210.625,82,220,82C229.375,82,235.625,82,241.208,82C246.792,82,251.708,82,254.167,82L256.625,82"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A2_A3_1" d="M384.734,82L390.984,82C397.234,82,409.734,82,419.109,82C428.484,82,434.734,82,440.318,82C445.901,82,450.818,82,453.276,82L455.734,82"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A3_A4_2" d="M644.125,82L650.375,82C656.625,82,669.125,82,678.5,82C687.875,82,694.125,82,699.708,82C705.292,82,710.208,82,712.667,82L715.125,82"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(115.5625, 82)" id="flowchart-A1-9394" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>事务管理器</p></span></div></foreignObject></g></g><g transform="translate(322.6796875, 82)" id="flowchart-A2-9395" class="node default"><rect height="78" width="124.109375" y="-39" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>准备阶段<br>Prepare</p></span></div></foreignObject></g></g><g transform="translate(551.9296875, 82)" id="flowchart-A3-9397" class="node default"><rect height="78" width="184.390625" y="-39" x="-92.1953125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-62.1953125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="124.390625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>提交阶段<br>Commit/Rollback</p></span></div></foreignObject></g></g><g transform="translate(789.1875, 82)" id="flowchart-A4-9399" class="node default"><rect height="78" width="140.125" y="-39" x="-70.0625" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-40.0625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>同步等待<br>性能开销大</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><div class="table-wrapper"><table class="wide" id="-gideuy_73"><thead><tr class="ijRowHead" id="-gideuy_78"><th id="-gideuy_84"><p>特性</p></th><th id="-gideuy_85"><p>传统2PC</p></th><th id="-gideuy_86"><p>RocketMQ事务消息</p></th></tr></thead><tbody><tr id="-gideuy_79"><td id="-gideuy_87"><p><span class="control" id="-gideuy_90">一致性类型</span></p></td><td id="-gideuy_88"><p>强一致性</p></td><td id="-gideuy_89"><p>最终一致性</p></td></tr><tr id="-gideuy_80"><td id="-gideuy_91"><p><span class="control" id="-gideuy_94">性能开销</span></p></td><td id="-gideuy_92"><p>高（同步等待）</p></td><td id="-gideuy_93"><p>低（异步处理）</p></td></tr><tr id="-gideuy_81"><td id="-gideuy_95"><p><span class="control" id="-gideuy_98">可用性</span></p></td><td id="-gideuy_96"><p>低（阻塞等待）</p></td><td id="-gideuy_97"><p>高（非阻塞）</p></td></tr><tr id="-gideuy_82"><td id="-gideuy_99"><p><span class="control" id="-gideuy_102">适用场景</span></p></td><td id="-gideuy_100"><p>金融核心交易</p></td><td id="-gideuy_101"><p>业务解耦和异步处理</p></td></tr><tr id="-gideuy_83"><td id="-gideuy_103"><p><span class="control" id="-gideuy_106">实现复杂度</span></p></td><td id="-gideuy_104"><p>高</p></td><td id="-gideuy_105"><p>中等</p></td></tr></tbody></table></div></section></section><section class="chapter"><h2 id="-gideuy_6" data-toc="-gideuy_6">📨 高级消息特性</h2><section class="chapter"><h3 id="q3-rocketmq" data-toc="q3-rocketmq">Q3: RocketMQ如何实现顺序消息？有哪些应用场景？</h3><p id="-gideuy_109"><span class="control" id="-gideuy_116">答案：</span></p><p id="-gideuy_110"><span class="control" id="-gideuy_117">顺序消息实现原理：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1384.3125 536"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1384.3125" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="分区顺序消息" class="cluster"><rect height="520" width="669.09375" y="8" x="8" style=""></rect><g transform="translate(294.46875, 8)" class="cluster-label"><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分区顺序消息</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B1_B2_2" d="M164.909,171L178.846,156.167C192.783,141.333,220.657,111.667,237.725,96.833C254.793,82,261.055,82,266.65,82C272.245,82,277.173,82,279.637,82L282.102,82"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B1_B3_3" d="M211.031,210L217.281,210C223.531,210,236.031,210,245.428,210C254.824,210,261.117,210,266.743,210C272.37,210,277.329,210,279.809,210L282.289,210"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B1_B4_4" d="M164.909,249L178.846,263.833C192.783,278.667,220.657,308.333,237.719,323.167C254.781,338,261.031,338,266.615,338C272.198,338,277.115,338,279.573,338L282.031,338"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B2_B5_5" d="M419.664,82L425.926,82C432.188,82,444.711,82,454.098,82C463.484,82,469.734,82,475.318,82C480.901,82,485.818,82,488.276,82L490.734,82"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B3_B6_6" d="M419.477,210L425.77,210C432.063,210,444.648,210,454.066,210C463.484,210,469.734,210,475.318,210C480.901,210,485.818,210,488.276,210L490.734,210"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B4_B7_7" d="M419.734,338L425.984,338C432.234,338,444.734,338,454.109,338C463.484,338,469.734,338,475.318,338C480.901,338,485.818,338,488.276,338L490.734,338"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(128.265625, 210)" id="flowchart-B1-9540" class="node default"><rect height="78" width="165.53125" y="-39" x="-82.765625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-52.765625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="105.53125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Producer<br>按业务Key分区</p></span></div></foreignObject></g></g><g transform="translate(352.8828125, 82)" id="flowchart-B2-9541" class="node default"><rect height="78" width="133.5625" y="-39" x="-66.78125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-36.78125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="73.5625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Queue-0<br>订单A相关</p></span></div></foreignObject></g></g><g transform="translate(352.8828125, 210)" id="flowchart-B3-9543" class="node default"><rect height="78" width="133.1875" y="-39" x="-66.59375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-36.59375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="73.1875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Queue-1<br>订单B相关</p></span></div></foreignObject></g></g><g transform="translate(352.8828125, 338)" id="flowchart-B4-9545" class="node default"><rect height="78" width="133.703125" y="-39" x="-66.8515625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-36.8515625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="73.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Queue-2<br>订单C相关</p></span></div></foreignObject></g></g><g transform="translate(567.1640625, 82)" id="flowchart-B5-9547" class="node default"><rect height="54" width="144.859375" y="-27" x="-72.4296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-42.4296875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="84.859375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Consumer-0</p></span></div></foreignObject></g></g><g transform="translate(567.1640625, 210)" id="flowchart-B6-9549" class="node default"><rect height="54" width="144.859375" y="-27" x="-72.4296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-42.4296875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="84.859375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Consumer-1</p></span></div></foreignObject></g></g><g transform="translate(567.1640625, 338)" id="flowchart-B7-9551" class="node default"><rect height="54" width="144.859375" y="-27" x="-72.4296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-42.4296875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="84.859375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Consumer-2</p></span></div></foreignObject></g></g><g transform="translate(567.1640625, 454)" id="flowchart-B8-9552" class="node default"><rect height="78" width="124.109375" y="-39" x="-62.0546875" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>高性能<br>局部有序</p></span></div></foreignObject></g></g></g></g><g transform="translate(719.09375, 134)" class="root"><g class="clusters"><g data-look="classic" id="全局顺序消息" class="cluster"><rect height="252" width="649.21875" y="8" x="8" style=""></rect><g transform="translate(284.53125, 8)" class="cluster-label"><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>全局顺序消息</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A1_A2_0" d="M169.203,70L175.453,70C181.703,70,194.203,70,203.578,70C212.953,70,219.203,70,224.786,70C230.37,70,235.286,70,237.745,70L240.203,70"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A2_A3_1" d="M382.125,70L388.375,70C394.625,70,407.125,70,416.5,70C425.875,70,432.125,70,437.708,70C443.292,70,448.208,70,450.667,70L453.125,70"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(107.3515625, 70)" id="flowchart-A1-9535" class="node default"><rect height="54" width="123.703125" y="-27" x="-61.8515625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-31.8515625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="63.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Producer</p></span></div></foreignObject></g></g><g transform="translate(313.1640625, 70)" id="flowchart-A2-9536" class="node default"><rect height="54" width="137.921875" y="-27" x="-68.9609375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-38.9609375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="77.921875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>单一Queue</p></span></div></foreignObject></g></g><g transform="translate(538.421875, 70)" id="flowchart-A3-9538" class="node default"><rect height="54" width="162.59375" y="-27" x="-81.296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-51.296875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="102.59375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>单一Consumer</p></span></div></foreignObject></g></g><g transform="translate(538.421875, 186)" id="flowchart-A4-9539" class="node default"><rect height="78" width="124.109375" y="-39" x="-62.0546875" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>性能低<br>可用性差</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-gideuy_112"><span class="control" id="-gideuy_118">顺序消息实现：</span></p><div class="code-block" data-lang="java">
// 顺序消息生产者
public class OrderedMessageProducer {
    
    public void sendOrderedMessage() throws Exception {
        DefaultMQProducer producer = new DefaultMQProducer(&quot;ordered_producer_group&quot;);
        producer.setNamesrvAddr(&quot;localhost:9876&quot;);
        producer.start();
        
        try {
            // 模拟订单状态变化消息
            String[] orderStates = {&quot;创建订单&quot;, &quot;支付完成&quot;, &quot;开始发货&quot;, &quot;确认收货&quot;};
            String[] orderIds = {&quot;ORDER001&quot;, &quot;ORDER002&quot;, &quot;ORDER003&quot;};
            
            for (String orderId : orderIds) {
                for (String state : orderStates) {
                    Message message = new Message(
                        &quot;OrderTopic&quot;,
                        &quot;OrderState&quot;,
                        orderId, // 使用订单ID作为Key
                        String.format(&quot;订单 %s: %s&quot;, orderId, state).getBytes(RemotingHelper.DEFAULT_CHARSET)
                    );
                    
                    // 使用MessageQueueSelector确保同一订单的消息发送到同一队列
                    SendResult result = producer.send(message, new MessageQueueSelector() {
                        @Override
                        public MessageQueue select(List&lt;MessageQueue&gt; mqs, Message msg, Object arg) {
                            String orderId = (String) arg;
                            // 根据订单ID的hash值选择队列，确保同一订单总是发送到同一队列
                            int index = Math.abs(orderId.hashCode()) % mqs.size();
                            return mqs.get(index);
                        }
                    }, orderId); // 传递orderId作为选择参数
                    
                    System.out.printf(&quot;发送顺序消息: %s, Queue: %d%n&quot;, 
                                    message.getKeys(), result.getMessageQueue().getQueueId());
                }
            }
            
        } finally {
            producer.shutdown();
        }
    }
}

// 顺序消息消费者
public class OrderedMessageConsumer {
    
    public void consumeOrderedMessage() throws Exception {
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;ordered_consumer_group&quot;);
        consumer.setNamesrvAddr(&quot;localhost:9876&quot;);
        consumer.subscribe(&quot;OrderTopic&quot;, &quot;*&quot;);
        
        // 注册顺序消息监听器
        consumer.registerMessageListener(new MessageListenerOrderly() {
            @Override
            public ConsumeOrderlyStatus consumeMessage(
                List&lt;MessageExt&gt; messages,
                ConsumeOrderlyContext context) {
                
                // 设置自动提交
                context.setAutoCommit(true);
                
                for (MessageExt message : messages) {
                    String orderId = message.getKeys();
                    String content = new String(message.getBody());
                    
                    System.out.printf(&quot;顺序消费消息 - 队列: %d, 订单: %s, 内容: %s%n&quot;, 
                                    message.getQueueId(), orderId, content);
                    
                    try {
                        // 处理订单状态变更
                        processOrderStateChange(orderId, content);
                        
                    } catch (Exception e) {
                        System.err.println(&quot;处理订单状态变更失败: &quot; + e.getMessage());
                        // 返回稍后重试，但不会影响其他队列的消费
                        return ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT;
                    }
                }
                
                return ConsumeOrderlyStatus.SUCCESS;
            }
        });
        
        consumer.start();
        System.out.println(&quot;顺序消息消费者启动成功&quot;);
    }
    
    private void processOrderStateChange(String orderId, String content) {
        // 处理订单状态变更逻辑
        // 1. 更新订单状态
        // 2. 触发相关业务流程
        // 3. 发送通知
        
        System.out.println(&quot;处理订单状态变更: &quot; + orderId + &quot; -&gt; &quot; + content);
        
        // 模拟处理时间
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</div><p id="-gideuy_114"><span class="control" id="-gideuy_119">顺序消息应用场景：</span></p><div class="code-block" data-lang="java">
// 电商订单处理场景
public class ECommerceOrderExample {
    
    // 订单状态枚举
    public enum OrderState {
        CREATED(&quot;订单创建&quot;),
        PAID(&quot;支付完成&quot;), 
        SHIPPED(&quot;已发货&quot;),
        DELIVERED(&quot;已送达&quot;),
        COMPLETED(&quot;订单完成&quot;),
        CANCELLED(&quot;订单取消&quot;);
        
        private String description;
        
        OrderState(String description) {
            this.description = description;
        }
    }
    
    // 发送订单状态变更消息
    public void sendOrderStateMessage(String orderId, OrderState fromState, OrderState toState) throws Exception {
        DefaultMQProducer producer = createProducer();
        
        // 构造订单状态变更消息
        OrderStateChangeEvent event = new OrderStateChangeEvent(
            orderId, fromState, toState, System.currentTimeMillis()
        );
        
        Message message = new Message(
            &quot;ORDER_STATE_TOPIC&quot;,
            &quot;STATE_CHANGE&quot;,
            orderId,
            JSON.toJSONString(event).getBytes(RemotingHelper.DEFAULT_CHARSET)
        );
        
        // 发送到固定队列确保顺序
        SendResult result = producer.send(message, (mqs, msg, arg) -&gt; {
            String orderKey = (String) arg;
            int index = Math.abs(orderKey.hashCode()) % mqs.size();
            return mqs.get(index);
        }, orderId);
        
        System.out.printf(&quot;订单状态变更消息发送成功: %s %s-&gt;%s%n&quot;, 
                        orderId, fromState, toState);
    }
    
    // 订单状态变更事件
    public static class OrderStateChangeEvent {
        private String orderId;
        private OrderState fromState;
        private OrderState toState;
        private long timestamp;
        
        // constructors, getters and setters
        public OrderStateChangeEvent(String orderId, OrderState fromState, OrderState toState, long timestamp) {
            this.orderId = orderId;
            this.fromState = fromState;
            this.toState = toState;
            this.timestamp = timestamp;
        }
        
        // getters and setters省略
    }
}

// 库存系统顺序处理
public class InventorySystemExample {
    
    // 库存操作类型
    public enum InventoryOperation {
        RESERVE(&quot;预留库存&quot;),
        RELEASE(&quot;释放库存&quot;), 
        DEDUCT(&quot;扣减库存&quot;),
        RETURN(&quot;退还库存&quot;);
        
        private String description;
        
        InventoryOperation(String description) {
            this.description = description;
        }
    }
    
    // 发送库存操作消息
    public void sendInventoryOperation(String productId, InventoryOperation operation, int quantity) throws Exception {
        Message message = new Message(
            &quot;INVENTORY_TOPIC&quot;,
            operation.name(),
            productId,
            String.format(&quot;%s:%d&quot;, operation.name(), quantity).getBytes()
        );
        
        // 按商品ID确保顺序处理
        producer.send(message, (mqs, msg, arg) -&gt; {
            String key = (String) arg;
            return mqs.get(Math.abs(key.hashCode()) % mqs.size());
        }, productId);
    }
    
    // 处理库存操作
    public void processInventoryOperation(String productId, InventoryOperation operation, int quantity) {
        switch (operation) {
            case RESERVE:
                reserveInventory(productId, quantity);
                break;
            case RELEASE:
                releaseInventory(productId, quantity);
                break;
            case DEDUCT:
                deductInventory(productId, quantity);
                break;
            case RETURN:
                returnInventory(productId, quantity);
                break;
        }
    }
}
</div></section><section class="chapter"><h3 id="q4-rocketmq" data-toc="q4-rocketmq">Q4: RocketMQ的延迟消息是如何实现的？支持哪些延迟级别？</h3><p id="-gideuy_120"><span class="control" id="-gideuy_125">答案：</span></p><p id="-gideuy_121"><span class="control" id="-gideuy_126">RocketMQ延迟消息实现原理：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1592.09375 274"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1592.09375" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="延迟消息处理流程" class="cluster"><rect height="258" width="1576.09375" y="8" x="8" style=""></rect><g transform="translate(731.9453125, 8)" class="cluster-label"><foreignObject height="24" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>延迟消息处理流程</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A1_A2_0" d="M265.344,76L271.594,76C277.844,76,290.344,76,299.953,77.583C309.563,79.167,316.282,82.333,322.397,85.216C328.513,88.098,334.026,90.696,336.783,91.996L339.539,93.295"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A2_A3_1" d="M511.469,134L517.719,134C523.969,134,536.469,134,545.844,134C555.219,134,561.469,134,567.052,134C572.635,134,577.552,134,580.01,134L582.469,134"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A3_A4_2" d="M814.641,134L820.891,134C827.141,134,839.641,134,849.016,134C858.391,134,864.641,134,870.224,134C875.807,134,880.724,134,883.182,134L885.641,134"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A4_A5_3" d="M1045.797,134L1052.047,134C1058.297,134,1070.797,134,1080.172,134C1089.547,134,1095.797,134,1101.38,134C1106.964,134,1111.88,134,1114.339,134L1116.797,134"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A5_A6_4" d="M1276.953,134L1283.203,134C1289.453,134,1301.953,134,1311.328,134C1320.703,134,1326.953,134,1332.536,134C1338.12,134,1343.036,134,1345.495,134L1347.953,134"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B1_A2_5" d="M263.344,192L269.927,192C276.51,192,289.677,192,299.62,190.417C309.563,188.833,316.282,185.667,322.397,182.784C328.513,179.902,334.026,177.304,336.783,176.004L339.539,174.705"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(155.421875, 76)" id="flowchart-A1-9708" class="node default"><rect height="54" width="219.84375" y="-27" x="-109.921875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-79.921875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="159.84375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Producer发送延迟消息</p></span></div></foreignObject></g></g><g transform="translate(425.90625, 134)" id="flowchart-A2-9709" class="node default"><rect height="78" width="171.125" y="-39" x="-85.5625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-55.5625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="111.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Broker接收消息<br>delayLevel &gt; 0</p></span></div></foreignObject></g></g><g transform="translate(700.5546875, 134)" id="flowchart-A3-9711" class="node default"><rect height="78" width="228.171875" y="-39" x="-114.0859375" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-84.0859375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="168.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>消息存储到<br>SCHEDULE_TOPIC_XXXX</p></span></div></foreignObject></g></g><g transform="translate(967.71875, 134)" id="flowchart-A4-9713" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>定时任务扫描<br>到期消息</p></span></div></foreignObject></g></g><g transform="translate(1198.875, 134)" id="flowchart-A5-9715" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>将消息投递到<br>真实Topic</p></span></div></foreignObject></g></g><g transform="translate(1449.2734375, 134)" id="flowchart-A6-9717" class="node default"><rect height="54" width="194.640625" y="-27" x="-97.3203125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-67.3203125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="134.640625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Consumer消费消息</p></span></div></foreignObject></g></g><g transform="translate(155.421875, 192)" id="flowchart-B1-9718" class="node default"><rect height="78" width="215.84375" y="-39" x="-107.921875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-77.921875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="155.84375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>延迟级别映射表<br>1=1s, 2=5s, ..., 18=2h</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="-gideuy_123"><span class="control" id="-gideuy_127">延迟消息实现：</span></p><div class="code-block" data-lang="java">
// RocketMQ延迟消息实现
public class DelayedMessageExample {
    
    // RocketMQ预定义的延迟级别
    // 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h
    private static final String[] DELAY_LEVELS = {
        &quot;1s&quot;, &quot;5s&quot;, &quot;10s&quot;, &quot;30s&quot;, &quot;1m&quot;, &quot;2m&quot;, &quot;3m&quot;, &quot;4m&quot;, &quot;5m&quot;, &quot;6m&quot;, 
        &quot;7m&quot;, &quot;8m&quot;, &quot;9m&quot;, &quot;10m&quot;, &quot;20m&quot;, &quot;30m&quot;, &quot;1h&quot;, &quot;2h&quot;
    };
    
    // 发送延迟消息
    public void sendDelayedMessage() throws Exception {
        DefaultMQProducer producer = new DefaultMQProducer(&quot;delayed_producer_group&quot;);
        producer.setNamesrvAddr(&quot;localhost:9876&quot;);
        producer.start();
        
        try {
            // 场景1: 订单超时取消（30分钟后检查）
            Message orderTimeoutMessage = new Message(
                &quot;ORDER_TIMEOUT_TOPIC&quot;,
                &quot;TIMEOUT_CHECK&quot;,
                &quot;ORDER123&quot;,
                &quot;检查订单支付状态&quot;.getBytes(RemotingHelper.DEFAULT_CHARSET)
            );
            // 设置延迟级别：16对应30分钟
            orderTimeoutMessage.setDelayTimeLevel(16);
            
            SendResult result1 = producer.send(orderTimeoutMessage);
            System.out.printf(&quot;订单超时检查消息发送: %s%n&quot;, result1.getMsgId());
            
            // 场景2: 用户注册欢迎邮件（1小时后发送）
            Message welcomeEmailMessage = new Message(
                &quot;USER_WELCOME_TOPIC&quot;,
                &quot;WELCOME_EMAIL&quot;,
                &quot;USER456&quot;,
                &quot;发送欢迎邮件&quot;.getBytes(RemotingHelper.DEFAULT_CHARSET)
            );
            // 设置延迟级别：17对应1小时
            welcomeEmailMessage.setDelayTimeLevel(17);
            
            SendResult result2 = producer.send(welcomeEmailMessage);
            System.out.printf(&quot;欢迎邮件消息发送: %s%n&quot;, result2.getMsgId());
            
            // 场景3: 库存锁定释放（10分钟后释放）
            Message inventoryReleaseMessage = new Message(
                &quot;INVENTORY_RELEASE_TOPIC&quot;,
                &quot;RELEASE_LOCK&quot;,
                &quot;PRODUCT789&quot;,
                &quot;释放库存锁定&quot;.getBytes(RemotingHelper.DEFAULT_CHARSET)
            );
            // 设置延迟级别：14对应10分钟
            inventoryReleaseMessage.setDelayTimeLevel(14);
            
            SendResult result3 = producer.send(inventoryReleaseMessage);
            System.out.printf(&quot;库存释放消息发送: %s%n&quot;, result3.getMsgId());
            
        } finally {
            producer.shutdown();
        }
    }
    
    // 订单超时检查消费者
    public void startOrderTimeoutConsumer() throws Exception {
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;order_timeout_consumer&quot;);
        consumer.setNamesrvAddr(&quot;localhost:9876&quot;);
        consumer.subscribe(&quot;ORDER_TIMEOUT_TOPIC&quot;, &quot;*&quot;);
        
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(
                List&lt;MessageExt&gt; messages,
                ConsumeConcurrentlyContext context) {
                
                for (MessageExt message : messages) {
                    String orderId = message.getKeys();
                    
                    try {
                        // 检查订单支付状态
                        OrderStatus status = checkOrderPaymentStatus(orderId);
                        
                        if (status == OrderStatus.UNPAID) {
                            // 自动取消未支付订单
                            cancelUnpaidOrder(orderId);
                            
                            // 释放库存
                            releaseOrderInventory(orderId);
                            
                            // 发送取消通知
                            sendOrderCancelNotification(orderId);
                            
                            System.out.println(&quot;自动取消超时订单: &quot; + orderId);
                        } else {
                            System.out.println(&quot;订单已支付，无需取消: &quot; + orderId);
                        }
                        
                    } catch (Exception e) {
                        System.err.println(&quot;处理订单超时检查失败: &quot; + e.getMessage());
                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;
                    }
                }
                
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
        
        consumer.start();
        System.out.println(&quot;订单超时检查消费者启动&quot;);
    }
    
    // 延迟消息工具类
    public static class DelayedMessageUtil {
        
        // 根据延迟时间获取延迟级别
        public static int getDelayLevel(long delayMillis) {
            if (delayMillis &lt;= 1000) return 1;          // 1s
            else if (delayMillis &lt;= 5000) return 2;     // 5s
            else if (delayMillis &lt;= 10000) return 3;    // 10s
            else if (delayMillis &lt;= 30000) return 4;    // 30s
            else if (delayMillis &lt;= 60000) return 5;    // 1m
            else if (delayMillis &lt;= 120000) return 6;   // 2m
            else if (delayMillis &lt;= 180000) return 7;   // 3m
            else if (delayMillis &lt;= 240000) return 8;   // 4m
            else if (delayMillis &lt;= 300000) return 9;   // 5m
            else if (delayMillis &lt;= 360000) return 10;  // 6m
            else if (delayMillis &lt;= 420000) return 11;  // 7m
            else if (delayMillis &lt;= 480000) return 12;  // 8m
            else if (delayMillis &lt;= 540000) return 13;  // 9m
            else if (delayMillis &lt;= 600000) return 14;  // 10m
            else if (delayMillis &lt;= 1200000) return 15; // 20m
            else if (delayMillis &lt;= 1800000) return 16; // 30m
            else if (delayMillis &lt;= 3600000) return 17; // 1h
            else return 18; // 2h
        }
        
        // 发送指定延迟时间的消息
        public static void sendDelayedMessage(DefaultMQProducer producer, 
                                            String topic, String tag, String key, 
                                            String content, long delayMillis) throws Exception {
            Message message = new Message(topic, tag, key, content.getBytes());
            message.setDelayTimeLevel(getDelayLevel(delayMillis));
            
            SendResult result = producer.send(message);
            System.out.printf(&quot;延迟消息发送成功: topic=%s, key=%s, delay=%dms, msgId=%s%n&quot;, 
                            topic, key, delayMillis, result.getMsgId());
        }
    }
    
    // 分布式任务调度示例
    public void distributedTaskScheduling() throws Exception {
        DefaultMQProducer producer = createProducer();
        
        // 定时数据备份任务（每小时执行）
        scheduleTask(producer, &quot;DATA_BACKUP&quot;, &quot;HOURLY&quot;, &quot;每小时数据备份&quot;, 3600000);
        
        // 定时报表生成（每天执行）
        scheduleTask(producer, &quot;REPORT_GENERATION&quot;, &quot;DAILY&quot;, &quot;每日报表生成&quot;, 86400000);
        
        // 定时清理临时文件（每30分钟）
        scheduleTask(producer, &quot;TEMP_CLEANUP&quot;, &quot;HALF_HOURLY&quot;, &quot;清理临时文件&quot;, 1800000);
    }
    
    private void scheduleTask(DefaultMQProducer producer, String taskType, 
                            String frequency, String description, long intervalMillis) throws Exception {
        Message taskMessage = new Message(
            &quot;SCHEDULED_TASK_TOPIC&quot;,
            taskType,
            taskType + &quot;_&quot; + System.currentTimeMillis(),
            String.format(&quot;{\&quot;taskType\&quot;:\&quot;%s\&quot;, \&quot;description\&quot;:\&quot;%s\&quot;, \&quot;nextExecution\&quot;:%d}&quot;, 
                        taskType, description, System.currentTimeMillis() + intervalMillis).getBytes()
        );
        
        // 设置延迟级别
        taskMessage.setDelayTimeLevel(DelayedMessageUtil.getDelayLevel(intervalMillis));
        
        producer.send(taskMessage);
        System.out.printf(&quot;定时任务调度: %s, 下次执行时间: %d分钟后%n&quot;, 
                        description, intervalMillis / 60000);
    }
}
</div></section></section><section class="chapter"><h2 id="-gideuy_7" data-toc="-gideuy_7">💡 面试技巧</h2><section class="chapter"><h3 id="-gideuy_128" data-toc="-gideuy_128">高频考点</h3><ol class="list _decimal" id="-gideuy_130" type="1"><li class="list__item" id="-gideuy_131"><p id="-gideuy_136"><span class="control" id="-gideuy_137">架构设计</span>: RocketMQ架构和与Kafka的区别</p></li><li class="list__item" id="-gideuy_132"><p id="-gideuy_138"><span class="control" id="-gideuy_139">事务消息</span>: 事务消息实现原理和应用场景</p></li><li class="list__item" id="-gideuy_133"><p id="-gideuy_140"><span class="control" id="-gideuy_141">顺序消息</span>: 全局顺序vs分区顺序的权衡</p></li><li class="list__item" id="-gideuy_134"><p id="-gideuy_142"><span class="control" id="-gideuy_143">延迟消息</span>: 延迟级别和应用场景</p></li><li class="list__item" id="-gideuy_135"><p id="-gideuy_144"><span class="control" id="-gideuy_145">企业特性</span>: 高可用、监控、运维等</p></li></ol></section><section class="chapter"><h3 id="-gideuy_129" data-toc="-gideuy_129">回答策略</h3><ol class="list _decimal" id="-gideuy_146" type="1"><li class="list__item" id="-gideuy_149"><p id="-gideuy_153"><span class="control" id="-gideuy_154">突出企业特性</span>: 强调RocketMQ的企业级特性</p></li><li class="list__item" id="-gideuy_150"><p id="-gideuy_155"><span class="control" id="-gideuy_156">场景驱动</span>: 结合具体业务场景说明技术选择</p></li><li class="list__item" id="-gideuy_151"><p id="-gideuy_157"><span class="control" id="-gideuy_158">对比分析</span>: 与其他消息队列的优缺点对比</p></li><li class="list__item" id="-gideuy_152"><p id="-gideuy_159"><span class="control" id="-gideuy_160">实践经验</span>: 说明在生产环境中的应用经验</p></li></ol><p id="-gideuy_148"><span class="control" id="-gideuy_161">学习建议</span>: RocketMQ是企业级消息队列的优秀选择，重点要理解其事务消息、顺序消息等高级特性。建议通过实际项目体验其在分布式事务和业务解耦中的应用。</p></section></section><div class="last-modified">09 六月 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="rabbitmq应用实践qa.html" class="navigation-links__prev">RabbitMQ应用实践QA</a><a href="消息队列设计与选型qa.html" class="navigation-links__next">消息队列设计与选型QA</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>