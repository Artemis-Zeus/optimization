<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-06-10T01:18:28.4392805"><title>ES集群管理QA | 技术知识库</title><script type="application/json" id="virtual-toc-data">[{"id":"z5rww9_4","level":0,"title":"📋 知识结构","anchor":"#z5rww9_4"},{"id":"z5rww9_5","level":0,"title":"⚙️ 集群配置","anchor":"#z5rww9_5"},{"id":"z5rww9_6","level":0,"title":"🔄 分片管理","anchor":"#z5rww9_6"},{"id":"z5rww9_7","level":0,"title":"🚨 故障恢复","anchor":"#z5rww9_7"},{"id":"z5rww9_8","level":0,"title":"💡 面试技巧","anchor":"#z5rww9_8"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="ES集群管理QA | 技术知识库"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="技术知识库 Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/es集群管理qa.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="ES集群管理QA | 技术知识库"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/es集群管理qa.html#webpage",
    "url": "writerside-documentation/es集群管理qa.html",
    "name": "ES集群管理QA | 技术知识库",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "技术知识库 Help"
}</script><!-- End Schema.org --></head><body data-id="ES集群管理QA" data-main-title="ES集群管理QA" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="ES面试大纲.md|Elasticsearch面试大纲"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>技术知识库  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="ES集群管理QA" id="ES集群管理QA.md">ES集群管理QA</h1><p id="z5rww9_3">本文档深入解析Elasticsearch的集群管理机制，涵盖集群配置、分片管理、故障恢复、集群监控等运维核心技能。</p><section class="chapter"><h2 id="z5rww9_4" data-toc="z5rww9_4">📋 知识结构</h2><svg aria-roledescription="mindmap" role="graphics-document document" viewBox="5 5 679.28271484375 422.93536376953125" style="max-width: 679.28271484375px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><g></g><g class="mindmap-edges"><path class="edge section-edge-0 edge-depth-1" d="M 475.464814049933,179.7267771343789 L 429.4176250289494,157.12571142866645 L383.37043600796574,134.524645722954"></path><path class="edge section-edge-0 edge-depth-1" d="M 490.747768826115,171.4464675504414 L 494.63326120483,139.61517310084716 L498.51875358354494,107.78387865125292"></path><path class="edge section-edge-0 edge-depth-1" d="M 502.6209023666174,180.20676765092475 L 557.7719065429842,155.5160937774178 L612.922910719351,130.82541990391087"></path><path class="edge section-edge-0 edge-depth-1" d="M 503.62773374063977,189.3334331442692 L 560.3384517089536,200.89933712248452 L617.0491696772674,212.46524110069984"></path><path class="edge section-edge-0 edge-depth-0" d="M 341.51972921795885,216.65503775862354 L 407.8787809080874,203.0064504192492 L474.2378325982159,189.35786307987487"></path><path class="edge section-edge-1 edge-depth-1" d="M 385.1120888467952,312.8644360075942 L 346.2890285353359,337.591351163834 L307.4659682238766,362.31826632007386"></path><path class="edge section-edge-1 edge-depth-1" d="M 412.4510644351574,301.7590507093643 L 466.1021824540127,290.62749906975256 L519.753300472868,279.4959474301408"></path><path class="edge section-edge-1 edge-depth-1" d="M 411.5493544408925,310.7190703496386 L 463.68700670019734,333.08134834508576 L515.8246589595021,355.4436263405329"></path><path class="edge section-edge-1 edge-depth-1" d="M 400.5240288519221,319.55021873368037 L 406.58406946058653,351.9208670731881 L412.644110069251,384.29151541269584"></path><path class="edge section-edge-1 edge-depth-0" d="M 336.4296795900497,231.2005739637787 L 362.2955709913109,262.24165274777033 L388.1614623925721,293.282731531762"></path><path class="edge section-edge-2 edge-depth-1" d="M 196.47363917694213,305.8014385324474 L 186.91429292699797,337.7034894838222 L177.35494667705382,369.605540435197"></path><path class="edge section-edge-2 edge-depth-1" d="M 186.48815679386007,286.8756683732033 L 130.69768762877078,269.0857829232343 L74.90721846368147,251.29589747326534"></path><path class="edge section-edge-2 edge-depth-1" d="M 199.43174141682914,276.49329219344844 L 196.8798706432089,248.20055950350607 L194.32799986958867,219.90782681356367"></path><path class="edge section-edge-2 edge-depth-1" d="M 186.30161935677918,295.3568853229035 L 129.15760000402315,310.84612244834307 L72.01358065126712,326.3353595737826"></path><path class="edge section-edge-2 edge-depth-0" d="M 313.79154303609624,227.09783523164245 L 263.8032405619121,255.55479857444038 L213.81493808772797,284.01176191723835"></path><path class="edge section-edge-3 edge-depth-1" d="M 257.044357573233,118.42060036270917 L 291.6960954807472,90.05914627930375 L326.3478333882614,61.69769219589833"></path><path class="edge section-edge-3 edge-depth-1" d="M 230.55613184169695,129.8107090680987 L 173.36700073663764,137.0725901953692 L116.17786963157832,144.3344713226397"></path><path class="edge section-edge-3 edge-depth-1" d="M 241.65848480092268,113.40479269510854 L 233.20126270487845,80.91059005137188 L224.7440406088342,48.41638740763521"></path><path class="edge section-edge-3 edge-depth-1" d="M 231.64347981820725,122.02638693847908 L 174.6700170654301,97.67760495462173 L117.69655431265296,73.32882297076438"></path><path class="edge section-edge-3 edge-depth-0" d="M 316.8734454927155,208.45548883758198 L 286.1319628486432,173.79906460006427 L255.39048020457088,139.14264036254656"></path></g><g class="mindmap-nodes"><g transform="translate(276.1344627258853, 200.77694909738477)" class="mindmap-node section--1 section-root"><g transform="translate(50.69281768798828, 18.9)"><circle r="50.69281768798828" class="node-bkg node-circle" id="node-0"></circle></g><g transform="translate(50.69281768798828, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">ES集群管理</tspan></tspan></text></g></g></g><g transform="translate(445.89428210420544, 167.43595174111363)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-1"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">集群配置</tspan></tspan></text></g></g></g><g transform="translate(354.7278622706525, 285.90635639815594)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-6"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">分片管理</tspan></tspan></text></g></g></g><g transform="translate(158.2432014118549, 272.53264805149604)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-11"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">故障恢复</tspan></tspan></text></g></g></g><g transform="translate(202.88195778341276, 109.02118010274376)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-16"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">集群监控</tspan></tspan></text></g></g></g><g transform="translate(327.3502811555976, 109.01547111621926)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-2"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">节点发现</tspan></tspan></text></g></g></g><g transform="translate(457.7815535073588, 73.99439446058068)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-3"></path><line y2="37.8" x2="85.109375" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(42.5546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">选主机制</tspan></tspan></text></g></g></g><g transform="translate(584.0775323855715, 105.79623581372198)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-4"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">网络配置</tspan></tspan></text></g></g></g><g transform="translate(589.2106227175103, 196.5627225038554)" class="mindmap-node section-0"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-5"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-0"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">安全配置</tspan></tspan></text></g></g></g><g transform="translate(251.77819620382786, 351.47634592951215)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-7"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">分片分配</tspan></tspan></text></g></g></g><g transform="translate(491.40450404118144, 257.54864174134923)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-8"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">路由策略</tspan></tspan></text></g></g></g><g transform="translate(495.0861516637998, 342.4563402920156)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h59.04800033569336 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-9"></path><line y2="37.8" x2="69.04800033569336" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(34.52400016784668, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">重平衡</tspan></tspan></text></g></g></g><g transform="translate(373.34958985242486, 380.1353777482203)" class="mindmap-node section-1"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h74.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-10"></path><line y2="37.8" x2="84.109375" y1="37.8" x1="0" class="node-line-1"></line></g><g transform="translate(42.0546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">生命周期</tspan></tspan></text></g></g></g><g transform="translate(130.99469764404535, 365.07433091614837)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h74.109375 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-12"></path><line y2="37.8" x2="84.109375" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.0546875, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">故障检测</tspan></tspan></text></g></g></g><g transform="translate(18.080175249495255, 227.83891779497264)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-13"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">自动恢复</tspan></tspan></text></g></g></g><g transform="translate(149.9445412783715, 186.0684709555161)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-14"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">数据恢复</tspan></tspan></text></g></g></g><g transform="translate(15, 311.35959684519014)" class="mindmap-node section-2"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-15"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-2"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">灾备策略</tspan></tspan></text></g></g></g><g transform="translate(294.91954637998595, 33.297112455863726)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-17"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">健康状态</tspan></tspan></text></g></g></g><g transform="translate(58.26135689176681, 127.32400028799464)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h76.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-18"></path><line y2="37.8" x2="86.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(43.0359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">性能指标</tspan></tspan></text></g></g></g><g transform="translate(178.42988082824843, 15)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-19"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">日志分析</tspan></tspan></text></g></g></g><g transform="translate(61.36738954935174, 48.534029806499696)" class="mindmap-node section-3"><g><path d="M0 32.8 v-27.799999999999997 q0,-5 5,-5 h75.0719985961914 q5,0 5,5 v32.8 H0 Z" class="node-bkg node-no-border" id="node-20"></path><line y2="37.8" x2="85.0719985961914" y1="37.8" x1="0" class="node-line-3"></line></g><g transform="translate(42.5359992980957, 5)" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" dy="1em"><g><rect style="stroke: none" class="background"></rect><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">告警配置</tspan></tspan></text></g></g></g></g></svg></section><section class="chapter"><h2 id="z5rww9_5" data-toc="z5rww9_5">⚙️ 集群配置</h2><section class="chapter"><h3 id="q1-es" data-toc="q1-es">Q1: ES集群是如何进行节点发现和选主的？如何避免脑裂问题？</h3><p id="z5rww9_12"><span class="control" id="z5rww9_21">答案：</span></p><p id="z5rww9_13"><span class="control" id="z5rww9_22">ES集群发现和选主机制：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 809.546875 1294.203125" height="1294.203125" class="flowchart" xmlns="http://www.w3.org/2000/svg" width="809.546875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES集群发现流程" class="cluster"><rect height="1278.203125" width="793.546875" y="8" x="8" style=""></rect><g transform="translate(348.5390625, 8)" class="cluster-label"><foreignObject height="24" width="112.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES集群发现流程</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M228.156,99.5L228.156,105.75C228.156,112,228.156,124.5,228.156,133.875C228.156,143.25,228.156,149.5,228.156,155.083C228.156,160.667,228.156,165.583,228.156,168.042L228.156,170.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_C_1" d="M228.156,228.5L228.156,234.75C228.156,241,228.156,253.5,228.156,262.875C228.156,272.25,228.156,278.5,228.156,284.083C228.156,289.667,228.156,294.583,228.156,297.042L228.156,299.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_D_2" d="M228.156,357.5L228.156,363.75C228.156,370,228.156,382.5,228.156,391.875C228.156,401.25,228.156,407.5,228.156,413.083C228.156,418.667,228.156,423.583,228.156,426.042L228.156,428.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_E_3" d="M228.156,486.5L228.156,492.75C228.156,499,228.156,511.5,228.198,520.917C228.24,530.333,228.323,536.667,228.397,542.333C228.472,548,228.538,553,228.571,555.5L228.604,558"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_F_4" d="M194.543,683.934L183.634,697.786C172.724,711.638,150.905,739.343,139.995,757.32C129.086,775.297,129.086,783.547,129.086,791.13C129.086,798.714,129.086,805.63,129.086,809.089L129.086,812.547"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_G_5" d="M262.769,683.934L273.512,697.786C284.255,711.638,305.741,739.343,316.484,765.945C327.227,792.547,327.227,818.047,327.227,841.547C327.227,865.047,327.227,886.547,327.227,904.428C327.227,922.31,327.227,936.573,327.227,950.169C327.227,963.766,327.227,976.695,327.227,983.16L327.227,989.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_F_H_6" d="M129.086,870.547L129.086,876.797C129.086,883.047,129.086,895.547,129.086,908.928C129.086,922.31,129.086,936.573,129.086,950.169C129.086,963.766,129.086,976.695,129.086,983.16L129.086,989.625"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_H_I_7" d="M129.086,1047.625L129.086,1063.888C129.086,1080.151,129.086,1112.677,134.428,1133.065C139.77,1153.453,150.454,1161.703,160.61,1169.546C170.767,1177.388,180.396,1184.823,185.21,1188.541L190.024,1192.258"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_G_I_8" d="M327.227,1047.625L327.227,1063.888C327.227,1080.151,327.227,1112.677,321.885,1133.065C316.543,1153.453,305.858,1161.703,295.702,1169.546C285.546,1177.388,275.917,1184.823,271.103,1188.541L266.288,1192.258"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_J_K_9" d="M610.926,870.547L610.926,876.797C610.926,883.047,610.926,895.547,610.967,904.964C611.009,914.38,611.092,920.714,611.167,926.38C611.242,932.047,611.307,937.047,611.34,939.547L611.373,942.047"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_K_L_10" d="M580.543,1065.32L571.097,1078.634C561.652,1091.948,542.762,1118.575,533.316,1136.014C523.871,1153.453,523.871,1161.703,523.871,1169.286C523.871,1176.87,523.871,1183.786,523.871,1187.245L523.871,1190.703"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_K_M_11" d="M642.309,1065.32L651.588,1078.634C660.866,1091.948,679.423,1118.575,688.702,1136.014C697.98,1153.453,697.98,1161.703,697.98,1169.286C697.98,1176.87,697.98,1183.786,697.98,1187.245L697.98,1190.703"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g transform="translate(129.0859375, 767.046875)" class="edgeLabel"><g transform="translate(-8.015625, -12)" class="label"><foreignObject height="24" width="16.03125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>是</p></span></div></foreignObject></g></g><g transform="translate(327.2265625, 843.546875)" class="edgeLabel"><g transform="translate(-8.015625, -12)" class="label"><foreignObject height="24" width="16.03125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>否</p></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g transform="translate(523.87109375, 1145.203125)" class="edgeLabel"><g transform="translate(-16.03125, -12)" class="label"><foreignObject height="24" width="32.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>满足</p></span></div></foreignObject></g></g><g transform="translate(697.98046875, 1145.203125)" class="edgeLabel"><g transform="translate(-24.0390625, -12)" class="label"><foreignObject height="24" width="48.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>不满足</p></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(228.15625, 72.5)" id="flowchart-A-11394" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>节点启动</p></span></div></foreignObject></g></g><g transform="translate(228.15625, 201.5)" id="flowchart-B-11395" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>读取配置文件</p></span></div></foreignObject></g></g><g transform="translate(228.15625, 330.5)" id="flowchart-C-11397" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>发现种子节点</p></span></div></foreignObject></g></g><g transform="translate(228.15625, 459.5)" id="flowchart-D-11399" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>加入集群</p></span></div></foreignObject></g></g><g transform="translate(228.15625, 639.5234375)" id="flowchart-E-11401" class="node default"><polygon transform="translate(-78.0234375,78.0234375)" class="label-container" points="78.0234375,0 156.046875,-78.0234375 78.0234375,-156.046875 0,-78.0234375"></polygon><g transform="translate(-51.0234375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="102.046875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>是否需要选主?</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 843.546875)" id="flowchart-F-11403" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>候选主节点投票</p></span></div></foreignObject></g></g><g transform="translate(327.2265625, 1020.625)" id="flowchart-G-11405" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>加入现有集群</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 1020.625)" id="flowchart-H-11407" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>主节点选举</p></span></div></foreignObject></g></g><g transform="translate(228.15625, 1221.703125)" id="flowchart-I-11409" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>集群状态同步</p></span></div></foreignObject></g></g><g transform="translate(610.92578125, 843.546875)" id="flowchart-J-11412" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>脑裂检测</p></span></div></foreignObject></g></g><g transform="translate(610.92578125, 1020.625)" id="flowchart-K-11413" class="node default"><polygon transform="translate(-75.078125,75.078125)" class="label-container" points="75.078125,0 150.15625,-75.078125 75.078125,-150.15625 0,-75.078125"></polygon><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>法定人数检查</p></span></div></foreignObject></g></g><g transform="translate(523.87109375, 1221.703125)" id="flowchart-L-11415" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>继续服务</p></span></div></foreignObject></g></g><g transform="translate(697.98046875, 1221.703125)" id="flowchart-M-11417" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>停止服务</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="z5rww9_15"><span class="control" id="z5rww9_23">集群发现配置：</span></p><div class="code-block" data-lang="yaml">
# elasticsearch.yml - 集群发现配置
cluster.name: production-cluster

# 节点名称和角色
node.name: master-node-1
node.roles: [master]

# 种子节点配置
discovery.seed_hosts:
  - master-node-1:9300
  - master-node-2:9300
  - master-node-3:9300

# 初始主节点列表
cluster.initial_master_nodes:
  - master-node-1
  - master-node-2
  - master-node-3

# 选主相关配置
cluster.election.strategy: supports_voting_only
discovery.probe.connect_timeout: 30s
discovery.probe.handshake_timeout: 30s

# 故障检测配置
cluster.fault_detection.leader_check.timeout: 10s
cluster.fault_detection.leader_check.retry_count: 3
cluster.fault_detection.follower_check.timeout: 10s
cluster.fault_detection.follower_check.retry_count: 3

# 集群状态发布配置
cluster.publish.timeout: 30s
cluster.publish.info_timeout: 10s
</div><p id="z5rww9_17"><span class="control" id="z5rww9_24">脑裂预防机制：</span></p><ol class="list _decimal" id="z5rww9_18" type="1"><li class="list__item" id="z5rww9_25"><p id="z5rww9_27"><span class="control" id="z5rww9_29">法定人数机制</span></p><div class="code-block" data-lang="yaml">
# 最小主节点数配置（ES 7.0前）
discovery.zen.minimum_master_nodes: 2

# ES 7.0后通过initial_master_nodes自动计算
# 法定人数 = (候选主节点数 / 2) + 1
# 3个主节点：法定人数 = 2
# 5个主节点：法定人数 = 3
</div></li><li class="list__item" id="z5rww9_26"><p id="z5rww9_30"><span class="control" id="z5rww9_32">脑裂检测和处理</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 488.359375 790"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="488.359375" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="脑裂检测机制" class="cluster"><rect height="774" width="472.359375" y="8" x="8" style=""></rect><g transform="translate(196.1015625, 8)" class="cluster-label"><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>脑裂检测机制</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M244.18,99.5L244.18,105.75C244.18,112,244.18,124.5,244.18,133.875C244.18,143.25,244.18,149.5,244.18,155.083C244.18,160.667,244.18,165.583,244.18,168.042L244.18,170.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_C_1" d="M244.18,228.5L244.18,234.75C244.18,241,244.18,253.5,244.18,262.875C244.18,272.25,244.18,278.5,244.18,284.083C244.18,289.667,244.18,294.583,244.18,297.042L244.18,299.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_D_2" d="M244.18,357.5L244.18,363.75C244.18,370,244.18,382.5,244.18,391.875C244.18,401.25,244.18,407.5,244.18,413.083C244.18,418.667,244.18,423.583,244.18,426.042L244.18,428.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_E_3" d="M244.18,486.5L244.18,492.75C244.18,499,244.18,511.5,244.18,520.875C244.18,530.25,244.18,536.5,244.18,542.083C244.18,547.667,244.18,552.583,244.18,555.042L244.18,557.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_F_4" d="M197.679,615.5L186.914,621.75C176.15,628,154.622,640.5,143.858,649.875C133.094,659.25,133.094,665.5,133.094,671.083C133.094,676.667,133.094,681.583,133.094,684.042L133.094,686.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_G_5" d="M290.681,615.5L301.445,621.75C312.209,628,333.737,640.5,344.501,649.875C355.266,659.25,355.266,665.5,355.266,671.083C355.266,676.667,355.266,681.583,355.266,684.042L355.266,686.5"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(244.1796875, 72.5)" id="flowchart-A-11441" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>网络分区</p></span></div></foreignObject></g></g><g transform="translate(244.1796875, 201.5)" id="flowchart-B-11442" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>节点无法通信</p></span></div></foreignObject></g></g><g transform="translate(244.1796875, 330.5)" id="flowchart-C-11444" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>各自选举主节点</p></span></div></foreignObject></g></g><g transform="translate(244.1796875, 459.5)" id="flowchart-D-11446" class="node default"><rect height="54" width="188.203125" y="-27" x="-94.1015625" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-64.1015625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>检测到多个主节点</p></span></div></foreignObject></g></g><g transform="translate(244.1796875, 588.5)" id="flowchart-E-11448" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>法定人数检查</p></span></div></foreignObject></g></g><g transform="translate(133.09375, 717.5)" id="flowchart-F-11450" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>少数派停止服务</p></span></div></foreignObject></g></g><g transform="translate(355.265625, 717.5)" id="flowchart-G-11452" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>多数派继续服务</p></span></div></foreignObject></g></g></g></g></g></g></g></svg></li></ol><p id="z5rww9_19"><span class="control" id="z5rww9_33">选主算法详解：</span></p><div class="code-block" data-lang="bash">
# ES选主算法（Bully算法变种）
1. 节点启动或主节点失效时触发选举
2. 候选节点比较条件：
   - 节点ID（集群状态版本号）
   - 节点优先级
   - 节点启动时间
3. 收集投票，获得多数票的节点成为主节点
4. 新主节点广播集群状态

# 投票决策因素
选举优先级：
1. 集群状态版本更新的节点优先
2. 节点ID较小的优先
3. 具有master角色的节点优先
</div></section><section class="chapter"><h3 id="q2-es" data-toc="q2-es">Q2: 如何配置ES集群的网络和安全设置？</h3><p id="z5rww9_34"><span class="control" id="z5rww9_41">答案：</span></p><p id="z5rww9_35"><span class="control" id="z5rww9_42">ES网络配置：</span></p><div class="code-block" data-lang="yaml">
# elasticsearch.yml - 网络配置
# 绑定地址配置
network.host: 0.0.0.0              # 监听所有网卡
network.bind_host: 192.168.1.100   # 绑定特定IP
network.publish_host: 192.168.1.100 # 对外发布的IP

# 端口配置
http.port: 9200                    # HTTP端口
transport.port: 9300               # 节点间通信端口

# HTTP配置
http.max_content_length: 100mb     # 最大请求体大小
http.max_initial_line_length: 4kb  # 最大请求行长度
http.max_header_size: 8kb          # 最大请求头大小

# 传输层配置
transport.tcp.compress: true       # 启用压缩
transport.tcp.connect_timeout: 30s # 连接超时
transport.ping_schedule: 5s        # 心跳间隔

# CORS配置（开发环境）
http.cors.enabled: true
http.cors.allow-origin: &quot;*&quot;
http.cors.allow-headers: &quot;X-Requested-With,Content-Type,Content-Length&quot;
</div><p id="z5rww9_37"><span class="control" id="z5rww9_43">安全配置（X-Pack Security）：</span></p><div class="code-block" data-lang="yaml">
# elasticsearch.yml - 安全配置
xpack.security.enabled: true

# 传输层安全
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: elastic-certificates.p12

# HTTP层安全
xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.keystore.path: elastic-certificates.p12
xpack.security.http.ssl.truststore.path: elastic-certificates.p12

# 审计日志
xpack.security.audit.enabled: true
xpack.security.audit.outputs: [index, logfile]
xpack.security.audit.logfile.events.include: [authentication_failed, access_denied]

# IP过滤
xpack.security.transport.filter.allow: &quot;192.168.1.0/24&quot;
xpack.security.transport.filter.deny: &quot;_all&quot;
</div><p id="z5rww9_39"><span class="control" id="z5rww9_44">用户和角色管理：</span></p><div class="code-block" data-lang="bash">
# 创建内置用户密码
bin/elasticsearch-setup-passwords auto

# 创建自定义角色
PUT /_security/role/log_reader
{
  &quot;cluster&quot;: [&quot;monitor&quot;],
  &quot;indices&quot;: [
    {
      &quot;names&quot;: [&quot;logs-*&quot;],
      &quot;privileges&quot;: [&quot;read&quot;, &quot;view_index_metadata&quot;],
      &quot;field_security&quot;: {
        &quot;grant&quot;: [&quot;timestamp&quot;, &quot;level&quot;, &quot;message&quot;]
      },
      &quot;query&quot;: {
        &quot;match&quot;: {
          &quot;level&quot;: &quot;ERROR&quot;
        }
      }
    }
  ]
}

# 创建用户
PUT /_security/user/log_analyst
{
  &quot;password&quot;: &quot;secure_password&quot;,
  &quot;roles&quot;: [&quot;log_reader&quot;],
  &quot;full_name&quot;: &quot;Log Analyst&quot;,
  &quot;email&quot;: &quot;analyst@company.com&quot;
}

# API密钥管理
POST /_security/api_key
{
  &quot;name&quot;: &quot;my-api-key&quot;,
  &quot;role_descriptors&quot;: {
    &quot;role-a&quot;: {
      &quot;cluster&quot;: [&quot;monitor&quot;],
      &quot;index&quot;: [
        {
          &quot;names&quot;: [&quot;index-a*&quot;],
          &quot;privileges&quot;: [&quot;read&quot;]
        }
      ]
    }
  },
  &quot;expiration&quot;: &quot;1d&quot;
}
</div></section></section><section class="chapter"><h2 id="z5rww9_6" data-toc="z5rww9_6">🔄 分片管理</h2><section class="chapter"><h3 id="q3-es" data-toc="q3-es">Q3: ES是如何进行分片分配和重平衡的？如何控制分片分配策略？</h3><p id="z5rww9_47"><span class="control" id="z5rww9_56">答案：</span></p><p id="z5rww9_48"><span class="control" id="z5rww9_57">分片分配决策流程：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 921.3828125 967"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="921.3828125" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="分片分配决策流程" class="cluster"><rect height="951" width="905.3828125" y="8" x="8" style=""></rect><g transform="translate(396.58984375, 8)" class="cluster-label"><foreignObject height="24" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片分配决策流程</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M129.086,99.5L129.086,105.75C129.086,112,129.086,124.5,129.086,133.875C129.086,143.25,129.086,149.5,129.086,155.083C129.086,160.667,129.086,165.583,129.086,168.042L129.086,170.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_C_1" d="M129.086,228.5L129.086,234.75C129.086,241,129.086,253.5,129.086,262.875C129.086,272.25,129.086,278.5,129.086,284.083C129.086,289.667,129.086,294.583,129.086,297.042L129.086,299.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_D_2" d="M129.086,357.5L129.086,363.75C129.086,370,129.086,382.5,129.086,391.875C129.086,401.25,129.086,407.5,129.086,413.083C129.086,418.667,129.086,423.583,129.086,426.042L129.086,428.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_E_3" d="M129.086,486.5L129.086,492.75C129.086,499,129.086,511.5,129.086,520.875C129.086,530.25,129.086,536.5,129.086,542.083C129.086,547.667,129.086,552.583,129.086,555.042L129.086,557.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_F_4" d="M129.086,615.5L129.086,621.75C129.086,628,129.086,640.5,129.086,649.875C129.086,659.25,129.086,665.5,129.086,671.083C129.086,676.667,129.086,681.583,129.086,684.042L129.086,686.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_F_G_5" d="M129.086,744.5L129.086,750.75C129.086,757,129.086,769.5,129.086,780.875C129.086,792.25,129.086,802.5,129.086,812.083C129.086,821.667,129.086,830.583,129.086,835.042L129.086,839.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_H_H1_6" d="M361.617,744.5L361.617,750.75C361.617,757,361.617,769.5,361.617,778.875C361.617,788.25,361.617,794.5,361.617,800.083C361.617,805.667,361.617,810.583,361.617,813.042L361.617,815.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I_I1_7" d="M594.148,744.5L594.148,750.75C594.148,757,594.148,769.5,594.148,778.875C594.148,788.25,594.148,794.5,594.148,800.083C594.148,805.667,594.148,810.583,594.148,813.042L594.148,815.5"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_J_J1_8" d="M800.305,744.5L800.305,750.75C800.305,757,800.305,769.5,800.305,778.875C800.305,788.25,800.305,794.5,800.305,800.083C800.305,805.667,800.305,810.583,800.305,813.042L800.305,815.5"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(129.0859375, 72.5)" id="flowchart-A-11482" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片分配需求</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 201.5)" id="flowchart-B-11483" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分配过滤器检查</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 330.5)" id="flowchart-C-11485" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分配感知检查</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 459.5)" id="flowchart-D-11487" class="node default"><rect height="54" width="172.171875" y="-27" x="-86.0859375" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-56.0859375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分配决策器评估</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 588.5)" id="flowchart-E-11489" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>节点容量检查</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 717.5)" id="flowchart-F-11491" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>平衡性考虑</p></span></div></foreignObject></g></g><g transform="translate(129.0859375, 870.5)" id="flowchart-G-11493" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>执行分片分配</p></span></div></foreignObject></g></g><g transform="translate(361.6171875, 717.5)" id="flowchart-H-11494" class="node default"><rect height="54" width="108.078125" y="-27" x="-54.0390625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-24.0390625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="48.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>过滤器</p></span></div></foreignObject></g></g><g transform="translate(361.6171875, 870.5)" id="flowchart-H1-11495" class="node default"><rect height="102" width="208.90625" y="-51" x="-104.453125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-74.453125, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="148.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>include/exclude规则<br>require规则<br>IP过滤</p></span></div></foreignObject></g></g><g transform="translate(594.1484375, 717.5)" id="flowchart-I-11496" class="node default"><rect height="54" width="92.0625" y="-27" x="-46.03125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-16.03125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="32.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>感知</p></span></div></foreignObject></g></g><g transform="translate(594.1484375, 870.5)" id="flowchart-I1-11497" class="node default"><rect height="102" width="156.15625" y="-51" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>机架感知<br>区域感知<br>节点属性感知</p></span></div></foreignObject></g></g><g transform="translate(800.3046875, 717.5)" id="flowchart-J-11498" class="node default"><rect height="54" width="108.078125" y="-27" x="-54.0390625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-24.0390625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="48.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>决策器</p></span></div></foreignObject></g></g><g transform="translate(800.3046875, 870.5)" id="flowchart-J1-11499" class="node default"><rect height="102" width="156.15625" y="-51" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>磁盘使用率<br>分片数量平衡<br>节点负载</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="z5rww9_50"><span class="control" id="z5rww9_58">分片分配配置：</span></p><div class="code-block" data-lang="yaml">
# elasticsearch.yml - 分片分配配置
cluster.routing.allocation.enable: all              # 启用所有分片分配
cluster.routing.allocation.node_concurrent_incoming_recoveries: 2
cluster.routing.allocation.node_concurrent_outgoing_recoveries: 2
cluster.routing.allocation.node_initial_primaries_recoveries: 4

# 分片平衡配置
cluster.routing.allocation.balance.shard: 0.45f     # 分片平衡权重
cluster.routing.allocation.balance.index: 0.55f     # 索引平衡权重
cluster.routing.allocation.balance.threshold: 1.0f  # 平衡阈值

# 磁盘水位线配置
cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: 85%   # 低水位线
cluster.routing.allocation.disk.watermark.high: 90%  # 高水位线
cluster.routing.allocation.disk.watermark.flood_stage: 95% # 洪水线

# 分片大小限制
cluster.routing.allocation.total_shards_per_node: 1000
</div><p id="z5rww9_52"><span class="control" id="z5rww9_59">分配感知配置：</span></p><div class="code-block" data-lang="yaml">
# 机架感知配置
node.attr.rack: rack1
cluster.routing.allocation.awareness.attributes: rack
cluster.routing.allocation.awareness.force.rack.values: rack1,rack2,rack3

# 区域感知配置  
node.attr.zone: zone1
cluster.routing.allocation.awareness.attributes: zone
cluster.routing.allocation.awareness.force.zone.values: zone1,zone2

# 节点类型感知
node.attr.node_type: hot
cluster.routing.allocation.awareness.attributes: node_type
</div><p id="z5rww9_54"><span class="control" id="z5rww9_60">动态分片分配控制：</span></p><div class="code-block" data-lang="bash">
# 临时禁用分片分配
PUT /_cluster/settings
{
  &quot;transient&quot;: {
    &quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;
  }
}

# 设置分片分配过滤器
PUT /_cluster/settings
{
  &quot;persistent&quot;: {
    &quot;cluster.routing.allocation.exclude._ip&quot;: &quot;192.168.1.100&quot;
  }
}

# 强制分片重平衡
POST /_cluster/reroute
{
  &quot;commands&quot;: [
    {
      &quot;move&quot;: {
        &quot;index&quot;: &quot;my_index&quot;,
        &quot;shard&quot;: 0,
        &quot;from_node&quot;: &quot;node1&quot;,
        &quot;to_node&quot;: &quot;node2&quot;
      }
    }
  ]
}

# 手动分配未分配的分片
POST /_cluster/reroute
{
  &quot;commands&quot;: [
    {
      &quot;allocate_primary&quot;: {
        &quot;index&quot;: &quot;my_index&quot;,
        &quot;shard&quot;: 0,
        &quot;node&quot;: &quot;node1&quot;,
        &quot;accept_data_loss&quot;: true
      }
    }
  ]
}
</div></section><section class="chapter"><h3 id="q4-es" data-toc="q4-es">Q4: 如何监控和管理ES集群的健康状态？</h3><p id="z5rww9_61"><span class="control" id="z5rww9_70">答案：</span></p><p id="z5rww9_62"><span class="control" id="z5rww9_71">ES集群健康监控体系：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 766.453125 644"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="766.453125" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES集群监控体系" class="cluster"><rect height="628" width="750.453125" y="8" x="8" style=""></rect><g transform="translate(326.9921875, 8)" class="cluster-label"><foreignObject height="24" width="112.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES集群监控体系</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M137.265,295L154.247,261.5C171.229,228,205.193,161,225.299,127.5C245.406,94,251.656,94,257.24,94C262.823,94,267.74,94,270.198,94L272.656,94"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_C_1" d="M164.639,295L177.058,286.833C189.478,278.667,214.317,262.333,229.862,254.167C245.406,246,251.656,246,257.24,246C262.823,246,267.74,246,270.198,246L272.656,246"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_D_2" d="M164.639,349L177.058,357.167C189.478,365.333,214.317,381.667,229.862,389.833C245.406,398,251.656,398,257.24,398C262.823,398,267.74,398,270.198,398L272.656,398"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_E_3" d="M137.265,349L154.247,382.5C171.229,416,205.193,483,225.299,516.5C245.406,550,251.656,550,257.24,550C262.823,550,267.74,550,270.198,550L272.656,550"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_4" d="M432.813,94L439.063,94C445.313,94,457.813,94,467.188,94C476.563,94,482.813,94,488.396,94C493.979,94,498.896,94,501.354,94L503.813,94"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_5" d="M432.813,246L439.063,246C445.313,246,457.813,246,469.044,246C480.276,246,490.24,246,499.536,246C508.833,246,517.464,246,521.779,246L526.094,246"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_6" d="M432.813,398L439.063,398C445.313,398,457.813,398,469.562,398C481.311,398,492.31,398,502.642,398C512.974,398,522.639,398,527.472,398L532.305,398"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_E1_7" d="M432.813,550L439.063,550C445.313,550,457.813,550,470.897,550C483.982,550,497.651,550,510.654,550C523.656,550,535.992,550,542.16,550L548.328,550"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(123.578125, 322)" id="flowchart-A-11556" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>集群健康监控</p></span></div></foreignObject></g></g><g transform="translate(354.734375, 94)" id="flowchart-B-11557" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>集群状态监控</p></span></div></foreignObject></g></g><g transform="translate(354.734375, 246)" id="flowchart-C-11559" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>节点状态监控</p></span></div></foreignObject></g></g><g transform="translate(354.734375, 398)" id="flowchart-D-11561" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片状态监控</p></span></div></foreignObject></g></g><g transform="translate(354.734375, 550)" id="flowchart-E-11563" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>性能指标监控</p></span></div></foreignObject></g></g><g transform="translate(614.3828125, 94)" id="flowchart-B1-11565" class="node default"><rect height="102" width="213.140625" y="-51" x="-106.5703125" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-76.5703125, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="153.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Green: 所有分片正常<br>Yellow: 副本分片异常<br>Red: 主分片异常</p></span></div></foreignObject></g></g><g transform="translate(614.3828125, 246)" id="flowchart-C1-11567" class="node default"><rect height="102" width="168.578125" y="-51" x="-84.2890625" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-54.2890625, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="108.578125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>节点角色状态<br>JVM堆内存使用<br>磁盘使用情况</p></span></div></foreignObject></g></g><g transform="translate(614.3828125, 398)" id="flowchart-D1-11569" class="node default"><rect height="102" width="156.15625" y="-51" x="-78.078125" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-48.078125, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片分配状态<br>恢复进度<br>重定位状态</p></span></div></foreignObject></g></g><g transform="translate(614.3828125, 550)" id="flowchart-E1-11571" class="node default"><rect height="102" width="124.109375" y="-51" x="-62.0546875" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>查询性能<br>索引性能<br>聚合性能</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="z5rww9_64"><span class="control" id="z5rww9_72">基础监控命令：</span></p><div class="code-block" data-lang="bash">
# 集群健康检查
GET /_cluster/health
GET /_cluster/health?level=indices  # 索引级别健康状态
GET /_cluster/health?level=shards   # 分片级别健康状态

# 集群状态查看
GET /_cluster/state
GET /_cluster/state/nodes          # 只查看节点信息
GET /_cluster/state/routing_table  # 只查看路由表

# 节点信息查看
GET /_nodes
GET /_nodes/stats                  # 节点统计信息
GET /_nodes/hot_threads           # 热线程分析
GET /_nodes/usage                 # 节点使用情况

# Cat API监控
GET /_cat/health?v                # 集群健康状态
GET /_cat/nodes?v                 # 节点信息
GET /_cat/indices?v               # 索引信息
GET /_cat/shards?v                # 分片信息
GET /_cat/allocation?v            # 分片分配情况
GET /_cat/pending_tasks?v         # 待处理任务
GET /_cat/thread_pool?v           # 线程池状态
</div><p id="z5rww9_66"><span class="control" id="z5rww9_73">详细监控指标：</span></p><div class="code-block" data-lang="bash">
# 集群统计信息
GET /_cluster/stats

# 索引统计信息
GET /_stats
GET /my_index/_stats
GET /my_index/_stats/search,index

# 节点详细统计
GET /_nodes/stats/jvm,process,fs,transport,http

# 任务管理
GET /_tasks                       # 查看运行中的任务
GET /_tasks?detailed=true         # 详细任务信息
POST /_tasks/_cancel              # 取消任务

# 恢复状态监控
GET /_recovery                    # 所有恢复状态
GET /my_index/_recovery           # 特定索引恢复状态
GET /_cat/recovery?v&amp;active_only  # 只显示活跃恢复
</div><p id="z5rww9_68"><span class="control" id="z5rww9_74">性能监控指标配置：</span></p><div class="code-block" data-lang="json">
// 监控告警规则示例
{
  &quot;cluster_health&quot;: {
    &quot;red_status&quot;: &quot;CRITICAL&quot;,
    &quot;yellow_status&quot;: &quot;WARNING&quot;
  },
  &quot;node_metrics&quot;: {
    &quot;jvm_heap_usage&quot;: {
      &quot;warning&quot;: &quot;75%&quot;,
      &quot;critical&quot;: &quot;85%&quot;
    },
    &quot;disk_usage&quot;: {
      &quot;warning&quot;: &quot;80%&quot;,
      &quot;critical&quot;: &quot;90%&quot;
    },
    &quot;cpu_usage&quot;: {
      &quot;warning&quot;: &quot;80%&quot;,
      &quot;critical&quot;: &quot;90%&quot;
    }
  },
  &quot;performance_metrics&quot;: {
    &quot;search_latency&quot;: {
      &quot;warning&quot;: &quot;100ms&quot;,
      &quot;critical&quot;: &quot;500ms&quot;
    },
    &quot;index_latency&quot;: {
      &quot;warning&quot;: &quot;50ms&quot;, 
      &quot;critical&quot;: &quot;200ms&quot;
    },
    &quot;queue_size&quot;: {
      &quot;warning&quot;: &quot;1000&quot;,
      &quot;critical&quot;: &quot;5000&quot;
    }
  }
}
</div></section></section><section class="chapter"><h2 id="z5rww9_7" data-toc="z5rww9_7">🚨 故障恢复</h2><section class="chapter"><h3 id="q5-es" data-toc="q5-es">Q5: ES集群出现故障时如何进行诊断和恢复？常见故障场景有哪些？</h3><p id="z5rww9_77"><span class="control" id="z5rww9_86">答案：</span></p><p id="z5rww9_78"><span class="control" id="z5rww9_87">常见故障场景和诊断：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 462.28125 716"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="462.28125" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES常见故障类型" class="cluster"><rect height="700" width="446.28125" y="8" x="8" style=""></rect><g transform="translate(174.90625, 8)" class="cluster-label"><foreignObject height="24" width="112.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES常见故障类型</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M169.609,106L175.859,106C182.109,106,194.609,106,204.652,106C214.694,106,222.279,106,229.197,106C236.115,106,242.366,106,245.492,106L248.617,106"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M169.609,282L175.859,282C182.109,282,194.609,282,205.32,282C216.03,282,224.951,282,233.204,282C241.458,282,249.046,282,252.839,282L256.633,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M169.609,458L175.859,458C182.109,458,194.609,458,204.652,458C214.694,458,222.279,458,229.197,458C236.115,458,242.366,458,245.492,458L248.617,458"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_3" d="M169.609,622L175.859,622C182.109,622,194.609,622,203.984,622C213.359,622,219.609,622,225.193,622C230.776,622,235.693,622,238.151,622L240.609,622"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(107.5546875, 106)" id="flowchart-A-11613" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>集群故障</p></span></div></foreignObject></g></g><g transform="translate(330.6953125, 106)" id="flowchart-A1-11614" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="fill:#ffcdd2 !important" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>集群红色状态<br>节点离线<br>脑裂问题<br>选主失败</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 282)" id="flowchart-B-11615" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>性能故障</p></span></div></foreignObject></g></g><g transform="translate(330.6953125, 282)" id="flowchart-B1-11616" class="node default"><rect height="126" width="140.125" y="-63" x="-70.0625" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-40.0625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>查询缓慢<br>索引性能差<br>内存不足<br>CPU高负载</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 458)" id="flowchart-C-11617" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>数据故障</p></span></div></foreignObject></g></g><g transform="translate(330.6953125, 458)" id="flowchart-C1-11618" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="fill:#ffebee !important" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片丢失<br>数据损坏<br>磁盘空间不足<br>索引损坏</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 622)" id="flowchart-D-11619" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>网络故障</p></span></div></foreignObject></g></g><g transform="translate(330.6953125, 622)" id="flowchart-D1-11620" class="node default"><rect height="102" width="172.171875" y="-51" x="-86.0859375" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-56.0859375, -36)" style="" class="label"><rect></rect><foreignObject height="72" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>节点通信异常<br>客户端连接失败<br>超时问题</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="z5rww9_80"><span class="control" id="z5rww9_88">故障诊断流程：</span></p><ol class="list _decimal" id="z5rww9_81" type="1"><li class="list__item" id="z5rww9_89"><p id="z5rww9_92"><span class="control" id="z5rww9_94">集群红色状态诊断</span></p><div class="code-block" data-lang="bash">
# 检查集群状态
GET /_cluster/health?level=shards

# 查看未分配的分片
GET /_cat/shards?v&amp;h=index,shard,prirep,state,unassigned.reason

# 分析分配失败原因
GET /_cluster/allocation/explain
{
  &quot;index&quot;: &quot;my_index&quot;,
  &quot;shard&quot;: 0,
  &quot;primary&quot;: true
}

# 查看集群日志
tail -f /var/log/elasticsearch/my-cluster.log
</div></li><li class="list__item" id="z5rww9_90"><p id="z5rww9_95"><span class="control" id="z5rww9_97">节点离线问题处理</span></p><div class="code-block" data-lang="bash">
# 检查节点状态
GET /_cat/nodes?v

# 查看节点详细信息
GET /_nodes/node1/stats

# 检查节点连接
curl -X GET &quot;node1:9200/_cluster/health&quot;

# 强制移除失效节点（谨慎使用）
DELETE /_cluster/voting_config_exclusions/node1
</div></li><li class="list__item" id="z5rww9_91"><p id="z5rww9_98"><span class="control" id="z5rww9_100">分片恢复问题</span></p><div class="code-block" data-lang="bash">
# 查看恢复状态
GET /_recovery?human&amp;detailed=true

# 查看恢复设置
GET /_cluster/settings?include_defaults=true&amp;filter_path=*.recovery.*

# 调整恢复速度
PUT /_cluster/settings
{
  &quot;transient&quot;: {
    &quot;indices.recovery.max_bytes_per_sec&quot;: &quot;100mb&quot;,
    &quot;cluster.routing.allocation.node_concurrent_recoveries&quot;: 4
  }
}
</div></li></ol><p id="z5rww9_82"><span class="control" id="z5rww9_101">故障恢复策略：</span></p><ol class="list _decimal" id="z5rww9_83" type="1"><li class="list__item" id="z5rww9_102"><p id="z5rww9_104"><span class="control" id="z5rww9_106">数据恢复</span></p><div class="code-block" data-lang="bash">
# 从快照恢复
POST /_snapshot/my_backup/snapshot_1/_restore
{
  &quot;indices&quot;: &quot;index_1,index_2&quot;,
  &quot;ignore_unavailable&quot;: true,
  &quot;include_global_state&quot;: false,
  &quot;rename_pattern&quot;: &quot;index_(.+)&quot;,
  &quot;rename_replacement&quot;: &quot;restored_index_$1&quot;,
  &quot;include_aliases&quot;: false
}

# 强制分配主分片（数据可能丢失）
POST /_cluster/reroute
{
  &quot;commands&quot;: [
    {
      &quot;allocate_empty_primary&quot;: {
        &quot;index&quot;: &quot;my_index&quot;,
        &quot;shard&quot;: 0,
        &quot;node&quot;: &quot;node1&quot;,
        &quot;accept_data_loss&quot;: true
      }
    }
  ]
}
</div></li><li class="list__item" id="z5rww9_103"><p id="z5rww9_107"><span class="control" id="z5rww9_109">索引修复</span></p><div class="code-block" data-lang="bash">
# 关闭索引
POST /corrupted_index/_close

# 检查索引
POST /corrupted_index/_forcemerge?max_num_segments=1

# 重新打开索引
POST /corrupted_index/_open

# 刷新索引
POST /corrupted_index/_refresh
</div></li></ol><p id="z5rww9_84"><span class="control" id="z5rww9_110">应急处理手册：</span></p><div class="code-block" data-lang="yaml">
# 应急响应流程
1. 故障识别和评估
   - 检查集群健康状态
   - 确定影响范围
   - 评估数据丢失风险

2. 临时措施
   - 停止写入操作
   - 增加副本节点
   - 调整分片分配策略

3. 根本原因分析
   - 分析日志文件
   - 检查系统资源
   - 网络连接诊断

4. 恢复操作
   - 数据恢复
   - 服务重启
   - 验证数据完整性

5. 预防措施
   - 更新监控规则
   - 优化配置参数
   - 制定备份策略
</div></section><section class="chapter"><h3 id="q6-es" data-toc="q6-es">Q6: 如何设计ES集群的备份和灾备策略？</h3><p id="z5rww9_111"><span class="control" id="z5rww9_120">答案：</span></p><p id="z5rww9_112"><span class="control" id="z5rww9_121">ES备份策略设计：</span></p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 446.265625 740"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="446.265625" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="ES备份和灾备策略" class="cluster"><rect height="724" width="430.265625" y="8" x="8" style=""></rect><g transform="translate(158.890625, 8)" class="cluster-label"><foreignObject height="24" width="128.484375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>ES备份和灾备策略</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_A1_0" d="M169.609,106L175.859,106C182.109,106,194.609,106,203.984,106C213.359,106,219.609,106,225.193,106C230.776,106,235.693,106,238.151,106L240.609,106"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_1" d="M169.609,282L175.859,282C182.109,282,194.609,282,205.32,282C216.03,282,224.951,282,233.204,282C241.458,282,249.046,282,252.839,282L256.633,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_2" d="M169.609,458L175.859,458C182.109,458,194.609,458,204.652,458C214.695,458,222.281,458,229.201,458C236.12,458,242.372,458,245.499,458L248.625,458"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_3" d="M169.609,634L175.859,634C182.109,634,194.609,634,205.32,634C216.03,634,224.951,634,233.204,634C241.458,634,249.046,634,252.839,634L256.633,634"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(107.5546875, 106)" id="flowchart-A-11652" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#e1f5fe !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>备份策略</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 106)" id="flowchart-A1-11653" class="node default"><rect height="126" width="156.15625" y="-63" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>快照备份<br>增量备份<br>跨集群复制<br>索引生命周期</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 282)" id="flowchart-B-11654" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#c8e6c9 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>存储策略</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 282)" id="flowchart-B1-11655" class="node default"><rect height="126" width="124.109375" y="-63" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>本地存储<br>远程存储<br>云存储<br>多地备份</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 458)" id="flowchart-C-11656" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#fff3e0 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>恢复策略</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 458)" id="flowchart-C1-11657" class="node default"><rect height="126" width="140.125" y="-63" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>全量恢复<br>部分恢复<br>时间点恢复<br>跨集群恢复</p></span></div></foreignObject></g></g><g transform="translate(107.5546875, 634)" id="flowchart-D-11658" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="fill:#f3e5f5 !important" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>灾备切换</p></span></div></foreignObject></g></g><g transform="translate(322.6875, 634)" id="flowchart-D1-11659" class="node default"><rect height="126" width="124.109375" y="-63" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -48)" style="" class="label"><rect></rect><foreignObject height="96" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>主备切换<br>故障转移<br>数据同步<br>服务降级</p></span></div></foreignObject></g></g></g></g></g></g></g></svg><p id="z5rww9_114"><span class="control" id="z5rww9_122">快照备份配置：</span></p><div class="code-block" data-lang="bash">
# 配置快照仓库
PUT /_snapshot/my_backup
{
  &quot;type&quot;: &quot;fs&quot;,
  &quot;settings&quot;: {
    &quot;location&quot;: &quot;/backup/elasticsearch&quot;,
    &quot;compress&quot;: true,
    &quot;chunk_size&quot;: &quot;64mb&quot;
  }
}

# S3快照仓库配置
PUT /_snapshot/s3_backup
{
  &quot;type&quot;: &quot;s3&quot;,
  &quot;settings&quot;: {
    &quot;bucket&quot;: &quot;my-elasticsearch-backups&quot;,
    &quot;region&quot;: &quot;us-east-1&quot;, 
    &quot;base_path&quot;: &quot;production-cluster&quot;,
    &quot;compress&quot;: true,
    &quot;server_side_encryption&quot;: true
  }
}

# 创建快照策略
PUT /_slm/policy/daily_backup
{
  &quot;schedule&quot;: &quot;0 2 * * *&quot;,
  &quot;name&quot;: &quot;&lt;daily-{now/d}&gt;&quot;,
  &quot;repository&quot;: &quot;my_backup&quot;,
  &quot;config&quot;: {
    &quot;indices&quot;: [&quot;logs-*&quot;, &quot;metrics-*&quot;],
    &quot;ignore_unavailable&quot;: false,
    &quot;include_global_state&quot;: true
  },
  &quot;retention&quot;: {
    &quot;expire_after&quot;: &quot;30d&quot;,
    &quot;min_count&quot;: 5,
    &quot;max_count&quot;: 50
  }
}

# 手动创建快照
PUT /_snapshot/my_backup/snapshot_1
{
  &quot;indices&quot;: &quot;index_1,index_2&quot;,
  &quot;ignore_unavailable&quot;: true,
  &quot;include_global_state&quot;: false,
  &quot;metadata&quot;: {
    &quot;taken_by&quot;: &quot;admin&quot;,
    &quot;taken_because&quot;: &quot;daily backup&quot;
  }
}
</div><p id="z5rww9_116"><span class="control" id="z5rww9_123">跨集群复制（CCR）配置：</span></p><div class="code-block" data-lang="bash">
# 在从集群配置远程集群
PUT /_cluster/settings
{
  &quot;persistent&quot;: {
    &quot;cluster&quot;: {
      &quot;remote&quot;: {
        &quot;leader_cluster&quot;: {
          &quot;seeds&quot;: [&quot;leader-node1:9300&quot;, &quot;leader-node2:9300&quot;]
        }
      }
    }
  }
}

# 创建跨集群复制
PUT /follower_index/_ccr/follow
{
  &quot;remote_cluster&quot;: &quot;leader_cluster&quot;,
  &quot;leader_index&quot;: &quot;leader_index&quot;,
  &quot;settings&quot;: {
    &quot;index.number_of_replicas&quot;: 0
  },
  &quot;max_read_request_operation_count&quot;: 5120,
  &quot;max_outstanding_read_requests&quot;: 12,
  &quot;max_read_request_size&quot;: &quot;32mb&quot;,
  &quot;max_write_request_operation_count&quot;: 5120,
  &quot;max_write_request_size&quot;: &quot;9mb&quot;,
  &quot;max_outstanding_write_requests&quot;: 9,
  &quot;max_write_buffer_count&quot;: 2147483647,
  &quot;max_write_buffer_size&quot;: &quot;512mb&quot;,
  &quot;max_retry_delay&quot;: &quot;500ms&quot;,
  &quot;read_poll_timeout&quot;: &quot;1m&quot;
}

# 自动跟随索引模式
PUT /_ccr/auto_follow/my_auto_follow_pattern
{
  &quot;remote_cluster&quot;: &quot;leader_cluster&quot;,
  &quot;leader_index_patterns&quot;: [&quot;logs-*&quot;, &quot;metrics-*&quot;],
  &quot;follow_index_pattern&quot;: &quot;{{leader_index}}-copy&quot;
}
</div><p id="z5rww9_118"><span class="control" id="z5rww9_124">灾备切换流程：</span></p><div class="code-block" data-lang="bash">
# 1. 故障检测和评估
GET /_cluster/health
GET /_cat/nodes?v

# 2. 停止跟随索引（如果使用CCR）
POST /follower_index/_ccr/pause_follow

# 3. 提升跟随索引为独立索引
POST /follower_index/_ccr/unfollow

# 4. 应用配置更改
PUT /follower_index/_settings
{
  &quot;index&quot;: {
    &quot;number_of_replicas&quot;: 1
  }
}

# 5. 验证数据完整性
GET /follower_index/_count
GET /follower_index/_search?size=0

# 6. 切换应用流量
# 更新应用配置指向备份集群

# 7. 建立新的复制关系（恢复后）
PUT /new_follower_index/_ccr/follow
{
  &quot;remote_cluster&quot;: &quot;recovered_leader_cluster&quot;,
  &quot;leader_index&quot;: &quot;original_index&quot;
}
</div></section></section><section class="chapter"><h2 id="z5rww9_8" data-toc="z5rww9_8">💡 面试技巧</h2><section class="chapter"><h3 id="z5rww9_125" data-toc="z5rww9_125">高频考点</h3><ol class="list _decimal" id="z5rww9_128" type="1"><li class="list__item" id="z5rww9_129"><p id="z5rww9_134"><span class="control" id="z5rww9_135">集群发现机制</span> ：节点发现、选主算法、脑裂预防</p></li><li class="list__item" id="z5rww9_130"><p id="z5rww9_136"><span class="control" id="z5rww9_137">分片管理</span> ：分片分配策略、重平衡机制、故障转移</p></li><li class="list__item" id="z5rww9_131"><p id="z5rww9_138"><span class="control" id="z5rww9_139">监控运维</span> ：健康状态监控、性能指标、故障诊断</p></li><li class="list__item" id="z5rww9_132"><p id="z5rww9_140"><span class="control" id="z5rww9_141">备份恢复</span> ：快照策略、灾备方案、数据恢复</p></li><li class="list__item" id="z5rww9_133"><p id="z5rww9_142"><span class="control" id="z5rww9_143">安全配置</span> ：认证授权、网络安全、审计日志</p></li></ol></section><section class="chapter"><h3 id="z5rww9_126" data-toc="z5rww9_126">回答策略</h3><ol class="list _decimal" id="z5rww9_144" type="1"><li class="list__item" id="z5rww9_145"><p id="z5rww9_149"><span class="control" id="z5rww9_150">原理解释</span> ：深入理解ES集群的分布式原理</p></li><li class="list__item" id="z5rww9_146"><p id="z5rww9_151"><span class="control" id="z5rww9_152">实战经验</span> ：结合实际运维经验说明问题处理</p></li><li class="list__item" id="z5rww9_147"><p id="z5rww9_153"><span class="control" id="z5rww9_154">最佳实践</span> ：提及业界认可的集群管理方法</p></li><li class="list__item" id="z5rww9_148"><p id="z5rww9_155"><span class="control" id="z5rww9_156">故障处理</span> ：能够快速定位和解决常见问题</p></li></ol></section><section class="chapter"><h3 id="z5rww9_127" data-toc="z5rww9_127">常见运维问题</h3><ol class="list _decimal" id="z5rww9_157" type="1"><li class="list__item" id="z5rww9_160"><p id="z5rww9_164"><span class="control" id="z5rww9_165">集群红色状态</span> ：分片分配失败、数据丢失</p></li><li class="list__item" id="z5rww9_161"><p id="z5rww9_166"><span class="control" id="z5rww9_167">性能问题</span> ：查询缓慢、内存不足、CPU高负载</p></li><li class="list__item" id="z5rww9_162"><p id="z5rww9_168"><span class="control" id="z5rww9_169">容量规划</span> ：分片大小、节点数量、存储容量</p></li><li class="list__item" id="z5rww9_163"><p id="z5rww9_170"><span class="control" id="z5rww9_171">版本升级</span> ：滚动升级、兼容性检查、数据迁移</p></li></ol><p id="z5rww9_159"><span class="control" id="z5rww9_172">学习建议</span> ：ES集群管理是ES生产环境应用的关键技能，建议通过搭建真实的多节点集群来实践各种管理操作，重点掌握故障诊断和恢复的实战技能，同时要熟悉ES的监控和备份最佳实践。</p></section></section><div class="last-modified">09 六月 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="es查询与聚合qa.html" class="navigation-links__prev">ES查询与聚合QA</a><a href="es性能优化qa.html" class="navigation-links__next">ES性能优化QA</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>