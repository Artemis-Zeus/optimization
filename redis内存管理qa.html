<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-06-10T01:18:26.3245104"><title>Redis 内存管理 QA | 技术知识库</title><script type="application/json" id="virtual-toc-data">[{"id":"q1-redis","level":0,"title":"Q1: Redis有哪些内存淘汰策略？各自的适用场景是什么？","anchor":"#q1-redis"},{"id":"q2-lru-lfu-redis","level":0,"title":"Q2: LRU和LFU算法的实现原理是什么？Redis是如何优化的？","anchor":"#q2-lru-lfu-redis"},{"id":"q3-redis-key","level":0,"title":"Q3: Redis的过期策略是什么？如何避免大量key同时过期？","anchor":"#q3-redis-key"},{"id":"q4-redis","level":0,"title":"Q4: 如何监控和优化Redis内存使用？有哪些内存优化技巧？","anchor":"#q4-redis"},{"id":"q5-redis","level":0,"title":"Q5: 什么是内存碎片？如何处理Redis的内存碎片问题？","anchor":"#q5-redis"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Redis 内存管理 QA | 技术知识库"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="技术知识库 Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/redis内存管理qa.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Redis 内存管理 QA | 技术知识库"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/redis内存管理qa.html#webpage",
    "url": "writerside-documentation/redis内存管理qa.html",
    "name": "Redis 内存管理 QA | 技术知识库",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "技术知识库 Help"
}</script><!-- End Schema.org --></head><body data-id="Redis内存管理QA" data-main-title="Redis 内存管理 QA" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Redis面试大纲.md|Redis 技术大纲"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>技术知识库  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Redis内存管理QA" id="Redis内存管理QA.md">Redis 内存管理 QA</h1><section class="chapter"><h2 id="q1-redis" data-toc="q1-redis">Q1: Redis有哪些内存淘汰策略？各自的适用场景是什么？</h2><p id="z4faq71_8"><span class="control" id="z4faq71_12">A1:</span> Redis提供了8种内存淘汰策略，分为两大类：</p><section class="chapter"><h3 id="1-key" data-toc="1-key">1. 针对所有key的策略</h3><section class="chapter"><h4 id="allkeys-lru" data-toc="allkeys-lru">allkeys-lru</h4><ul class="list _bullet" id="z4faq71_16"><li class="list__item" id="z4faq71_17"><p id="z4faq71_20"><span class="control" id="z4faq71_21">原理</span>: 在所有key中淘汰最近最少使用的key</p></li><li class="list__item" id="z4faq71_18"><p id="z4faq71_22"><span class="control" id="z4faq71_23">适用场景</span>: 通用缓存场景，访问模式符合局部性原理</p></li><li class="list__item" id="z4faq71_19"><p id="z4faq71_24"><span class="control" id="z4faq71_25">优点</span>: 保留热点数据，命中率高</p></li></ul></section><section class="chapter"><h4 id="allkeys-lfu-redis-4-0" data-toc="allkeys-lfu-redis-4-0">allkeys-lfu (Redis 4.0+)</h4><ul class="list _bullet" id="z4faq71_26"><li class="list__item" id="z4faq71_27"><p id="z4faq71_30"><span class="control" id="z4faq71_31">原理</span>: 在所有key中淘汰使用频率最低的key</p></li><li class="list__item" id="z4faq71_28"><p id="z4faq71_32"><span class="control" id="z4faq71_33">适用场景</span>: 访问频率差异明显的场景</p></li><li class="list__item" id="z4faq71_29"><p id="z4faq71_34"><span class="control" id="z4faq71_35">优点</span>: 比LRU更精确地识别热点数据</p></li></ul></section><section class="chapter"><h4 id="allkeys-random" data-toc="allkeys-random">allkeys-random</h4><ul class="list _bullet" id="z4faq71_36"><li class="list__item" id="z4faq71_37"><p id="z4faq71_40"><span class="control" id="z4faq71_41">原理</span>: 在所有key中随机淘汰</p></li><li class="list__item" id="z4faq71_38"><p id="z4faq71_42"><span class="control" id="z4faq71_43">适用场景</span>: 访问模式完全随机的场景</p></li><li class="list__item" id="z4faq71_39"><p id="z4faq71_44"><span class="control" id="z4faq71_45">优点</span>: 实现简单，性能好</p></li></ul></section></section><section class="chapter"><h3 id="2-key" data-toc="2-key">2. 针对设置过期时间key的策略</h3><section class="chapter"><h4 id="volatile-lru" data-toc="volatile-lru">volatile-lru</h4><ul class="list _bullet" id="z4faq71_50"><li class="list__item" id="z4faq71_51"><p id="z4faq71_53"><span class="control" id="z4faq71_54">原理</span>: 在设置了过期时间的key中淘汰最近最少使用的</p></li><li class="list__item" id="z4faq71_52"><p id="z4faq71_55"><span class="control" id="z4faq71_56">适用场景</span>: 部分数据需要永久保存，部分数据可以淘汰</p></li></ul></section><section class="chapter"><h4 id="volatile-lfu-redis-4-0" data-toc="volatile-lfu-redis-4-0">volatile-lfu (Redis 4.0+)</h4><ul class="list _bullet" id="z4faq71_57"><li class="list__item" id="z4faq71_58"><p id="z4faq71_60"><span class="control" id="z4faq71_61">原理</span>: 在设置了过期时间的key中淘汰使用频率最低的</p></li><li class="list__item" id="z4faq71_59"><p id="z4faq71_62"><span class="control" id="z4faq71_63">适用场景</span>: 过期key中访问频率差异明显</p></li></ul></section><section class="chapter"><h4 id="volatile-random" data-toc="volatile-random">volatile-random</h4><ul class="list _bullet" id="z4faq71_64"><li class="list__item" id="z4faq71_65"><p id="z4faq71_67"><span class="control" id="z4faq71_68">原理</span>: 在设置了过期时间的key中随机淘汰</p></li><li class="list__item" id="z4faq71_66"><p id="z4faq71_69"><span class="control" id="z4faq71_70">适用场景</span>: 过期key访问模式随机</p></li></ul></section><section class="chapter"><h4 id="volatile-ttl" data-toc="volatile-ttl">volatile-ttl</h4><ul class="list _bullet" id="z4faq71_71"><li class="list__item" id="z4faq71_72"><p id="z4faq71_74"><span class="control" id="z4faq71_75">原理</span>: 淘汰即将过期的key（TTL最小的）</p></li><li class="list__item" id="z4faq71_73"><p id="z4faq71_76"><span class="control" id="z4faq71_77">适用场景</span>: 希望优先淘汰即将过期的数据</p></li></ul></section></section><section class="chapter"><h3 id="3" data-toc="3">3. 特殊策略</h3><section class="chapter"><h4 id="noeviction" data-toc="noeviction">noeviction (默认)</h4><ul class="list _bullet" id="z4faq71_79"><li class="list__item" id="z4faq71_81"><p id="z4faq71_84"><span class="control" id="z4faq71_85">原理</span>: 不淘汰任何key，内存满时返回错误</p></li><li class="list__item" id="z4faq71_82"><p id="z4faq71_86"><span class="control" id="z4faq71_87">适用场景</span>: 数据不能丢失的场景</p></li><li class="list__item" id="z4faq71_83"><p id="z4faq71_88"><span class="control" id="z4faq71_89">缺点</span>: 可能导致写操作失败</p></li></ul><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1642.21875 430"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1642.21875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M941.996,41.743L833.702,49.286C725.409,56.828,508.822,71.914,400.528,81.54C292.234,91.167,292.234,95.333,292.234,98.833C292.234,102.333,292.234,105.167,292.234,106.583L292.234,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_C_1" d="M1038.801,62L1038.801,66.167C1038.801,70.333,1038.801,78.667,1038.801,84.917C1038.801,91.167,1038.801,95.333,1038.801,98.833C1038.801,102.333,1038.801,105.167,1038.801,106.583L1038.801,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_D_2" d="M1135.605,44.534L1207.469,51.612C1279.333,58.689,1423.061,72.845,1494.925,82.006C1566.789,91.167,1566.789,95.333,1566.789,98.833C1566.789,102.333,1566.789,105.167,1566.789,106.583L1566.789,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_3" d="M217.805,157.774L195.85,163.312C173.896,168.849,129.987,179.925,108.033,187.546C86.078,195.167,86.078,199.333,86.078,202.833C86.078,206.333,86.078,209.167,86.078,210.583L86.078,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B2_4" d="M292.234,166L292.234,170.167C292.234,174.333,292.234,182.667,292.234,188.917C292.234,195.167,292.234,199.333,292.234,202.833C292.234,206.333,292.234,209.167,292.234,210.583L292.234,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B3_5" d="M366.664,157.191L389.72,162.826C412.776,168.46,458.888,179.73,481.944,187.448C505,195.167,505,199.333,505,202.833C505,206.333,505,209.167,505,210.583L505,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_6" d="M964.371,151.142L923.649,157.785C882.927,164.428,801.483,177.714,760.761,186.44C720.039,195.167,720.039,199.333,720.039,202.833C720.039,206.333,720.039,209.167,720.039,210.583L720.039,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C2_7" d="M982.454,166L973.759,170.167C965.063,174.333,947.672,182.667,938.977,188.917C930.281,195.167,930.281,199.333,930.281,202.833C930.281,206.333,930.281,209.167,930.281,210.583L930.281,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C3_8" d="M1095.147,166L1103.843,170.167C1112.538,174.333,1129.929,182.667,1138.625,188.917C1147.32,195.167,1147.32,199.333,1147.32,202.833C1147.32,206.333,1147.32,209.167,1147.32,210.583L1147.32,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C4_9" d="M1113.23,150.796L1155.511,157.496C1197.792,164.197,1282.353,177.599,1324.633,186.383C1366.914,195.167,1366.914,199.333,1366.914,202.833C1366.914,206.333,1366.914,209.167,1366.914,210.583L1366.914,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_10" d="M1566.789,166L1566.789,170.167C1566.789,174.333,1566.789,182.667,1566.789,188.917C1566.789,195.167,1566.789,199.333,1566.789,202.833C1566.789,206.333,1566.789,209.167,1566.789,210.583L1566.789,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B1_B1_1_11" d="M86.078,294L86.078,298.167C86.078,302.333,86.078,310.667,86.078,316.917C86.078,323.167,86.078,327.333,86.078,330.833C86.078,334.333,86.078,337.167,86.078,338.583L86.078,340"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B2_B2_1_12" d="M292.234,294L292.234,298.167C292.234,302.333,292.234,310.667,292.234,316.917C292.234,323.167,292.234,327.333,292.234,330.833C292.234,334.333,292.234,337.167,292.234,338.583L292.234,340"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C1_C1_1_13" d="M720.039,294L720.039,298.167C720.039,302.333,720.039,310.667,720.039,316.917C720.039,323.167,720.039,327.333,720.039,330.833C720.039,334.333,720.039,337.167,720.039,338.583L720.039,340"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C4_C4_1_14" d="M1366.914,294L1366.914,298.167C1366.914,302.333,1366.914,310.667,1366.914,316.917C1366.914,323.167,1366.914,327.333,1366.914,330.833C1366.914,334.333,1366.914,337.167,1366.914,338.583L1366.914,340"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(1038.80078125, 35)" id="flowchart-A-9665" class="node default"><rect height="54" width="193.609375" y="-27" x="-96.8046875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-66.8046875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="133.609375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Redis内存淘汰策略</p></span></div></foreignObject></g></g><g transform="translate(292.234375, 139)" id="flowchart-B-9666" class="node default"><rect height="54" width="148.859375" y="-27" x="-74.4296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-44.4296875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="88.859375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>针对所有key</p></span></div></foreignObject></g></g><g transform="translate(1038.80078125, 139)" id="flowchart-C-9668" class="node default"><rect height="54" width="148.859375" y="-27" x="-74.4296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-44.4296875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="88.859375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>针对过期key</p></span></div></foreignObject></g></g><g transform="translate(1566.7890625, 139)" id="flowchart-D-9670" class="node default"><rect height="54" width="108.078125" y="-27" x="-54.0390625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-24.0390625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="48.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>不淘汰</p></span></div></foreignObject></g></g><g transform="translate(86.078125, 255)" id="flowchart-B1-9672" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>allkeys-lru<br>最近最少使用</p></span></div></foreignObject></g></g><g transform="translate(292.234375, 255)" id="flowchart-B2-9674" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>allkeys-lfu<br>使用频率最低</p></span></div></foreignObject></g></g><g transform="translate(505, 255)" id="flowchart-B3-9676" class="node default"><rect height="78" width="169.375" y="-39" x="-84.6875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-54.6875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="109.375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>allkeys-random<br>随机淘汰</p></span></div></foreignObject></g></g><g transform="translate(720.0390625, 255)" id="flowchart-C1-9678" class="node default"><rect height="78" width="160.703125" y="-39" x="-80.3515625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-50.3515625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="100.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>volatile-lru<br>过期key中LRU</p></span></div></foreignObject></g></g><g transform="translate(930.28125, 255)" id="flowchart-C2-9680" class="node default"><rect height="78" width="159.78125" y="-39" x="-79.890625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-49.890625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="99.78125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>volatile-lfu<br>过期key中LFU</p></span></div></foreignObject></g></g><g transform="translate(1147.3203125, 255)" id="flowchart-C3-9682" class="node default"><rect height="78" width="174.296875" y="-39" x="-87.1484375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-57.1484375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="114.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>volatile-random<br>过期key中随机</p></span></div></foreignObject></g></g><g transform="translate(1366.9140625, 255)" id="flowchart-C4-9684" class="node default"><rect height="78" width="164.890625" y="-39" x="-82.4453125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-52.4453125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="104.890625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>volatile-ttl<br>即将过期的key</p></span></div></foreignObject></g></g><g transform="translate(1566.7890625, 255)" id="flowchart-D1-9686" class="node default"><rect height="78" width="134.859375" y="-39" x="-67.4296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-37.4296875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="74.859375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>noeviction<br>返回错误</p></span></div></foreignObject></g></g><g transform="translate(86.078125, 383)" id="flowchart-B1_1-9688" class="node default"><rect height="78" width="140.125" y="-39" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>通用缓存<br>局部性访问</p></span></div></foreignObject></g></g><g transform="translate(292.234375, 383)" id="flowchart-B2_1-9690" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>频率差异明显<br>长期热点数据</p></span></div></foreignObject></g></g><g transform="translate(720.0390625, 383)" id="flowchart-C1_1-9692" class="node default"><rect height="78" width="172.171875" y="-39" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>部分数据永久<br>部分数据可淘汰</p></span></div></foreignObject></g></g><g transform="translate(1366.9140625, 383)" id="flowchart-C4_1-9694" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>优先清理<br>即将过期数据</p></span></div></foreignObject></g></g></g></g></g></svg></section></section></section><section class="chapter"><h2 id="q2-lru-lfu-redis" data-toc="q2-lru-lfu-redis">Q2: LRU和LFU算法的实现原理是什么？Redis是如何优化的？</h2><p id="z4faq71_90"><span class="control" id="z4faq71_94">A2:</span></p><section class="chapter"><h3 id="lru" data-toc="lru">传统LRU算法</h3><p id="z4faq71_95"><span class="control" id="z4faq71_96">原理</span>: 维护一个双向链表，最近访问的节点移到头部，淘汰时从尾部删除。 <span class="control" id="z4faq71_97">问题</span>: 需要额外的内存存储链表指针，内存开销大。</p></section><section class="chapter"><h3 id="redis-lru" data-toc="redis-lru">Redis的近似LRU算法</h3><p id="z4faq71_98">Redis使用近似LRU算法来减少内存开销：</p><section class="chapter"><h4 id="z4faq71_99" data-toc="z4faq71_99">实现原理：</h4><ol class="list _decimal" id="z4faq71_101" type="1"><li class="list__item" id="z4faq71_102"><p id="z4faq71_105"><span class="control" id="z4faq71_106">24位时间戳</span>: 每个key的redisObject中存储24位的访问时间戳</p></li><li class="list__item" id="z4faq71_103"><p id="z4faq71_107"><span class="control" id="z4faq71_108">采样淘汰</span>: 随机采样一定数量的key，选择其中时间戳最小的淘汰</p></li><li class="list__item" id="z4faq71_104"><p id="z4faq71_109"><span class="control" id="z4faq71_110">采样池优化</span>: 维护一个候选池，提高淘汰精度</p></li></ol></section><section class="chapter"><h4 id="z4faq71_100" data-toc="z4faq71_100">配置参数：</h4><div class="code-block" data-lang="none">
maxmemory-samples 5  # 采样数量，默认5个
</div></section></section><section class="chapter"><h3 id="lfu" data-toc="lfu">LFU算法实现</h3><p id="z4faq71_112">Redis 4.0引入的LFU算法：</p><section class="chapter"><h4 id="z4faq71_113" data-toc="z4faq71_113">实现原理：</h4><ol class="list _decimal" id="z4faq71_115" type="1"><li class="list__item" id="z4faq71_116"><p id="z4faq71_119"><span class="control" id="z4faq71_120">频率计数</span>: 使用8位计数器记录访问频率</p></li><li class="list__item" id="z4faq71_117"><p id="z4faq71_121"><span class="control" id="z4faq71_122">时间衰减</span>: 定期对频率计数进行衰减</p></li><li class="list__item" id="z4faq71_118"><p id="z4faq71_123"><span class="control" id="z4faq71_124">概率增长</span>: 访问时概率性增加计数器</p></li></ol></section><section class="chapter"><h4 id="z4faq71_114" data-toc="z4faq71_114">关键参数：</h4><div class="code-block" data-lang="none">
lfu-log-factor 10      # 频率增长因子
lfu-decay-time 1       # 衰减时间（分钟）
</div><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 2173.921875 372"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="2173.921875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M1257.5,84.263L1173.526,96.386C1089.552,108.509,921.604,132.754,837.63,146.96C753.656,161.167,753.656,165.333,753.656,168.833C753.656,172.333,753.656,175.167,753.656,176.583L753.656,178"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_C_1" d="M1344.926,97L1340.714,107C1336.503,117,1328.079,137,1323.868,149.083C1319.656,161.167,1319.656,165.333,1319.656,168.833C1319.656,172.333,1319.656,175.167,1319.656,176.583L1319.656,178"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_D_2" d="M1455.094,83.853L1542.037,96.044C1628.98,108.235,1802.867,132.618,1889.811,146.892C1976.754,161.167,1976.754,165.333,1976.754,168.833C1976.754,172.333,1976.754,175.167,1976.754,176.583L1976.754,178"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_3" d="M753.656,236L753.656,240.167C753.656,244.333,753.656,252.667,753.656,258.917C753.656,265.167,753.656,269.333,753.656,272.833C753.656,276.333,753.656,279.167,753.656,280.583L753.656,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_4" d="M1240.969,221.483L1199.451,228.069C1157.932,234.655,1074.896,247.828,1033.378,256.497C991.859,265.167,991.859,269.333,991.859,272.833C991.859,276.333,991.859,279.167,991.859,280.583L991.859,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C2_5" d="M1262.922,236L1254.167,240.167C1245.412,244.333,1227.901,252.667,1219.146,258.917C1210.391,265.167,1210.391,269.333,1210.391,272.833C1210.391,276.333,1210.391,279.167,1210.391,280.583L1210.391,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C3_6" d="M1376.39,236L1385.146,240.167C1393.901,244.333,1411.411,252.667,1420.167,258.917C1428.922,265.167,1428.922,269.333,1428.922,272.833C1428.922,276.333,1428.922,279.167,1428.922,280.583L1428.922,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_7" d="M1912.121,218.959L1866.648,225.966C1821.174,232.973,1730.228,246.986,1684.755,256.077C1639.281,265.167,1639.281,269.333,1639.281,272.833C1639.281,276.333,1639.281,279.167,1639.281,280.583L1639.281,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D2_8" d="M1919.073,236L1910.171,240.167C1901.27,244.333,1883.467,252.667,1874.565,258.917C1865.664,265.167,1865.664,269.333,1865.664,272.833C1865.664,276.333,1865.664,279.167,1865.664,280.583L1865.664,282"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D3_9" d="M2034.435,236L2043.337,240.167C2052.238,244.333,2070.041,252.667,2078.942,258.917C2087.844,265.167,2087.844,269.333,2087.844,272.833C2087.844,276.333,2087.844,279.167,2087.844,280.583L2087.844,282"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="LRU采样过程" class="cluster"><rect height="124" width="1199.5" y="8" x="8" style=""></rect><g transform="translate(561.765625, 8)" class="cluster-label"><foreignObject height="24" width="91.96875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>LRU采样过程</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_F_10" d="M220.625,70L226.875,70C233.125,70,245.625,70,255,70C264.375,70,270.625,70,276.208,70C281.792,70,286.708,70,289.167,70L291.625,70"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_F_G_11" d="M451.781,70L458.031,70C464.281,70,476.781,70,486.156,70C495.531,70,501.781,70,507.365,70C512.948,70,517.865,70,520.323,70L522.781,70"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_G_H_12" d="M691.672,70L697.922,70C704.172,70,716.672,70,726.047,70C735.422,70,741.672,70,747.255,70C752.839,70,757.755,70,760.214,70L762.672,70"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_H_I_13" d="M906.797,70L913.047,70C919.297,70,931.797,70,941.172,70C950.547,70,956.797,70,962.38,70C967.964,70,972.88,70,975.339,70L977.797,70"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(133.0625, 70)" id="flowchart-E-9794" class="node default"><rect height="54" width="175.125" y="-27" x="-87.5625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-57.5625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="115.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>随机采样N个key</p></span></div></foreignObject></g></g><g transform="translate(373.703125, 70)" id="flowchart-F-9795" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>比较访问时间</p></span></div></foreignObject></g></g><g transform="translate(609.2265625, 70)" id="flowchart-G-9797" class="node default"><rect height="54" width="164.890625" y="-27" x="-82.4453125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-52.4453125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="104.890625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>选择最旧的key</p></span></div></foreignObject></g></g><g transform="translate(836.734375, 70)" id="flowchart-H-9799" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>加入候选池</p></span></div></foreignObject></g></g><g transform="translate(1075.8984375, 70)" id="flowchart-I-9801" class="node default"><rect height="54" width="188.203125" y="-27" x="-94.1015625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-64.1015625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>从候选池选择淘汰</p></span></div></foreignObject></g></g></g></g><g transform="translate(1356.296875, 70)" id="flowchart-A-9774" class="node default"><rect height="54" width="197.59375" y="-27" x="-98.796875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-68.796875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="137.59375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Redis LRU/LFU优化</p></span></div></foreignObject></g></g><g transform="translate(753.65625, 209)" id="flowchart-B-9775" class="node default"><rect height="54" width="151.96875" y="-27" x="-75.984375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-45.984375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="91.96875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>传统LRU问题</p></span></div></foreignObject></g></g><g transform="translate(1319.65625, 209)" id="flowchart-C-9777" class="node default"><rect height="54" width="157.375" y="-27" x="-78.6875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.6875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="97.375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Redis近似LRU</p></span></div></foreignObject></g></g><g transform="translate(1976.75390625, 209)" id="flowchart-D-9779" class="node default"><rect height="54" width="129.265625" y="-27" x="-64.6328125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-34.6328125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="69.265625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Redis LFU</p></span></div></foreignObject></g></g><g transform="translate(753.65625, 325)" id="flowchart-B1-9781" class="node default"><rect height="78" width="220.25" y="-39" x="-110.125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-80.125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="160.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>双向链表开销大<br>每次访问都要移动节点</p></span></div></foreignObject></g></g><g transform="translate(991.859375, 325)" id="flowchart-C1-9783" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>24位时间戳<br>节省内存空间</p></span></div></foreignObject></g></g><g transform="translate(1210.390625, 325)" id="flowchart-C2-9785" class="node default"><rect height="78" width="180.90625" y="-39" x="-90.453125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-60.453125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="120.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>采样算法<br>随机选择候选key</p></span></div></foreignObject></g></g><g transform="translate(1428.921875, 325)" id="flowchart-C3-9787" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>候选池优化<br>提高淘汰精度</p></span></div></foreignObject></g></g><g transform="translate(1639.28125, 325)" id="flowchart-D1-9789" class="node default"><rect height="78" width="164.5625" y="-39" x="-82.28125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-52.28125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="104.5625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>8位频率计数器<br>记录访问频率</p></span></div></foreignObject></g></g><g transform="translate(1865.6640625, 325)" id="flowchart-D2-9791" class="node default"><rect height="78" width="188.203125" y="-39" x="-94.1015625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-64.1015625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>时间衰减机制<br>避免频率无限增长</p></span></div></foreignObject></g></g><g transform="translate(2087.84375, 325)" id="flowchart-D3-9793" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>概率增长<br>平衡新旧数据</p></span></div></foreignObject></g></g></g></g></g></svg></section></section></section><section class="chapter"><h2 id="q3-redis-key" data-toc="q3-redis-key">Q3: Redis的过期策略是什么？如何避免大量key同时过期？</h2><p id="z4faq71_127"><span class="control" id="z4faq71_131">A3:</span></p><section class="chapter"><h3 id="redis" data-toc="redis">Redis过期策略</h3><p id="z4faq71_132">Redis采用<span class="control" id="z4faq71_135">惰性删除 + 定期删除</span>的组合策略：</p><section class="chapter"><h4 id="1-lazy-expiration" data-toc="1-lazy-expiration">1. 惰性删除（Lazy Expiration）</h4><ul class="list _bullet" id="z4faq71_136"><li class="list__item" id="z4faq71_137"><p id="z4faq71_140"><span class="control" id="z4faq71_141">触发时机</span>: 访问key时检查是否过期</p></li><li class="list__item" id="z4faq71_138"><p id="z4faq71_142"><span class="control" id="z4faq71_143">优点</span>: 对CPU友好，只在需要时检查</p></li><li class="list__item" id="z4faq71_139"><p id="z4faq71_144"><span class="control" id="z4faq71_145">缺点</span>: 过期key可能长时间占用内存</p></li></ul></section><section class="chapter"><h4 id="2-active-expiration" data-toc="2-active-expiration">2. 定期删除（Active Expiration）</h4><ul class="list _bullet" id="z4faq71_146"><li class="list__item" id="z4faq71_147"><p id="z4faq71_150"><span class="control" id="z4faq71_151">触发时机</span>: 定时任务周期性检查</p></li><li class="list__item" id="z4faq71_148"><p id="z4faq71_152"><span class="control" id="z4faq71_153">检查频率</span>: 每秒10次（100ms一次）</p></li><li class="list__item" id="z4faq71_149"><p id="z4faq71_154"><span class="control" id="z4faq71_156">检查策略</span>:</p><ul class="list _bullet" id="z4faq71_155"><li class="list__item" id="z4faq71_157"><p id="z4faq71_160">随机选择20个设置了过期时间的key</p></li><li class="list__item" id="z4faq71_158"><p id="z4faq71_161">删除其中已过期的key</p></li><li class="list__item" id="z4faq71_159"><p id="z4faq71_162">如果过期key比例超过25%，重复上述过程</p></li></ul></li></ul></section></section><section class="chapter"><h3 id="z4faq71_129" data-toc="z4faq71_129">过期删除流程：</h3><svg aria-roledescription="sequence" role="graphics-document document" viewBox="-50 -10 650 1268" style="max-width: 650px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><g><rect class="actor actor-bottom" ry="3" rx="3" name="Timer" height="65" width="150" stroke="#666" fill="#eaeaea" y="1182" x="400"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="1214.5" x="475"><tspan dy="0" x="475">定时器</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Redis" height="65" width="150" stroke="#666" fill="#eaeaea" y="1182" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="1214.5" x="275"><tspan dy="0" x="275">Redis服务器</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="1182" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="1214.5" x="75"><tspan dy="0" x="75">客户端</tspan></text></g><g><line name="Timer" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="1182" x2="475" y1="5" x1="475" id="actor308"></line><g id="root-308"><rect class="actor actor-top" ry="3" rx="3" name="Timer" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="400"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="475"><tspan dy="0" x="475">定时器</tspan></text></g></g><g><line name="Redis" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="1182" x2="275" y1="5" x1="275" id="actor307"></line><g id="root-307"><rect class="actor actor-top" ry="3" rx="3" name="Redis" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">Redis服务器</tspan></text></g></g><g><line name="Client" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="1182" x2="75" y1="5" x1="75" id="actor306"></line><g id="root-306"><rect class="actor actor-top" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">客户端</tspan></text></g></g><g></g><defs><symbol height="24" width="24" id="computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="7.9" id="arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refY="4.5" refX="4" orient="auto" markerHeight="8" markerWidth="15" id="crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="15.5" id="filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="40" markerWidth="60" refY="15" refX="15" id="sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="150" stroke="#666" fill="#EDF2AE" y="75" x="200"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="275"><tspan x="275">惰性删除</tspan></text></g><g><line class="loopLine" y2="250" x2="361" y1="250" x1="64"></line><line class="loopLine" y2="514" x2="361" y1="250" x1="361"></line><line class="loopLine" y2="514" x2="361" y1="514" x1="64"></line><line class="loopLine" y2="514" x2="64" y1="250" x1="64"></line><line style="stroke-dasharray: 3, 3;" class="loopLine" y2="426" x2="361" y1="426" x1="64"></line><polygon class="labelBox" points="64,250 114,250 114,263 105.6,270 64,270"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="263" x="89">alt</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="268" x="237.5"><tspan x="237.5">[key已过期]</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="444" x="212.5">[key未过期]</text></g><g><rect class="note" height="39" width="150" stroke="#666" fill="#EDF2AE" y="524" x="200"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="529" x="275"><tspan x="275">定期删除</tspan></text></g><g><line class="loopLine" y2="840" x2="361" y1="840" x1="191"></line><line class="loopLine" y2="1152" x2="361" y1="840" x1="361"></line><line class="loopLine" y2="1152" x2="361" y1="1152" x1="191"></line><line class="loopLine" y2="1152" x2="191" y1="840" x1="191"></line><line style="stroke-dasharray: 3, 3;" class="loopLine" y2="986" x2="361" y1="986" x1="191"></line><polygon class="labelBox" points="191,840 241,840 241,853 232.6,860 191,860"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="853" x="216">alt</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="858" x="301"><tspan x="301">[过期比例&gt;2-</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="877" x="301"><tspan x="301">5%]</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="1004" x="276">[过期比例&lt;=-</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="1023" x="276">25%]</text></g><g><line class="loopLine" y2="621" x2="371" y1="621" x1="181"></line><line class="loopLine" y2="1162" x2="371" y1="621" x1="371"></line><line class="loopLine" y2="1162" x2="371" y1="1162" x1="181"></line><line class="loopLine" y2="1162" x2="181" y1="621" x1="181"></line><polygon class="labelBox" points="181,621 231,621 231,634 222.6,641 181,641"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="634" x="206">loop</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="639" x="301"><tspan x="301">[每100ms执行一-</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="658" x="301"><tspan x="301">次]</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="129" x="174">GET key</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="162" x2="271" y1="162" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="177" x="276">检查key是否过期</text><path style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,210 C 336,200 336,240 276,230"></path><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="300" x="276">删除key</text><path style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,333 C 336,323 336,363 276,353"></path><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="378" x="177">返回nil</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="411" x2="79" y1="411" x1="274"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="471" x="177">返回value</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="504" x2="79" y1="504" x1="274"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="578" x="377">触发定期检查</text><line style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="611" x2="279" y1="611" x1="474"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="689" x="276">随机选择20个过期key</text><path style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,722 C 336,712 336,752 276,742"></path><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="767" x="276">删除已过期的key</text><path style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,800 C 336,790 336,830 276,820"></path><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="908" x="276">继续下一轮检查</text><path style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,941 C 336,931 336,971 276,961"></path><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="1049" x="276">结束本轮检查</text><path style="fill: none;" marker-end="url(#arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,1082 C 336,1072 336,1112 276,1102"></path></svg></section><section class="chapter"><h3 id="key" data-toc="key">避免大量key同时过期的策略：</h3><section class="chapter"><h4 id="1" data-toc="1">1. 过期时间随机化</h4><div class="code-block" data-lang="python">
# 错误做法：所有key同一时间过期
EXPIRE key1 3600
EXPIRE key2 3600
EXPIRE key3 3600

# 正确做法：添加随机偏移
import random
expire_time = 3600 + random.randint(0, 300)  # 3600-3900秒
EXPIRE key1 expire_time
</div></section><section class="chapter"><h4 id="2" data-toc="2">2. 分批设置过期时间</h4><div class="code-block" data-lang="python">
# 将大批量key分散到不同时间过期
base_time = 3600
for i, key in enumerate(keys):
    offset = (i % 100) * 10  # 每100个key间隔10秒
    EXPIRE key (base_time + offset)
</div></section><section class="chapter"><h4 id="3-ttl" data-toc="3-ttl">3. 使用TTL监控</h4><div class="code-block" data-lang="bash">
# 监控即将过期的key数量
redis-cli --scan --pattern &quot;*&quot; | xargs -I {} redis-cli TTL {} | sort -n
</div></section></section></section><section class="chapter"><h2 id="q4-redis" data-toc="q4-redis">Q4: 如何监控和优化Redis内存使用？有哪些内存优化技巧？</h2><p id="z4faq71_170"><span class="control" id="z4faq71_174">A4:</span></p><section class="chapter"><h3 id="z4faq71_171" data-toc="z4faq71_171">内存监控指标</h3><section class="chapter"><h4 id="1" data-toc="1">1. 基本内存信息</h4><div class="code-block" data-lang="bash">
# 查看内存使用情况
redis-cli INFO memory

# 关键指标
used_memory: 已使用内存
used_memory_human: 人类可读格式
used_memory_rss: 操作系统分配的物理内存
used_memory_peak: 历史最大内存使用量
maxmemory: 最大内存限制
</div></section><section class="chapter"><h4 id="2" data-toc="2">2. 内存碎片率</h4><div class="code-block" data-lang="bash">
# 内存碎片率 = used_memory_rss / used_memory
# 正常范围：1.0 - 1.5
# 大于1.5：存在内存碎片
# 小于1.0：可能使用了swap
</div></section></section><section class="chapter"><h3 id="z4faq71_172" data-toc="z4faq71_172">内存优化技巧</h3><section class="chapter"><h4 id="1" data-toc="1">1. 选择合适的数据结构</h4><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1885.1875 302"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1885.1875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M819.617,41.985L718.546,49.488C617.475,56.99,415.333,71.995,314.262,81.581C213.191,91.167,213.191,95.333,213.191,98.833C213.191,102.333,213.191,105.167,213.191,106.583L213.191,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_C_1" d="M819.617,57.418L798.922,62.348C778.227,67.279,736.836,77.139,716.141,84.153C695.445,91.167,695.445,95.333,695.445,98.833C695.445,102.333,695.445,105.167,695.445,106.583L695.445,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_D_2" d="M1007.82,55.59L1031.745,60.825C1055.671,66.06,1103.521,76.53,1127.446,83.848C1151.371,91.167,1151.371,95.333,1151.371,98.833C1151.371,102.333,1151.371,105.167,1151.371,106.583L1151.371,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_E_3" d="M1007.82,41.813L1111.833,49.345C1215.846,56.876,1423.872,71.938,1527.885,81.552C1631.898,91.167,1631.898,95.333,1631.898,98.833C1631.898,102.333,1631.898,105.167,1631.898,106.583L1631.898,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_4" d="M155.51,166L146.609,170.167C137.707,174.333,119.904,182.667,111.003,188.917C102.102,195.167,102.102,199.333,102.102,202.833C102.102,206.333,102.102,209.167,102.102,210.583L102.102,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B2_5" d="M270.873,166L279.774,170.167C288.676,174.333,306.478,182.667,315.38,188.917C324.281,195.167,324.281,199.333,324.281,202.833C324.281,206.333,324.281,209.167,324.281,210.583L324.281,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_6" d="M632.32,164.957L621.764,169.297C611.208,173.638,590.096,182.319,579.54,188.743C568.984,195.167,568.984,199.333,568.984,202.833C568.984,206.333,568.984,209.167,568.984,210.583L568.984,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C2_7" d="M758.57,164.957L769.126,169.297C779.682,173.638,800.794,182.319,811.35,188.743C821.906,195.167,821.906,199.333,821.906,202.833C821.906,206.333,821.906,209.167,821.906,210.583L821.906,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_8" d="M1095.771,166L1087.191,170.167C1078.61,174.333,1061.45,182.667,1052.869,188.917C1044.289,195.167,1044.289,199.333,1044.289,202.833C1044.289,206.333,1044.289,209.167,1044.289,210.583L1044.289,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D2_9" d="M1206.971,166L1215.552,170.167C1224.132,174.333,1241.293,182.667,1249.873,188.917C1258.453,195.167,1258.453,199.333,1258.453,202.833C1258.453,206.333,1258.453,209.167,1258.453,210.583L1258.453,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_E1_10" d="M1574.453,161.1L1561.5,166.084C1548.547,171.067,1522.641,181.033,1509.688,188.1C1496.734,195.167,1496.734,199.333,1496.734,202.833C1496.734,206.333,1496.734,209.167,1496.734,210.583L1496.734,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_E2_11" d="M1689.344,161.1L1702.297,166.084C1715.25,171.067,1741.156,181.033,1754.109,189.1C1767.063,197.167,1767.063,203.333,1767.063,208.833C1767.063,214.333,1767.063,219.167,1767.063,221.583L1767.063,224"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(913.71875, 35)" id="flowchart-A-10068" class="node default"><rect height="54" width="188.203125" y="-27" x="-94.1015625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-64.1015625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>数据结构选择优化</p></span></div></foreignObject></g></g><g transform="translate(213.19140625, 139)" id="flowchart-B-10069" class="node default"><rect height="54" width="133.796875" y="-27" x="-66.8984375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-36.8984375, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="73.796875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>String优化</p></span></div></foreignObject></g></g><g transform="translate(695.4453125, 139)" id="flowchart-C-10071" class="node default"><rect height="54" width="126.25" y="-27" x="-63.125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-33.125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="66.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Hash优化</p></span></div></foreignObject></g></g><g transform="translate(1151.37109375, 139)" id="flowchart-D-10073" class="node default"><rect height="54" width="117.640625" y="-27" x="-58.8203125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-28.8203125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="57.640625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>List优化</p></span></div></foreignObject></g></g><g transform="translate(1631.8984375, 139)" id="flowchart-E-10075" class="node default"><rect height="54" width="114.890625" y="-27" x="-57.4453125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-27.4453125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="54.890625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Set优化</p></span></div></foreignObject></g></g><g transform="translate(102.1015625, 255)" id="flowchart-B1-10077" class="node default"><rect height="78" width="188.203125" y="-39" x="-94.1015625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-64.1015625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>使用整数存储数字<br>避免字符串转换</p></span></div></foreignObject></g></g><g transform="translate(324.28125, 255)" id="flowchart-B2-10079" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>压缩长字符串<br>考虑外部存储</p></span></div></foreignObject></g></g><g transform="translate(568.984375, 255)" id="flowchart-C1-10081" class="node default"><rect height="78" width="233.25" y="-39" x="-116.625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-86.625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="173.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>小对象使用ziplist<br>hash-max-ziplist-entries</p></span></div></foreignObject></g></g><g transform="translate(821.90625, 255)" id="flowchart-C2-10083" class="node default"><rect height="78" width="172.59375" y="-39" x="-86.296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.296875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="112.59375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>避免过大的hash<br>考虑拆分</p></span></div></foreignObject></g></g><g transform="translate(1044.2890625, 255)" id="flowchart-D1-10085" class="node default"><rect height="78" width="172.171875" y="-39" x="-86.0859375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.0859375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="112.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>使用quicklist<br>平衡内存和性能</p></span></div></foreignObject></g></g><g transform="translate(1258.453125, 255)" id="flowchart-D2-10087" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>避免过长列表<br>考虑分页</p></span></div></foreignObject></g></g><g transform="translate(1496.734375, 255)" id="flowchart-E1-10089" class="node default"><rect height="78" width="220.40625" y="-39" x="-110.203125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-80.203125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="160.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>小集合使用intset<br>set-max-intset-entries</p></span></div></foreignObject></g></g><g transform="translate(1767.0625, 255)" id="flowchart-E2-10091" class="node default"><rect height="54" width="220.25" y="-27" x="-110.125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-80.125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="160.25"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>大集合考虑布隆过滤器</p></span></div></foreignObject></g></g></g></g></g></svg></section><section class="chapter"><h4 id="2" data-toc="2">2. 配置优化参数</h4><div class="code-block" data-lang="bash">
# Hash类型优化
hash-max-ziplist-entries 512    # ziplist最大元素数
hash-max-ziplist-value 64       # ziplist最大值长度

# List类型优化  
list-max-ziplist-size -2        # quicklist节点大小
list-compress-depth 0           # 压缩深度

# Set类型优化
set-max-intset-entries 512      # intset最大元素数

# Sorted Set优化
zset-max-ziplist-entries 128    # ziplist最大元素数
zset-max-ziplist-value 64       # ziplist最大值长度
</div></section><section class="chapter"><h4 id="3-key" data-toc="3-key">3. Key设计优化</h4><div class="code-block" data-lang="python">
# 1. 使用短key名
# 错误：user:profile:12345:basic:info
# 正确：u:p:12345:b:i

# 2. 避免大key
# 错误：一个hash存储所有用户信息
# 正确：按用户ID分片存储

# 3. 设置合理的过期时间
# 避免永不过期的临时数据
EXPIRE session:12345 1800  # 30分钟过期
</div></section><section class="chapter"><h4 id="4" data-toc="4">4. 内存回收优化</h4><div class="code-block" data-lang="bash">
# 1. 启用内存碎片整理（Redis 4.0+）
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10

# 2. 配置合理的淘汰策略
maxmemory 2gb
maxmemory-policy allkeys-lru

# 3. 定期清理过期key
# 可以通过定时任务主动删除过期key
</div></section></section><section class="chapter"><h3 id="z4faq71_173" data-toc="z4faq71_173">内存分析工具</h3><section class="chapter"><h4 id="1-redis-cli-bigkeys" data-toc="1-redis-cli-bigkeys">1. redis-cli --bigkeys</h4><div class="code-block" data-lang="bash">
# 分析大key
redis-cli --bigkeys

# 输出示例
[00.00%] Biggest string found so far 'key1' with 1024 bytes
[00.00%] Biggest hash found so far 'key2' with 512 fields
</div></section><section class="chapter"><h4 id="2-memory-usage-redis-4-0" data-toc="2-memory-usage-redis-4-0">2. MEMORY USAGE命令（Redis 4.0+）</h4><div class="code-block" data-lang="bash">
# 查看特定key的内存使用
MEMORY USAGE mykey

# 查看采样的内存使用
MEMORY USAGE mykey SAMPLES 5
</div></section><section class="chapter"><h4 id="3" data-toc="3">3. 第三方工具</h4><ul class="list _bullet" id="z4faq71_192"><li class="list__item" id="z4faq71_194"><p id="z4faq71_197"><span class="control" id="z4faq71_198">redis-rdb-tools</span>: 分析RDB文件</p></li><li class="list__item" id="z4faq71_195"><p id="z4faq71_199"><span class="control" id="z4faq71_200">redis-memory-analyzer</span>: 内存使用分析</p></li><li class="list__item" id="z4faq71_196"><p id="z4faq71_201"><span class="control" id="z4faq71_202">RedisInsight</span>: 官方GUI工具</p></li></ul><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 2398.75 302"  class="flowchart" xmlns="http://www.w3.org/2000/svg" width="2398.75" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M1132.449,40.31L990.598,48.092C848.747,55.874,565.046,71.437,423.195,81.302C281.344,91.167,281.344,95.333,281.344,98.833C281.344,102.333,281.344,105.167,281.344,106.583L281.344,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_C_1" d="M1132.449,51.023L1096.222,57.019C1059.995,63.015,987.54,75.008,951.313,83.087C915.086,91.167,915.086,95.333,915.086,98.833C915.086,102.333,915.086,105.167,915.086,106.583L915.086,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_D_2" d="M1326.059,51.023L1362.286,57.019C1398.513,63.015,1470.967,75.008,1507.195,83.087C1543.422,91.167,1543.422,95.333,1543.422,98.833C1543.422,102.333,1543.422,105.167,1543.422,106.583L1543.422,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_E_3" d="M1326.059,40.536L1461.476,48.28C1596.893,56.024,1867.728,71.512,2003.145,81.339C2138.563,91.167,2138.563,95.333,2138.563,98.833C2138.563,102.333,2138.563,105.167,2138.563,106.583L2138.563,108"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_4" d="M219.289,155.558L197.151,161.465C175.013,167.372,130.737,179.186,108.599,187.176C86.461,195.167,86.461,199.333,86.461,202.833C86.461,206.333,86.461,209.167,86.461,210.583L86.461,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B2_5" d="M281.344,166L281.344,170.167C281.344,174.333,281.344,182.667,281.344,188.917C281.344,195.167,281.344,199.333,281.344,202.833C281.344,206.333,281.344,209.167,281.344,210.583L281.344,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B3_6" d="M343.398,154.973L366.725,160.978C390.052,166.982,436.706,178.991,460.033,187.079C483.359,195.167,483.359,199.333,483.359,202.833C483.359,206.333,483.359,209.167,483.359,210.583L483.359,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_7" d="M853.031,153.798L827.031,159.999C801.031,166.199,749.031,178.599,723.031,186.883C697.031,195.167,697.031,199.333,697.031,202.833C697.031,206.333,697.031,209.167,697.031,210.583L697.031,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C2_8" d="M915.086,166L915.086,170.167C915.086,174.333,915.086,182.667,915.086,188.917C915.086,195.167,915.086,199.333,915.086,202.833C915.086,206.333,915.086,209.167,915.086,210.583L915.086,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C3_9" d="M977.141,154L1002.652,160.167C1028.164,166.333,1079.188,178.667,1104.699,186.917C1130.211,195.167,1130.211,199.333,1130.211,202.833C1130.211,206.333,1130.211,209.167,1130.211,210.583L1130.211,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_10" d="M1465.344,158.513L1443.678,163.927C1422.013,169.342,1378.682,180.171,1357.017,187.669C1335.352,195.167,1335.352,199.333,1335.352,202.833C1335.352,206.333,1335.352,209.167,1335.352,210.583L1335.352,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D2_11" d="M1543.422,166L1543.422,170.167C1543.422,174.333,1543.422,182.667,1543.422,188.917C1543.422,195.167,1543.422,199.333,1543.422,202.833C1543.422,206.333,1543.422,209.167,1543.422,210.583L1543.422,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D3_12" d="M1621.5,159.491L1641.51,164.742C1661.521,169.994,1701.542,180.497,1721.552,187.832C1741.563,195.167,1741.563,199.333,1741.563,202.833C1741.563,206.333,1741.563,209.167,1741.563,210.583L1741.563,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_E1_13" d="M2076.508,154.934L2053.099,160.945C2029.69,166.956,1982.872,178.978,1959.464,187.072C1936.055,195.167,1936.055,199.333,1936.055,202.833C1936.055,206.333,1936.055,209.167,1936.055,210.583L1936.055,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_E2_14" d="M2138.563,166L2138.563,170.167C2138.563,174.333,2138.563,182.667,2138.563,188.917C2138.563,195.167,2138.563,199.333,2138.563,202.833C2138.563,206.333,2138.563,209.167,2138.563,210.583L2138.563,212"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_E3_15" d="M2200.617,155.972L2221.964,161.81C2243.31,167.648,2286.003,179.324,2307.349,187.245C2328.695,195.167,2328.695,199.333,2328.695,202.833C2328.695,206.333,2328.695,209.167,2328.695,210.583L2328.695,212"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(1229.25390625, 35)" id="flowchart-A-10217" class="node default"><rect height="54" width="193.609375" y="-27" x="-96.8046875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-66.8046875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="133.609375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Redis内存优化策略</p></span></div></foreignObject></g></g><g transform="translate(281.34375, 139)" id="flowchart-B-10218" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>监控分析</p></span></div></foreignObject></g></g><g transform="translate(915.0859375, 139)" id="flowchart-C-10220" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>配置优化</p></span></div></foreignObject></g></g><g transform="translate(1543.421875, 139)" id="flowchart-D-10222" class="node default"><rect height="54" width="156.15625" y="-27" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>数据结构优化</p></span></div></foreignObject></g></g><g transform="translate(2138.5625, 139)" id="flowchart-E-10224" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>业务优化</p></span></div></foreignObject></g></g><g transform="translate(86.4609375, 255)" id="flowchart-B1-10226" class="node default"><rect height="78" width="156.921875" y="-39" x="-78.4609375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.4609375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.921875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>INFO memory<br>监控内存指标</p></span></div></foreignObject></g></g><g transform="translate(281.34375, 255)" id="flowchart-B2-10228" class="node default"><rect height="78" width="132.84375" y="-39" x="-66.421875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-36.421875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="72.84375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>--bigkeys<br>分析大key</p></span></div></foreignObject></g></g><g transform="translate(483.359375, 255)" id="flowchart-B3-10230" class="node default"><rect height="78" width="171.1875" y="-39" x="-85.59375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-55.59375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="111.1875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>MEMORY USAGE<br>精确分析</p></span></div></foreignObject></g></g><g transform="translate(697.03125, 255)" id="flowchart-C1-10232" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>数据结构参数<br>ziplist阈值</p></span></div></foreignObject></g></g><g transform="translate(915.0859375, 255)" id="flowchart-C2-10234" class="node default"><rect height="78" width="179.953125" y="-39" x="-89.9765625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-59.9765625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="119.953125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>内存淘汰策略<br>maxmemory设置</p></span></div></foreignObject></g></g><g transform="translate(1130.2109375, 255)" id="flowchart-C3-10236" class="node default"><rect height="78" width="150.296875" y="-39" x="-75.1484375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-45.1484375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="90.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>碎片整理<br>activedefrag</p></span></div></foreignObject></g></g><g transform="translate(1335.3515625, 255)" id="flowchart-D1-10238" class="node default"><rect height="78" width="159.984375" y="-39" x="-79.9921875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-49.9921875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="99.984375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>选择合适类型<br>Hash vs String</p></span></div></foreignObject></g></g><g transform="translate(1543.421875, 255)" id="flowchart-D2-10240" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>控制数据大小<br>避免大key</p></span></div></foreignObject></g></g><g transform="translate(1741.5625, 255)" id="flowchart-D3-10242" class="node default"><rect height="78" width="140.125" y="-39" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>压缩存储<br>序列化优化</p></span></div></foreignObject></g></g><g transform="translate(1936.0546875, 255)" id="flowchart-E1-10244" class="node default"><rect height="78" width="148.859375" y="-39" x="-74.4296875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-44.4296875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="88.859375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>合理设计key<br>短名称</p></span></div></foreignObject></g></g><g transform="translate(2138.5625, 255)" id="flowchart-E2-10246" class="node default"><rect height="78" width="156.15625" y="-39" x="-78.078125" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-48.078125, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>设置过期时间<br>避免内存泄漏</p></span></div></foreignObject></g></g><g transform="translate(2328.6953125, 255)" id="flowchart-E3-10248" class="node default"><rect height="78" width="124.109375" y="-39" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分片存储<br>避免热点</p></span></div></foreignObject></g></g></g></g></g></svg></section></section></section><section class="chapter"><h2 id="q5-redis" data-toc="q5-redis">Q5: 什么是内存碎片？如何处理Redis的内存碎片问题？</h2><p id="z4faq71_203"><span class="control" id="z4faq71_208">A5:</span></p><section class="chapter"><h3 id="z4faq71_204" data-toc="z4faq71_204">内存碎片产生原因</h3><section class="chapter"><h4 id="1" data-toc="1">1. 内存分配器特性</h4><ul class="list _bullet" id="z4faq71_212"><li class="list__item" id="z4faq71_213"><p id="z4faq71_216">Redis使用jemalloc作为默认内存分配器</p></li><li class="list__item" id="z4faq71_214"><p id="z4faq71_217">分配器按固定大小的块分配内存</p></li><li class="list__item" id="z4faq71_215"><p id="z4faq71_218">实际使用内存可能小于分配的块大小</p></li></ul></section><section class="chapter"><h4 id="2" data-toc="2">2. 数据操作模式</h4><ul class="list _bullet" id="z4faq71_219"><li class="list__item" id="z4faq71_220"><p id="z4faq71_223">频繁的增删操作</p></li><li class="list__item" id="z4faq71_221"><p id="z4faq71_224">不同大小的数据混合存储</p></li><li class="list__item" id="z4faq71_222"><p id="z4faq71_225">内存释放后产生空洞</p></li></ul></section><section class="chapter"><h4 id="3" data-toc="3">3. 内存碎片的影响</h4><ul class="list _bullet" id="z4faq71_226"><li class="list__item" id="z4faq71_227"><p id="z4faq71_230">内存利用率降低</p></li><li class="list__item" id="z4faq71_228"><p id="z4faq71_231">可能导致内存不足</p></li><li class="list__item" id="z4faq71_229"><p id="z4faq71_232">影响系统性能</p></li></ul></section></section><section class="chapter"><h3 id="z4faq71_205" data-toc="z4faq71_205">内存碎片检测</h3><section class="chapter"><h4 id="1" data-toc="1">1. 碎片率计算</h4><div class="code-block" data-lang="bash">
# 内存碎片率 = used_memory_rss / used_memory
redis-cli INFO memory | grep -E &quot;(used_memory_rss|used_memory):&quot;

# 碎片率解读：
# 1.0 - 1.5：正常范围
# &gt; 1.5：存在较多碎片
# &lt; 1.0：可能使用了swap（异常）
</div></section><section class="chapter"><h4 id="2" data-toc="2">2. 监控脚本</h4><div class="code-block" data-lang="python">
import redis

def check_memory_fragmentation():
    r = redis.Redis()
    info = r.info('memory')
    
    used_memory = info['used_memory']
    used_memory_rss = info['used_memory_rss']
    
    fragmentation_ratio = used_memory_rss / used_memory
    
    print(f&quot;内存使用: {used_memory / 1024 / 1024:.2f} MB&quot;)
    print(f&quot;物理内存: {used_memory_rss / 1024 / 1024:.2f} MB&quot;)
    print(f&quot;碎片率: {fragmentation_ratio:.2f}&quot;)
    
    if fragmentation_ratio &gt; 1.5:
        print(&quot;警告：内存碎片率过高！&quot;)
    
    return fragmentation_ratio
</div></section></section><section class="chapter"><h3 id="z4faq71_206" data-toc="z4faq71_206">内存碎片处理方案</h3><section class="chapter"><h4 id="1-redis-4-0" data-toc="1-redis-4-0">1. 主动碎片整理（Redis 4.0+）</h4><div class="code-block" data-lang="bash">
# 启用自动碎片整理
activedefrag yes

# 碎片整理参数
active-defrag-ignore-bytes 100mb      # 忽略小于100MB的碎片
active-defrag-threshold-lower 10      # 碎片率超过10%开始整理
active-defrag-threshold-upper 100     # 碎片率超过100%强制整理
active-defrag-cycle-min 1             # 最小CPU使用率1%
active-defrag-cycle-max 25            # 最大CPU使用率25%
</div></section><section class="chapter"><h4 id="2" data-toc="2">2. 手动碎片整理</h4><div class="code-block" data-lang="bash">
# 手动触发碎片整理
MEMORY PURGE

# 查看碎片整理状态
INFO memory | grep defrag
</div></section><section class="chapter"><h4 id="3" data-toc="3">3. 重启整理（最彻底的方法）</h4><div class="code-block" data-lang="bash">
# 1. 生成RDB快照
BGSAVE

# 2. 重启Redis服务
# 3. 从RDB文件恢复数据
</div></section></section><section class="chapter"><h3 id="z4faq71_207" data-toc="z4faq71_207">预防内存碎片的最佳实践</h3><section class="chapter"><h4 id="1" data-toc="1">1. 数据设计优化</h4><div class="code-block" data-lang="python">
# 1. 避免频繁的大小变化
# 错误：频繁修改大字符串
SET large_key &quot;very long string...&quot;
APPEND large_key &quot;more data...&quot;

# 正确：使用固定大小或分片存储
HSET user:1001 name &quot;John&quot;
HSET user:1001 email &quot;john@example.com&quot;
</div></section><section class="chapter"><h4 id="2" data-toc="2">2. 操作模式优化</h4><div class="code-block" data-lang="python">
# 1. 批量操作减少碎片
# 错误：逐个设置
for i in range(1000):
    SET f&quot;key:{i}&quot; f&quot;value:{i}&quot;

# 正确：使用pipeline
pipe = redis.pipeline()
for i in range(1000):
    pipe.set(f&quot;key:{i}&quot;, f&quot;value:{i}&quot;)
pipe.execute()
</div></section><section class="chapter"><h4 id="3" data-toc="3">3. 内存分配器调优</h4><div class="code-block" data-lang="bash">
# 使用jemalloc（推荐）
export MALLOC_CONF=&quot;lg_dirty_mult:8,lg_muzzy_mult:8&quot;

# 或者使用tcmalloc
export LD_PRELOAD=&quot;/usr/lib/libtcmalloc.so&quot;
</div><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1931.921875 564.21875" height="564.21875" class="flowchart" xmlns="http://www.w3.org/2000/svg" width="1931.921875" id="mermaid"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_B_0" d="M953.469,193.109L878.885,219.128C804.301,245.146,655.133,297.182,580.549,325.284C505.965,353.385,505.965,357.552,505.965,361.052C505.965,364.552,505.965,367.385,505.965,368.802L505.965,370.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_C_1" d="M1046.07,193.109L1060.721,219.128C1075.371,245.146,1104.672,297.182,1119.322,325.284C1133.973,353.385,1133.973,357.552,1133.973,361.052C1133.973,364.552,1133.973,367.385,1133.973,368.802L1133.973,370.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_A_D_2" d="M1124.969,190.002L1229.481,216.538C1333.993,243.074,1543.018,296.147,1647.531,324.766C1752.043,353.385,1752.043,357.552,1752.043,361.052C1752.043,364.552,1752.043,367.385,1752.043,368.802L1752.043,370.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B1_3" d="M443.91,410.427L395.848,417.559C347.786,424.691,251.663,438.955,203.601,448.17C155.539,457.385,155.539,461.552,155.539,465.052C155.539,468.552,155.539,471.385,155.539,472.802L155.539,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B2_4" d="M458.802,428.219L451.524,432.385C444.246,436.552,429.689,444.885,422.411,451.135C415.133,457.385,415.133,461.552,415.133,465.052C415.133,468.552,415.133,471.385,415.133,472.802L415.133,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_B_B3_5" d="M553.128,428.219L560.406,432.385C567.684,436.552,582.24,444.885,589.519,451.135C596.797,457.385,596.797,461.552,596.797,465.052C596.797,468.552,596.797,471.385,596.797,472.802L596.797,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C1_6" d="M1071.918,411.044L1027.525,418.073C983.133,425.103,894.348,439.161,849.955,448.273C805.563,457.385,805.563,461.552,805.563,465.052C805.563,468.552,805.563,471.385,805.563,472.802L805.563,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C2_7" d="M1080.437,428.219L1072.175,432.385C1063.914,436.552,1047.39,444.885,1039.129,451.135C1030.867,457.385,1030.867,461.552,1030.867,465.052C1030.867,468.552,1030.867,471.385,1030.867,472.802L1030.867,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_C_C3_8" d="M1187.508,428.219L1195.77,432.385C1204.032,436.552,1220.555,444.885,1228.816,451.135C1237.078,457.385,1237.078,461.552,1237.078,465.052C1237.078,468.552,1237.078,471.385,1237.078,472.802L1237.078,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D1_9" d="M1689.988,411.946L1650.197,418.825C1610.406,425.704,1530.824,439.461,1491.033,448.423C1451.242,457.385,1451.242,461.552,1451.242,465.052C1451.242,468.552,1451.242,471.385,1451.242,472.802L1451.242,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D2_10" d="M1702.901,428.219L1695.317,432.385C1687.733,436.552,1672.566,444.885,1664.982,451.135C1657.398,457.385,1657.398,461.552,1657.398,465.052C1657.398,468.552,1657.398,471.385,1657.398,472.802L1657.398,474.219"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_D_D3_11" d="M1801.185,428.219L1808.769,432.385C1816.353,436.552,1831.52,444.885,1839.104,451.135C1846.688,457.385,1846.688,461.552,1846.688,465.052C1846.688,468.552,1846.688,471.385,1846.688,472.802L1846.688,474.219"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(25.953125, 0)" class="root"><g class="clusters"><g data-look="classic" id="碎片整理流程" class="cluster"><rect height="316.21875" width="852.8125" y="8" x="8" style=""></rect><g transform="translate(386.328125, 8)" class="cluster-label"><foreignObject height="24" width="96.15625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>碎片整理流程</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_E_F_12" d="M168.744,173.219L177.807,168.617C186.871,164.016,204.998,154.813,217.228,150.253C229.458,145.693,235.792,145.776,241.458,145.851C247.125,145.925,252.125,145.991,254.625,146.024L257.125,146.057"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_F_G_13" d="M387.09,123.636L398.338,118.632C409.586,113.627,432.082,103.618,447.123,98.614C462.164,93.609,469.75,93.609,476.669,93.609C483.589,93.609,489.841,93.609,492.967,93.609L496.094,93.609"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_F_H_14" d="M387.09,168.582L398.338,173.42C409.586,178.258,432.082,187.934,447.123,192.772C462.164,197.609,469.75,197.609,476.669,197.609C483.589,197.609,489.841,197.609,492.967,197.609L496.094,197.609"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_G_I_15" d="M624.203,93.609L630.453,93.609C636.703,93.609,649.203,93.609,661.648,100.243C674.093,106.878,686.484,120.146,698.419,132.927C710.354,145.708,721.834,158.002,727.574,164.148L733.314,170.295"></path><path marker-end="url(#mermaid_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I_E_16" d="M728.873,227.219L717.678,236.552C706.483,245.885,684.093,264.552,656.306,273.885C628.518,283.219,595.333,283.219,560.813,283.219C526.292,283.219,490.435,283.219,452.551,283.219C414.667,283.219,374.755,283.219,336.18,283.219C297.604,283.219,260.365,283.219,235.697,278.552C211.03,273.885,198.934,264.552,187.367,255.626C175.799,246.7,164.759,238.181,159.239,233.922L153.72,229.662"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g transform="translate(454.578125, 93.609375)" class="edgeLabel"><g transform="translate(-8.015625, -12)" class="label"><foreignObject height="24" width="16.03125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>是</p></span></div></foreignObject></g></g><g transform="translate(454.578125, 197.609375)" class="edgeLabel"><g transform="translate(-8.015625, -12)" class="label"><foreignObject height="24" width="16.03125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>否</p></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(115.5625, 200.21875)" id="flowchart-E-10383" class="node default"><rect height="54" width="140.125" y="-27" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>检测碎片率</p></span></div></foreignObject></g></g><g transform="translate(334.84375, 145.609375)" id="flowchart-F-10384" class="node default"><polygon transform="translate(-74.21875,74.21875)" class="label-container" points="74.21875,0 148.4375,-74.21875 74.21875,-148.4375 0,-74.21875"></polygon><g transform="translate(-47.21875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="94.4375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>碎片率&gt;阈值?</p></span></div></foreignObject></g></g><g transform="translate(562.1484375, 93.609375)" id="flowchart-G-10386" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>启动整理</p></span></div></foreignObject></g></g><g transform="translate(562.1484375, 197.609375)" id="flowchart-H-10388" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>继续监控</p></span></div></foreignObject></g></g><g transform="translate(761.2578125, 200.21875)" id="flowchart-I-10390" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>整理完成</p></span></div></foreignObject></g></g></g></g><g transform="translate(1030.8671875, 166.109375)" id="flowchart-A-10359" class="node default"><rect height="54" width="188.203125" y="-27" x="-94.1015625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-64.1015625, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>内存碎片处理策略</p></span></div></foreignObject></g></g><g transform="translate(505.96484375, 401.21875)" id="flowchart-B-10360" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>检测监控</p></span></div></foreignObject></g></g><g transform="translate(1133.97265625, 401.21875)" id="flowchart-C-10362" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>主动整理</p></span></div></foreignObject></g></g><g transform="translate(1752.04296875, 401.21875)" id="flowchart-D-10364" class="node default"><rect height="54" width="124.109375" y="-27" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>预防措施</p></span></div></foreignObject></g></g><g transform="translate(155.5390625, 517.21875)" id="flowchart-B1-10366" class="node default"><rect height="78" width="295.078125" y="-39" x="-147.5390625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-117.5390625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="235.078125"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>计算碎片率<br>used_memory_rss/used_memory</p></span></div></foreignObject></g></g><g transform="translate(415.1328125, 517.21875)" id="flowchart-B2-10368" class="node default"><rect height="78" width="124.109375" y="-39" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>监控脚本<br>定期检查</p></span></div></foreignObject></g></g><g transform="translate(596.796875, 517.21875)" id="flowchart-B3-10370" class="node default"><rect height="78" width="139.21875" y="-39" x="-69.609375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-39.609375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="79.21875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>告警机制<br>碎片率&gt;1.5</p></span></div></foreignObject></g></g><g transform="translate(805.5625, 517.21875)" id="flowchart-C1-10372" class="node default"><rect height="78" width="178.3125" y="-39" x="-89.15625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-59.15625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="118.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>自动整理<br>activedefrag yes</p></span></div></foreignObject></g></g><g transform="translate(1030.8671875, 517.21875)" id="flowchart-C2-10374" class="node default"><rect height="78" width="172.296875" y="-39" x="-86.1484375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-56.1484375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="112.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>手动整理<br>MEMORY PURGE</p></span></div></foreignObject></g></g><g transform="translate(1237.078125, 517.21875)" id="flowchart-C3-10376" class="node default"><rect height="78" width="140.125" y="-39" x="-70.0625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-40.0625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="80.125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>重启整理<br>最彻底方案</p></span></div></foreignObject></g></g><g transform="translate(1451.2421875, 517.21875)" id="flowchart-D1-10378" class="node default"><rect height="78" width="188.203125" y="-39" x="-94.1015625" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-64.1015625, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="128.203125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>数据设计<br>避免大小频繁变化</p></span></div></foreignObject></g></g><g transform="translate(1657.3984375, 517.21875)" id="flowchart-D2-10380" class="node default"><rect height="78" width="124.109375" y="-39" x="-62.0546875" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-32.0546875, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="64.109375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>操作优化<br>批量操作</p></span></div></foreignObject></g></g><g transform="translate(1846.6875, 517.21875)" id="flowchart-D3-10382" class="node default"><rect height="78" width="154.46875" y="-39" x="-77.234375" data-et="node" data-id="abc" style="" class="basic label-container"></rect><g transform="translate(-47.234375, -24)" style="" class="label"><rect></rect><foreignObject height="48" width="94.46875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>分配器调优<br>jemalloc参数</p></span></div></foreignObject></g></g></g></g></g></svg><p id="z4faq71_251"><span class="control" id="z4faq71_252">第四阶段完成！</span> 已创建Redis内存管理的QA文档，涵盖了内存淘汰策略、过期策略、内存优化和碎片处理的详细内容。</p></section></section></section><div class="last-modified">28 五月 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="redis持久化qa.html" class="navigation-links__prev">Redis 持久化 QA</a><a href="redis事务与集群qa.html" class="navigation-links__next">Redis 事务与集群 QA</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>